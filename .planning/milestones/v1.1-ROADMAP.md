# Milestone v1.1: Language Polish

**Status:** SHIPPED 2026-02-08
**Phases:** 11-15
**Total Plans:** 10

## Overview

Fix all five documented v1.0 limitations -- multi-clause functions, string pattern matching, pipe operator with closures, actor-per-connection HTTP, and generic map types -- to make the language feel complete and polished.

## Phases

### Phase 11: Multi-Clause Functions

**Goal**: Users can define functions with multiple pattern-matched clauses instead of wrapping everything in case expressions
**Depends on**: v1.0 complete
**Requirements**: SYN-01, SYN-02, SYN-03
**Plans**: 3 plans

Plans:
- [x] 11-01-PLAN.md -- Parser + AST: = expr body form, pattern params, guard clauses
- [x] 11-02-PLAN.md -- Type checker: clause grouping, desugaring, validation, guard relaxation
- [x] 11-03-PLAN.md -- MIR lowering, formatter, e2e tests

**Details:**
- Parser extended with `fn name(pattern) [when guard] = expr` syntax alongside existing `do/end` form
- Type checker groups consecutive same-name FnDef nodes, desugars to case-style inference with exhaustiveness checking
- MIR lowering: single-param uses Match, multi-param uses if-else chain (no MirExpr::Tuple)
- Guard variables bound via entry-block allocas before guard evaluation
- Formatter handles = expr body, when guards, pattern parameters

### Phase 12: Pipe Operator Closures

**Goal**: Users can pipe values into expressions containing inline closures without parser errors
**Depends on**: v1.0 complete
**Requirements**: SYN-04, SYN-05
**Plans**: 3 plans

Plans:
- [x] 12-01-PLAN.md -- Parser rewrite: bare params, do/end body, multi-clause, guards, error messages, snapshot tests
- [x] 12-02-PLAN.md -- Formatter, type checker/MIR multi-clause support, e2e tests
- [x] 12-03-PLAN.md -- Gap closure: pipe-aware call inference in type checker, pipe+closure e2e tests

**Details:**
- Complete parse_closure rewrite with bare params, do/end body, multi-clause via |, guard clauses
- CLOSURE_CLAUSE syntax kind for multi-clause closure children
- Pipe-aware type inference: infer_pipe handles CallExpr RHS by prepending lhs_ty before arity check
- Multi-clause closure MIR lowering mirrors named fn pattern (Match for single-param, if-else for multi-param)

### Phase 13: String Pattern Matching

**Goal**: Users can match on string literals in case expressions with compile-time generated code instead of runtime fallback
**Depends on**: v1.0 complete
**Requirements**: PAT-01, PAT-02
**Plans**: 1 plan

Plans:
- [x] 13-01-PLAN.md -- Fix codegen placeholders (pattern test + binary compare) and exhaustiveness string extraction, add e2e tests

**Details:**
- String literal patterns compiled via snow_string_eq (was always-false placeholder)
- Binary == and != for strings use snow_string_eq (was always-false/true placeholder)
- Exhaustiveness checker extracts STRING_CONTENT from LITERAL_PAT children
- DIAMOND (<>) operator correctly mapped to BinOp::Concat alongside ++

### Phase 14: Generic Map Types

**Goal**: Map type supports generic key/value types so users can build maps with string keys and any value type
**Depends on**: v1.0 complete
**Requirements**: MAP-01, MAP-02, MAP-03
**Plans**: 2 plans

Plans:
- [x] 14-01-PLAN.md -- Runtime key_type tag, polymorphic typeck signatures, MIR/codegen dispatch, string-key e2e test
- [x] 14-02-PLAN.md -- Map literal syntax: parser, AST, type inference, MIR desugaring, e2e tests

**Details:**
- Polymorphic Map<K,V> type signatures with Scheme type variables in stdlib
- Runtime key_type tag packed in upper 8 bits of capacity field for dispatch
- Lazy key-type tagging at Map.put (HM let-generalization prevents resolution at Map.new)
- Bidirectional ptr/int coercion in codegen for uniform value representation
- Map literal syntax %{key => value} with full pipeline support

### Phase 15: HTTP Actor Model

**Goal**: HTTP server uses lightweight actor processes per connection instead of OS threads, with crash isolation per connection
**Depends on**: v1.0 complete
**Requirements**: HTTP-01, HTTP-02
**Plans**: 1 plan

Plans:
- [x] 15-01-PLAN.md -- Actor-per-connection HTTP server with catch_unwind crash isolation, e2e tests

**Details:**
- Replaced std::thread::spawn with actor::global_scheduler().spawn() for HTTP connections
- connection_handler_entry with catch_unwind for per-connection crash isolation
- snow_panic changed from abort() to panic!() for catchable panics
- Idempotent scheduler init in snow_http_serve

---

## Milestone Summary

**Key Decisions:**
- Always use parse_fn_clause_param_list for all fn def param lists (transparent backward compat)
- Single = expr FnDef treated as 1-clause MultiClause group (consistent desugaring)
- Exhaustiveness non-exhaustive is warning for multi-clause functions (matches case behavior)
- Arrow body uses expr() wrapped in manual BLOCK for BAR detection in closures
- Pipe-aware inference in infer_pipe, not infer_call (handles CallExpr RHS directly)
- Lazy key_type tagging at Map.put instead of Map.new (HM let-generalization prevents type resolution at new)
- Bidirectional ptr/int coercion in codegen_call (general-purpose for uniform value representation)
- snow_panic changed from abort() to panic!() (catch_unwind crash isolation requires catchable panics)

**Issues Resolved:**
- String pattern matching was always-false placeholder in codegen
- String equality/inequality was always-false/always-true placeholder
- DIAMOND (<>) operator fell through to BinOp::Add in MIR lowering
- Pipe + multi-arg call arity check failed before pipe desugaring (fixed with pipe-aware inference)
- HM let-generalization prevented Map key type resolution at construction site (fixed with lazy tagging)
- Guard expressions couldn't access pattern-bound variables in codegen (fixed with entry-block allocas)
- snow_panic abort() prevented catch_unwind crash isolation (changed to panic!())

**Issues Deferred:**
- Fun() annotation parser limitation (Fun treated as type constructor, not function type)
- Arena/bump allocation GC (mark-sweep needed for long-running actors, separate milestone)

**Technical Debt Incurred:**
- None reported across all 5 phase verifications

---

_For current project status, see .planning/PROJECT.md_
