# Requirements: Snow v1.3 Traits & Protocols

**Defined:** 2026-02-07
**Core Value:** Expressive, readable concurrency -- writing concurrent programs should feel as natural as sequential code, with supervision and fault tolerance built in.

## v1.3 Requirements

### Trait Infrastructure (INFRA)

- [ ] **INFRA-01**: `type_to_key` replaced with structural type matching that handles generic impls (e.g., `impl Display for List<T>` matches query `List<Int>`)
- [ ] **INFRA-02**: Duplicate impl detection -- two `impl Display for Int` blocks produce a compiler error instead of silent overwrite
- [ ] **INFRA-03**: Method name collision between traits resolved deterministically (qualified dispatch or compiler error on ambiguity)
- [ ] **INFRA-04**: Compiler-known trait dispatch and user-defined trait dispatch unified into a single code path

### Trait Codegen (CODEGEN)

- [ ] **CODEGEN-01**: `impl` blocks lower to executable MIR functions with mangled names (`Trait__Method__Type`)
- [ ] **CODEGEN-02**: Trait method calls at call sites resolve to mangled function names via TraitRegistry lookup
- [ ] **CODEGEN-03**: `self` parameter handled as first argument with concrete type in impl method bodies
- [ ] **CODEGEN-04**: Where clause constraints enforced through codegen (call sites verify trait bounds before emitting calls)
- [ ] **CODEGEN-05**: Monomorphization depth limit prevents infinite trait method instantiation

### Display Protocol (DISP)

- [ ] **DISP-01**: `Display` interface defined with `to_string(self) -> String` method signature
- [ ] **DISP-02**: String interpolation (`"${value}"`) calls `Display.to_string` for the interpolated value's type
- [ ] **DISP-03**: Built-in `Display` impls for all primitive types (Int, Float, Bool, String)

### Debug Protocol (DBG)

- [ ] **DBG-01**: `Debug` interface defined with `inspect(self) -> String` method signature
- [ ] **DBG-02**: `inspect(value)` produces developer-oriented structural representation (e.g., `Point { x: 1, y: 2 }`)
- [ ] **DBG-03**: Built-in `Debug` impls for all primitive types (Int, Float, Bool, String)

### Equality Protocol (EQ)

- [ ] **EQ-01**: `Eq` extended to user-defined structs (structural field-by-field equality)
- [ ] **EQ-02**: `Eq` extended to sum types (variant tag + payload equality)
- [ ] **EQ-03**: Built-in `Eq` impls for all primitive types registered through TraitRegistry (not hardcoded dispatch)

### Ordering Protocol (ORD)

- [ ] **ORD-01**: `Ordering` sum type defined (`Less | Equal | Greater`) for comparison results
- [ ] **ORD-02**: `Ord` extended to user-defined structs (lexicographic field-by-field comparison)
- [ ] **ORD-03**: `Ord` extended to sum types (variant ordering + payload comparison)
- [ ] **ORD-04**: Built-in `Ord` impls for all primitive types registered through TraitRegistry

### Hash Protocol (HASH)

- [ ] **HASH-01**: `Hash` interface defined with `hash(self) -> Int` method signature
- [ ] **HASH-02**: FNV-1a hash implementation in snow-rt (no new Rust crate dependencies)
- [ ] **HASH-03**: Built-in `Hash` impls for all primitive types (Int, Float, Bool, String)
- [ ] **HASH-04**: User types with `Hash` impl can be used as `Map` keys

### Default Protocol (DFLT)

- [ ] **DFLT-01**: `Default` interface defined with `default() -> Self` method signature (static method, no self parameter)
- [ ] **DFLT-02**: Built-in `Default` impls for all primitive types (Int -> 0, Float -> 0.0, Bool -> false, String -> "")

### Default Methods (DMETH)

- [ ] **DMETH-01**: Interface definitions support default method implementations (method body in interface block)
- [ ] **DMETH-02**: Impl blocks can omit methods that have defaults; default body used when no override provided

### Auto-Derive -- Stretch (DERIV)

- [ ] **DERIV-01**: `deriving(Trait1, Trait2)` syntax on struct/sum type definitions
- [ ] **DERIV-02**: Compiler generates correct impl bodies from struct field metadata (field-by-field for Eq, lexicographic for Ord, concatenation for Display)
- [ ] **DERIV-03**: Compiler generates correct impl bodies for sum types (variant tag + payload)

### Collection Protocols -- Stretch (COLL)

- [ ] **COLL-01**: `Display` impl for List (e.g., `[1, 2, 3]`)
- [ ] **COLL-02**: `Display` impl for Map (e.g., `%{a => 1, b => 2}`)
- [ ] **COLL-03**: `Debug` impl for List, Map, Set

## Out of Scope

| Feature | Reason |
|---------|--------|
| Iterator/Iterable protocol | Requires associated types or trait type parameters; deferred to v1.4+ |
| From/Into conversion protocol | Requires blanket impl support (`From implies Into`); deferred to v1.4+ |
| Serialize/Deserialize protocols | Depends on Iterator and broader stdlib maturity; deferred to v1.4+ |
| Supertraits / trait inheritance | Adds significant complexity; not needed for v1.3 protocols |
| Method dot-syntax (`value.method()`) | Syntactic sugar, not capability; deferred to v1.4+ |
| Blanket impls | Implementation complexity too high for v1.3; deferred to v1.4+ |
| Dynamic dispatch / vtables / trait objects | Use sum types instead; never planned |
| Higher-kinded types (Functor/Monad) | Out of language philosophy |
| Specialization (overlapping impls) | Unsound without careful design; not planned |

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| INFRA-01 | Phase 18 | Pending |
| INFRA-02 | Phase 18 | Pending |
| INFRA-03 | Phase 18 | Pending |
| INFRA-04 | Phase 18 | Pending |
| CODEGEN-01 | Phase 19 | Pending |
| CODEGEN-02 | Phase 19 | Pending |
| CODEGEN-03 | Phase 19 | Pending |
| CODEGEN-04 | Phase 19 | Pending |
| CODEGEN-05 | Phase 19 | Pending |
| DISP-01 | Phase 20 | Pending |
| DISP-02 | Phase 20 | Pending |
| DISP-03 | Phase 20 | Pending |
| DBG-01 | Phase 20 | Pending |
| DBG-02 | Phase 20 | Pending |
| DBG-03 | Phase 20 | Pending |
| EQ-01 | Phase 20 | Pending |
| EQ-02 | Phase 20 | Pending |
| EQ-03 | Phase 20 | Pending |
| ORD-01 | Phase 20 | Pending |
| ORD-02 | Phase 20 | Pending |
| ORD-03 | Phase 20 | Pending |
| ORD-04 | Phase 20 | Pending |
| HASH-01 | Phase 21 | Pending |
| HASH-02 | Phase 21 | Pending |
| HASH-03 | Phase 21 | Pending |
| HASH-04 | Phase 21 | Pending |
| DFLT-01 | Phase 21 | Pending |
| DFLT-02 | Phase 21 | Pending |
| DMETH-01 | Phase 21 | Pending |
| DMETH-02 | Phase 21 | Pending |
| DERIV-01 | Phase 22 | Pending |
| DERIV-02 | Phase 22 | Pending |
| DERIV-03 | Phase 22 | Pending |
| COLL-01 | Phase 21 | Pending |
| COLL-02 | Phase 21 | Pending |
| COLL-03 | Phase 21 | Pending |

**Coverage:**
- v1.3 must-have requirements: 30 total
- v1.3 stretch requirements: 6 total (DERIV-01..03, COLL-01..03)
- Mapped to phases: 36
- Unmapped: 0

---
*Defined: 2026-02-07*
