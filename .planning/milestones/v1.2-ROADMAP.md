# Milestone v1.2: Runtime & Type Fixes

**Status:** ✅ SHIPPED 2026-02-08
**Phases:** 16-17
**Total Plans:** 6

## Overview

Fix the two remaining known issues -- Fun() type annotation parsing and mark-sweep GC for long-running actors.

## Phases

### Phase 16: Fun() Type Parsing

**Goal**: Users can annotate function types in Snow code and the compiler parses and type-checks them correctly
**Depends on**: Nothing (independent workstream)
**Requirements**: TYPE-01, TYPE-02, TYPE-03
**Plans**: 2 plans

Plans:

- [x] 16-01: Parser infrastructure -- FUN_TYPE CST node + parse_type() Fun() handling
- [x] 16-02: Type checker -- ARROW token collection, parse_type_tokens Fun() handling, e2e tests

**Details:**

- Added `FUN_TYPE` composite node kind to `SyntaxKind` enum
- Extended `parse_type()` to detect `Fun(` and parse full function type syntax: `Fun(ParamTypes) -> ReturnType`
- Handles zero-arity `Fun() -> T`, multi-param `Fun(Int, String) -> Bool`, and nested function types
- Type checker resolves `Fun(params) -> RetType` annotations into `Ty::Fun` with HM unification
- Codegen handles Fun-typed parameters as `MirType::Closure` (not FnPtr) for correct LLVM signatures
- Closure arguments passed as struct (not split) to user-defined functions; splitting only for runtime intrinsics
- Fun remains an IDENT, not a keyword -- special-cased by text comparison only in type position

### Phase 17: Mark-Sweep Garbage Collector

**Goal**: Long-running actors reclaim unused memory automatically without affecting other actors
**Depends on**: Nothing (independent workstream, can run in parallel with Phase 16)
**Requirements**: RT-01, RT-02, RT-03, RT-04
**Plans**: 4 plans

Plans:

- [x] 17-01: GcHeader struct + free-list allocator replacing bump allocator in ActorHeap
- [x] 17-02: Mark-sweep algorithm (conservative stack scanning, mark, sweep) + GC trigger
- [x] 17-03: Migrate runtime and codegen allocations to snow_gc_alloc_actor
- [x] 17-04: E2E test for bounded memory + full integration verification

**Details:**

- 16-byte GcHeader prepended to every per-actor allocation with size, mark/free flags, and intrusive next pointer
- Free-list allocator reuses freed blocks (first-fit) before bump-allocating new pages
- Conservative stack scanning treats every 8-byte-aligned word as potential pointer (no type maps yet)
- Worklist-based transitive marking (tricolor algorithm) on system heap to avoid re-entrancy
- Sweep rebuilds all-objects list in-place, frees unmarked objects to free list
- GC triggers cooperatively at yield points (reduction check == 0) when heap exceeds 256 KiB threshold
- All 13 runtime source files migrated from snow_gc_alloc to snow_gc_alloc_actor
- Codegen updated to emit snow_gc_alloc_actor for closure environments, actor spawn args, and tuple allocation
- E2E test: 50 messages × 200 iterations, 2+ MB allocations, bounded memory validated

---

## Milestone Summary

**Key Decisions:**

- Fun remains IDENT, not keyword -- type-position disambiguation only (Phase 16)
- FUN_TYPE placed after RESULT_TYPE in SyntaxKind enum (Phase 16)
- Fun-typed params as MirType::Closure for correct LLVM {ptr, ptr} signatures (Phase 16)
- No closure splitting for user functions -- only runtime intrinsics (Phase 16)
- GcHeader 16 bytes with dual-purpose next pointer (all-objects + free-list) (Phase 17)
- Global arena unchanged -- no headers, focus GC on actor heaps only (Phase 17)
- Conservative stack scanning -- no type info yet, safe but may retain some garbage (Phase 17)
- Worklist on system heap (Rust Vec) to avoid re-entrancy during GC (Phase 17)
- GC at yield points only -- cooperative, never interrupts other actors (Phase 17)
- Read stack_base from Process, not thread-local -- avoids stale pointer across coroutine switching (Phase 17)

**Issues Resolved:**

- Fun() type annotation treated as type constructor instead of function type
- Arena/bump allocation causing unbounded memory growth in long-running actors
- Stale STACK_BASE thread-local when coroutines share a worker thread (SIGBUS)
- Alignment incorrect for >16 byte alignments in GcHeader allocator

**Issues Deferred:**

None.

**Technical Debt Incurred:**

None -- both phases shipped clean with no deferred items.

---

_For current project status, see .planning/ROADMAP.md_
