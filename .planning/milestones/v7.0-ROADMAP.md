# Milestone v7.0: Iterator Protocol & Trait Ecosystem

**Status:** SHIPPED 2026-02-14
**Phases:** 74-80
**Total Plans:** 17

## Overview

Added associated types to the trait system, then built a comprehensive trait-based protocol ecosystem: lazy iterators with pipe-style composition, From/Into conversion, numeric traits for generic math, the Collect trait for iterator materialization, and complete website documentation for all new features.

## Phases

### Phase 74: Associated Types

**Goal**: Users can declare type members in traits and the compiler resolves them through inference
**Depends on**: Nothing (first phase of v7.0)
**Plans**: 3 plans

Plans:
- [x] 74-01-PLAN.md -- Parser and AST support for associated type syntax
- [x] 74-02-PLAN.md -- Type checker: TraitDef/ImplDef extension, validation, Self.Item resolution
- [x] 74-03-PLAN.md -- MIR integration, cross-module export, E2E and compile-fail tests

**Details:**
- ASSOC_TYPE_DEF and ASSOC_TYPE_BINDING SyntaxKind variants for CST
- Dedicated parse_impl_body for associated type binding parsing
- Self.Item resolution through IDENT text matching
- MIR lowering naturally handles associated types via ImplDef.methods() skipping ASSOC_TYPE_BINDING nodes
- Cross-module export via ExportedSymbols

### Phase 75: Numeric Traits

**Goal**: Users can implement arithmetic operators for custom types and write generic numeric code
**Depends on**: Phase 74 (associated types for `type Output`)
**Plans**: 2 plans

Plans:
- [x] 75-01-PLAN.md -- Add Output to arithmetic traits, register Neg, update type inference
- [x] 75-02-PLAN.md -- Fix MIR dispatch, add Neg codegen dispatch, E2E tests

**Details:**
- Output associated type added to Add/Sub/Mul/Div traits
- Neg trait registered for unary minus operator dispatch
- Primitives bypass trait check via fast path for backward compat
- Parser disambiguates self keyword: self() vs self.x

### Phase 76: Iterator Protocol

**Goal**: Users can iterate over any type that implements Iterable, including all built-in collections
**Depends on**: Phase 74 (associated types for `type Item` and `type Iter`)
**Plans**: 2 plans

Plans:
- [x] 76-01-PLAN.md -- Iterator/Iterable trait registration, runtime iterator handles, typeck Iterable resolution
- [x] 76-02-PLAN.md -- ForInIterator MIR/codegen pipeline, Iter.from(), E2E tests

**Details:**
- Two-trait protocol: Iterable for collections, Iterator for stateful cursor
- Opaque TyCon names (ListIterator, MapIterator, etc.) for iterator handle types
- ForInIterator MIR node for iterator-based for-in loops
- Iter.from() delegates to mesh_list_iter_new
- MeshOption struct layout: { tag: u8, value: *mut u8 } with tag 0=Some, 1=None

### Phase 77: From/Into Conversion

**Goal**: Users can define type conversions and the ? operator auto-converts error types
**Depends on**: Phase 74 (associated types used in trait definitions)
**Plans**: 3 plans

Plans:
- [x] 77-01-PLAN.md -- Parameterized trait registry, From/Into trait registration, built-in impls, type checking
- [x] 77-02-PLAN.md -- MIR/codegen From dispatch, ? operator error conversion, E2E tests
- [x] 77-03-PLAN.md -- Gap closure: Fix struct error types in Result for From-based ? conversion

**Details:**
- Parameterized trait support added to TraitRegistry
- Synthetic Into generation inserts directly into impls HashMap
- mangle_trait_method helper for parameterized trait mangling (From_Int__from__Float)
- ? operator error type conversion via From trait lookup
- Two-layer fix for struct error types: MIR normalization + codegen struct-to-ptr coercion

### Phase 78: Lazy Combinators & Terminals

**Goal**: Users can compose lazy iterator pipelines and consume them with terminal operations
**Depends on**: Phase 76 (Iterator trait and built-in iterators)
**Plans**: 3 plans

Plans:
- [x] 78-01-PLAN.md -- Runtime adapter infrastructure: type-tagged iterator handles, generic dispatch, combinator adapters, terminal operations
- [x] 78-02-PLAN.md -- Compiler wiring: type checker signatures, MIR lowerer mappings, intrinsic declarations, adapter type registration
- [x] 78-03-PLAN.md -- E2E tests for all combinators and terminals with multi-combinator pipeline verification

**Details:**
- Type-tag dispatch: tag u8 as first byte of all iterator handles for uniform generic_next
- Tag numbering: 0-3 for collection iterators, 10-15 for adapter iterators
- All combinator adapters are lazy (no intermediate allocation)
- iterator_ptr_compatible() in unify.rs for combinator chaining
- 6 combinators (map, filter, take, skip, enumerate, zip) + 6 terminals (count, sum, any, all, find, reduce)

### Phase 79: Collect

**Goal**: Users can materialize iterator pipelines into concrete collections
**Depends on**: Phase 78 (lazy combinators produce iterators to collect)
**Plans**: 2 plans

Plans:
- [x] 79-01-PLAN.md -- Runtime collect functions + compiler wiring for List, Map, Set, String
- [x] 79-02-PLAN.md -- E2E tests for all four collect functions

**Details:**
- Safe Rust Vec<u64> intermediary for mesh_list_collect (bounds checking)
- Map.collect defaults to integer keys via mesh_map_new()
- List.collect, Map.collect, Set.collect, String.collect all wired through compiler pipeline

### Phase 80: Documentation Update for v7.0 APIs

**Goal**: Update the website documentation to cover all v7.0 features
**Depends on**: Phase 79
**Plans**: 2 plans

Plans:
- [x] 80-01-PLAN.md -- Create Iterators documentation page + sidebar config
- [x] 80-02-PLAN.md -- Update Type System, Cheatsheet, and Language Basics pages

**Details:**
- New Iterators documentation page with comprehensive coverage
- Type System page updated with associated types, numeric traits, From/Into
- Cheatsheet updated with v7.0 syntax examples
- Language Basics updated with expanded traits coverage

---

## Milestone Summary

**Key Decisions:**
- Type-tag dispatch over function-pointer dispatch for iterator adapters (uniform generic_next)
- Two-trait Iterator/Iterable protocol (Iterable for collections, Iterator for stateful cursor)
- Synthetic Into generation (not blanket impls) to avoid coherence problems
- Parameterized trait registry for From<T>/Into<T> support
- MeshOption struct layout { tag: u8, value: *mut u8 } for iterator next() returns
- Opaque Ptr type for all iterator handle types in type checker

**Issues Resolved:**
- Struct error types in Result for From-based ? conversion (two-layer fix: MIR + codegen)
- Parser self keyword disambiguation (self() vs self.x)
- Parameterized trait duplicate detection via unification
- Iterator adapter chaining via iterator_ptr_compatible() unification

**Issues Deferred:**
- Bounded associated types (`type Iter: Iterator`) -- deferred to future milestone
- Multi-line pipe chain syntax -- parser limitation
- Map.collect with string keys -- defaults to integer keys
- Iter.find E2E test -- MeshOption lacks printing support

**Technical Debt Incurred:**
- TyVar from Ptr->List<T> remains unresolved for .to_string() on collected collections
- Single-line pipe chains only (parser limitation)
- Map.collect assumes integer keys

---

_For current project status, see .planning/ROADMAP.md_
