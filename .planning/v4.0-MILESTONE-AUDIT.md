---
milestone: v4.0
audited: 2026-02-13T02:30:00Z
status: passed
scores:
  requirements: 37/37
  phases: 4/4
  integration: 23/23
  flows: 8/8
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt: []
---

# v4.0 WebSocket Support — Milestone Audit Report

**Milestone Goal:** Add WebSocket support with actor-per-connection model, unified actor messaging, rooms/channels, ping/pong heartbeat, binary+text frames, and TLS (wss://).

**Audited:** 2026-02-13T02:30:00Z
**Status:** PASSED

## Scores

| Category | Score | Details |
|----------|-------|---------|
| Requirements | 37/37 (100%) | All PROTO, ACTOR, SERVE, LIFE, BEAT, FRAG, ROOM requirements satisfied |
| Phases | 4/4 (100%) | All phase verifications passed |
| Integration | 23/23 (100%) | All cross-phase exports consumed, zero orphaned |
| E2E Flows | 8/8 (100%) | All user-facing flows complete end-to-end |

## Phase Verification Summary

| Phase | Status | Score | Key Deliverables |
|-------|--------|-------|------------------|
| 59: Protocol Core | PASSED | 14/14 | RFC 6455 frame codec, HTTP upgrade handshake, close handshake, UTF-8 validation |
| 60: Actor Integration | PASSED | 12/12 | Actor-per-connection, reader thread bridge, lifecycle callbacks, Ws.serve |
| 61: Production Hardening | PASSED | 14/14 | WsStream TLS enum, heartbeat ping/pong, fragment reassembly, 16 MiB limit |
| 62: Rooms & Channels | PASSED | 10/10 | RoomRegistry, join/leave/broadcast/broadcast_except, disconnect cleanup |

**Total truths verified:** 50/50 (100%)

## Requirements Coverage

### Protocol Core (PROTO-01 through PROTO-09) — Phase 59

| Requirement | Status |
|-------------|--------|
| PROTO-01: HTTP upgrade handshake with Sec-WebSocket-Accept | SATISFIED |
| PROTO-02: Frame parsing (2-14 byte header, 3 length encodings) | SATISFIED |
| PROTO-03: Client-to-server frame unmasking (4-byte XOR) | SATISFIED |
| PROTO-04: Unmasked server-to-client frames | SATISFIED |
| PROTO-05: Text frames with UTF-8 validation | SATISFIED |
| PROTO-06: Binary frames with raw byte delivery | SATISFIED |
| PROTO-07: Close handshake with status codes | SATISFIED |
| PROTO-08: Malformed upgrade requests rejected with HTTP 400 | SATISFIED |
| PROTO-09: Unknown opcodes rejected with close code 1002 | SATISFIED |

### Actor Integration (ACTOR-01 through ACTOR-07) — Phase 60

| Requirement | Status |
|-------------|--------|
| ACTOR-01: Dedicated actor per connection with catch_unwind crash isolation | SATISFIED |
| ACTOR-02: WS frames delivered to mailbox with reserved type tags | SATISFIED |
| ACTOR-03: Ws.send(conn, message) for text frames | SATISFIED |
| ACTOR-04: Ws.send_binary(conn, data) for binary frames | SATISFIED |
| ACTOR-05: Actor crash sends close frame 1011 | SATISFIED |
| ACTOR-06: Client disconnect causes actor exit with signal propagation | SATISFIED |
| ACTOR-07: Reader thread bridge without blocking M:N scheduler | SATISFIED |

### Server Entry Points (SERVE-01 through SERVE-03) — Phases 60, 61

| Requirement | Status | Phase |
|-------------|--------|-------|
| SERVE-01: Ws.serve(handler, port) plaintext server | SATISFIED | 60 |
| SERVE-02: Ws.serve_tls(handler, port, cert_path, key_path) TLS server | SATISFIED | 61 |
| SERVE-03: Handler bundles on_connect, on_message, on_close | SATISFIED | 60 |

### Lifecycle Callbacks (LIFE-01 through LIFE-04) — Phase 60

| Requirement | Status |
|-------------|--------|
| LIFE-01: on_connect receives connection handle and request headers | SATISFIED |
| LIFE-02: on_connect can reject connections | SATISFIED |
| LIFE-03: on_message invoked on each text or binary frame | SATISFIED |
| LIFE-04: on_close invoked when connection ends | SATISFIED |

### Heartbeat (BEAT-01 through BEAT-05) — Phase 61

| Requirement | Status |
|-------------|--------|
| BEAT-01: Periodic Ping frames at 30s interval | SATISFIED |
| BEAT-02: Automatic Pong response to client Ping | SATISFIED |
| BEAT-03: Pong payload validation matches sent Ping | SATISFIED |
| BEAT-04: Connection closed after 10s missed Pong timeout | SATISFIED |
| BEAT-05: Ping/pong inline with read timeout cycle | SATISFIED |

### Fragmentation (FRAG-01 through FRAG-03) — Phase 61

| Requirement | Status |
|-------------|--------|
| FRAG-01: Continuation frame reassembly into complete messages | SATISFIED |
| FRAG-02: Interleaved control frames during reassembly handled | SATISFIED |
| FRAG-03: 16 MiB max message size with close code 1009 | SATISFIED |

### Rooms & Channels (ROOM-01 through ROOM-06) — Phase 62

| Requirement | Status |
|-------------|--------|
| ROOM-01: Ws.join(conn, room) subscribes to named room | SATISFIED |
| ROOM-02: Ws.leave(conn, room) unsubscribes from room | SATISFIED |
| ROOM-03: Ws.broadcast(room, message) sends to all in room | SATISFIED |
| ROOM-04: Ws.broadcast_except(room, message, conn) sends to all except one | SATISFIED |
| ROOM-05: Automatic room cleanup on disconnect | SATISFIED |
| ROOM-06: Concurrent access from multiple actors | SATISFIED |

## Cross-Phase Integration

### Phase Wiring (23 connections verified)

| From | To | Connection | Status |
|------|----|-----------:|--------|
| Phase 59 frame.rs | Phase 60 server.rs | read_frame in reader thread | WIRED |
| Phase 59 frame.rs | Phase 60 server.rs | write_frame in Ws.send/send_binary | WIRED |
| Phase 59 frame.rs | Phase 62 rooms.rs | write_frame in broadcast | WIRED |
| Phase 59 handshake.rs | Phase 60 server.rs | perform_upgrade in ws_connection_entry | WIRED |
| Phase 59 close.rs | Phase 60 server.rs | process_frame in reader thread | WIRED |
| Phase 59 close.rs | Phase 60 server.rs | send_close in error/cleanup paths | WIRED |
| Phase 59 close.rs | Phase 60 server.rs | validate_text_payload for reassembled fragments | WIRED |
| Phase 59 close.rs | Phase 60 server.rs | WsCloseCode constants in all close paths | WIRED |
| Phase 60 server.rs | Phase 61 server.rs | WsStream replaces TcpStream | WIRED |
| Phase 60 server.rs | Phase 61 server.rs | HeartbeatState in reader loop | WIRED |
| Phase 60 server.rs | Phase 61 server.rs | FragmentState + reassemble in reader loop | WIRED |
| Phase 60 server.rs | Phase 62 rooms.rs | WsConnection pub(crate) for broadcast | WIRED |
| Phase 62 rooms.rs | Phase 60 server.rs | cleanup_connection in disconnect path | WIRED |
| Phase 61 http/server.rs | Phase 61 ws/server.rs | build_server_config shared TLS config | WIRED |
| intrinsics.rs | server.rs | snow_ws_serve LLVM ↔ extern C | WIRED |
| intrinsics.rs | server.rs | snow_ws_send LLVM ↔ extern C | WIRED |
| intrinsics.rs | server.rs | snow_ws_send_binary LLVM ↔ extern C | WIRED |
| intrinsics.rs | server.rs | snow_ws_serve_tls LLVM ↔ extern C | WIRED |
| intrinsics.rs | rooms.rs | snow_ws_join LLVM ↔ extern C | WIRED |
| intrinsics.rs | rooms.rs | snow_ws_leave LLVM ↔ extern C | WIRED |
| intrinsics.rs | rooms.rs | snow_ws_broadcast LLVM ↔ extern C | WIRED |
| intrinsics.rs | rooms.rs | snow_ws_broadcast_except LLVM ↔ extern C | WIRED |
| lower.rs | intrinsics.rs | "Ws" STDLIB_MODULES + 8 known_functions + 8 map_builtin_name | WIRED |

**Orphaned exports:** 0
**Missing connections:** 0

## E2E Flow Verification

| # | Flow | Status | Key Path |
|---|------|--------|----------|
| 1 | WebSocket Connection | COMPLETE | TCP accept → upgrade → actor spawn → reader thread → on_connect → message loop |
| 2 | Message Echo | COMPLETE | Client text → reader → mailbox WS_TEXT_TAG → on_message → Ws.send → client |
| 3 | TLS Connection | COMPLETE | TCP accept → TLS handshake → WsStream::Tls → upgrade → actor spawn |
| 4 | Heartbeat | COMPLETE | 30s Ping → client Pong → payload match → reset timer (or 10s timeout → close) |
| 5 | Fragmentation | COMPLETE | Fragments → reassemble → complete message → mailbox delivery |
| 6 | Room Broadcast | COMPLETE | Ws.join → RoomRegistry → Ws.broadcast → write_frame to each member |
| 7 | Disconnect Cleanup | COMPLETE | I/O error → WS_DISCONNECT_TAG → cleanup_connection → shutdown → on_close → drop |
| 8 | Crash Isolation | COMPLETE | Panic → catch_unwind → close 1011 → cleanup rooms → on_close |

**Broken flows:** 0

## Anti-Patterns

None found across all 4 phases:
- No TODO/FIXME/PLACEHOLDER comments in v4.0 code
- No stub implementations (unimplemented!, todo!)
- No empty functions or console-only implementations
- All functions have substantive logic

## Tech Debt

None accumulated during v4.0 milestone.

Pre-existing tech debt (from prior milestones, unchanged):
- List.find Option pattern matching LLVM verification error (pre-existing codegen gap)
- Timer e2e tests flake under high parallelism
- Pre-existing TODO in lower.rs:5947 for string comparison callback
- 3 compiler warnings (fixable with `cargo fix`)
- Middleware requires explicit `:: Request` type annotations
- PostgreSQL E2E test requires external server (`#[ignore]`)

## Test Coverage

| Module | Tests | Status |
|--------|-------|--------|
| Phase 59: Frame codec | 9 | PASS |
| Phase 59: Handshake | 9 | PASS |
| Phase 59: Close/validation | 12 | PASS |
| Phase 60: Server integration | 5 | PASS |
| Phase 62: Room registry | 9 | PASS |
| Codegen intrinsics | 8 assertions | PASS |
| Full workspace | 1524 | PASS |

**Total WebSocket-specific tests:** 44
**Regressions:** 0

## Codegen Pipeline

8 Snow-level API functions fully wired through the compiler pipeline:

| Snow API | LLVM Intrinsic | Runtime Function | Args |
|----------|---------------|-----------------|------|
| Ws.serve | snow_ws_serve | server.rs:124 | 6 ptr + i64 → void |
| Ws.serve_tls | snow_ws_serve_tls | server.rs:392 | 6 ptr + i64 + 2 ptr → void |
| Ws.send | snow_ws_send | server.rs:477 | 2 ptr → i64 |
| Ws.send_binary | snow_ws_send_binary | server.rs:497 | 2 ptr + i64 → i64 |
| Ws.join | snow_ws_join | rooms.rs:150 | 2 ptr → i64 |
| Ws.leave | snow_ws_leave | rooms.rs:167 | 2 ptr → i64 |
| Ws.broadcast | snow_ws_broadcast | rooms.rs:185 | 2 ptr → i64 |
| Ws.broadcast_except | snow_ws_broadcast_except | rooms.rs:222 | 3 ptr → i64 |

## Key Decisions Made During v4.0

| Decision | Phase | Rationale |
|----------|-------|-----------|
| SHA-1 via ring (not sha1 crate) | 59 | RFC 6455 Sec-WebSocket-Accept computation |
| 64 MiB → 16 MiB payload cap | 59→61 | Production safety; generous initial, tightened for hardening |
| Reader thread bridge (OS thread per conn) | 60 | Avoids blocking M:N scheduler with network I/O |
| Reserved type tags (u64::MAX-1 through -4) | 60 | No collision with actor-to-actor messages |
| Arc<Mutex<WsStream>> unified pattern | 61 | Single code path for plain and TLS connections |
| 100ms reader thread timeout | 61 | Balances mutex contention with responsiveness |
| Pong handled before process_frame | 61 | Heartbeat needs to inspect payload before dispatch |
| UTF-8 validation on reassembled payload | 61 | Correct per RFC 6455; fragments may split codepoints |
| RoomRegistry dual-map (forward + reverse) | 62 | O(1) join/leave, O(rooms_per_conn) cleanup |
| cleanup_connection before shutdown.store | 62 | Prevents use-after-free in concurrent broadcasts |

## Files Created/Modified

**Created (2 files):**
- `crates/snow-rt/src/ws/server.rs` (Phase 60)
- `crates/snow-rt/src/ws/rooms.rs` (Phase 62)

**Modified (7 files):**
- `crates/snow-rt/Cargo.toml` (sha1 dep)
- `crates/snow-rt/src/lib.rs` (ws module)
- `crates/snow-rt/src/ws/mod.rs` (submodule declarations)
- `crates/snow-rt/src/ws/frame.rs` (Phase 59 + 61 MAX_PAYLOAD_SIZE)
- `crates/snow-rt/src/ws/handshake.rs` (Phase 59 + 60 return type)
- `crates/snow-rt/src/ws/close.rs` (Phase 59 + 61 MESSAGE_TOO_BIG)
- `crates/snow-rt/src/http/server.rs` (Phase 61 pub(crate) build_server_config)
- `crates/snow-codegen/src/codegen/intrinsics.rs` (8 LLVM declarations)
- `crates/snow-codegen/src/mir/lower.rs` (Ws stdlib + 8 known_functions + 8 map_builtin_name)

## Conclusion

v4.0 WebSocket Support milestone **passed** all audit criteria:

- **37/37 requirements** satisfied across 6 requirement groups
- **4/4 phases** verified with 50/50 observable truths
- **23/23 cross-phase connections** wired with zero orphaned exports
- **8/8 E2E flows** complete with no breaks
- **Zero anti-patterns**, zero tech debt, zero test regressions
- **1524 tests** passing across the full workspace

The milestone delivers complete WebSocket support: RFC 6455 protocol, actor-per-connection with crash isolation, plaintext and TLS serving, lifecycle callbacks, heartbeat with dead connection detection, message fragmentation, and rooms/channels with concurrent access and automatic cleanup.

---

*Audited: 2026-02-13T02:30:00Z*
*Auditor: Claude (gsd-audit-milestone)*
