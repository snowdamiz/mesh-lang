---
phase: 40-visibility-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - crates/snowc/tests/e2e.rs
autonomous: true

must_haves:
  truths:
    - "A function without `pub` cannot be called from another module (compile error)"
    - "Adding `pub` to a function makes it importable"
    - "A struct without `pub` cannot be imported from another module (compile error)"
    - "A pub struct has all fields accessible to importers"
    - "A sum type without `pub` cannot be imported (compile error)"
    - "A pub sum type has all variants accessible for construction and pattern matching"
    - "Error message for private item suggests adding `pub`"
    - "Single-file programs are unaffected (no `pub` needed)"
    - "Qualified access to private items is blocked"
    - "Selective import of private items is blocked"
  artifacts:
    - path: "crates/snowc/tests/e2e.rs"
      provides: "Comprehensive E2E tests for all VIS requirements"
      contains: "e2e_visibility"
  key_links:
    - from: "crates/snowc/tests/e2e.rs"
      to: "compile_multifile_and_run"
      via: "test helper for multi-file compilation"
      pattern: "compile_multifile_and_run"
    - from: "crates/snowc/tests/e2e.rs"
      to: "compile_multifile_expect_error"
      via: "test helper for expected compilation failure"
      pattern: "compile_multifile_expect_error"
---

<objective>
Add comprehensive E2E tests verifying all visibility enforcement requirements (VIS-01 through VIS-05).

Purpose: Prove that private-by-default semantics work end-to-end, pub makes items accessible, and error messages are helpful.
Output: 8-10 new e2e tests covering positive and negative visibility scenarios.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-visibility-enforcement/40-RESEARCH.md
@.planning/phases/40-visibility-enforcement/40-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: E2E tests for visibility enforcement (VIS-01 through VIS-05)</name>
  <files>crates/snowc/tests/e2e.rs</files>
  <action>
Add the following E2E tests after the existing Phase 39 cross-module tests. Use the existing `compile_multifile_and_run` and `compile_multifile_expect_error` test helpers. Group tests under a Phase 40 comment block.

**Test 1: Private function blocked via selective import (VIS-01)**
`e2e_visibility_private_fn_blocked`:
- math.snow: `fn secret(a :: Int) -> Int do a + 1 end` (NO pub)
- main.snow: `from Math import secret` then call `secret(5)`
- Assert compilation fails
- Assert error contains "private" or "pub"

**Test 2: Pub function importable via selective import (VIS-02)**
`e2e_visibility_pub_fn_works`:
- math.snow: `pub fn add(a :: Int, b :: Int) -> Int do a + b end`
- main.snow: `from Math import add` then `println("${add(2, 3)}")`
- Assert output is "5\n"

**Test 3: Private struct blocked via selective import (VIS-01, VIS-03)**
`e2e_visibility_private_struct_blocked`:
- shapes.snow: `struct Point do x :: Int y :: Int end` (NO pub) and `pub fn dummy() -> Int do 0 end` (at least one pub item so module is importable)
- main.snow: `from Shapes import Point`
- Assert compilation fails
- Assert error contains "private" or "pub"

**Test 4: Pub struct fully accessible with all fields (VIS-02, VIS-04)**
`e2e_visibility_pub_struct_accessible`:
- geometry.snow: `pub struct Point do x :: Int y :: Int end` and `pub fn make(a :: Int, b :: Int) -> Point do Point { x: a, y: b } end`
- main.snow: `from Geometry import Point, make` then `let p = make(10, 20)` then `println("${p.x},${p.y}")`
- Assert output is "10,20\n"

**Test 5: Private sum type blocked (VIS-01)**
`e2e_visibility_private_sum_type_blocked`:
- colors.snow: `type Color do Red Blue Green end` (NO pub)
- main.snow: `from Colors import Color`
- Assert compilation fails
- Assert error contains "private" or "pub"

**Test 6: Pub sum type with all variants accessible (VIS-02, VIS-05)**
`e2e_visibility_pub_sum_type_accessible`:
- colors.snow: `pub type Color do Red Blue Green end`
- main.snow: `from Colors import Color` then construct `let c = Red` then match:
```
case c do
  Red -> println("red")
  Blue -> println("blue")
  Green -> println("green")
end
```
- Assert output is "red\n"

**Test 7: Error message suggests adding pub (VIS-03)**
`e2e_visibility_error_suggests_pub`:
- helpers.snow: `fn internal() -> Int do 42 end` (NO pub)
- main.snow: `from Helpers import internal`
- Assert compilation fails
- Assert error contains BOTH "private" AND "pub" (the suggestion)

**Test 8: Single-file program unaffected**
`e2e_visibility_single_file_unaffected`:
This test already exists implicitly (e2e_single_file_still_works from Phase 39). Skip if it already covers this. Otherwise add:
- Single main.snow with `fn main() do println("hello") end` (no `pub`, no imports)
- Assert output is "hello\n"
- This confirms single-file programs don't need `pub`.

**Test 9: Qualified access to private function blocked (VIS-01)**
`e2e_visibility_qualified_private_blocked`:
- helpers.snow: `fn secret() -> Int do 42 end` (NO pub) and `pub fn public_fn() -> Int do 1 end` (so module has at least one export)
- main.snow: `import Helpers` then `let x = Helpers.secret()` then `println("${x}")`
- Assert compilation fails (private function not in qualified exports, so "no such field" or similar error)

**Test 10: Mixed pub and private in same module**
`e2e_visibility_mixed_pub_private`:
- utils.snow: `pub fn visible(x :: Int) -> Int do x * 2 end` and `fn hidden(x :: Int) -> Int do x * 3 end`
- main.snow: `from Utils import visible` then `println("${visible(5)}")`
- Assert output is "10\n"
- This confirms pub items work while private items in the same module don't leak.

**Note:** Use `compile_multifile_and_run` for positive tests and `compile_multifile_expect_error` for negative tests. Follow the exact assertion patterns used in Phase 39 tests. All Snow function bodies use `do...end` blocks. Return type annotations use `-> Type`. Parameter type annotations use `:: Type`.
  </action>
  <verify>
Run `cargo test -p snowc --test e2e -- e2e_visibility` to verify all new visibility tests pass. Then run full `cargo test` for zero regressions.
  </verify>
  <done>
8-10 E2E tests cover all VIS requirements: private fn/struct/sum_type blocked, pub fn/struct/sum_type accessible, error suggests "pub", single-file unaffected, qualified access blocked, mixed pub/private. All tests pass. Full test suite green.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p snowc --test e2e -- e2e_visibility` -- all new visibility tests pass
2. `cargo test` -- full workspace, zero regressions
3. Count new test functions: should be 8-10 tests starting with `e2e_visibility_`
</verification>

<success_criteria>
- At least 8 e2e tests covering VIS-01 through VIS-05
- Private items produce compile errors when imported
- Pub items are accessible with full functionality (fields, variants)
- Error messages mention "private" and suggest "pub"
- Single-file programs unaffected
- Qualified and selective import both enforce visibility
- Full cargo test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/40-visibility-enforcement/40-02-SUMMARY.md`
</output>
