---
phase: 91-rest-api
plan: 03
type: execute
wave: 3
depends_on: ["91-02"]
files_modified:
  - mesher/api/team.mpl
  - mesher/storage/queries.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "User can list all members of an organization with their roles"
    - "User can add a member to an organization with a specified role (owner/admin/member)"
    - "User can update a member's role within an organization"
    - "User can remove a member from an organization"
    - "User can create API tokens for a project"
    - "User can list API tokens for a project"
    - "User can revoke an API token"
  artifacts:
    - path: "mesher/api/team.mpl"
      provides: "Team membership and API token management HTTP handlers"
    - path: "mesher/storage/queries.mpl"
      provides: "Extended with team management and API token query functions"
    - path: "mesher/main.mpl"
      provides: "Updated with team and token route registration"
  key_links:
    - from: "mesher/api/team.mpl"
      to: "mesher/storage/queries.mpl"
      via: "imports team and token query functions"
    - from: "mesher/main.mpl"
      to: "mesher/api/team.mpl"
      via: "imports and registers team route handlers"
---

<objective>
Implement team membership management (ORG-04) and API token lifecycle (ORG-05) endpoints.

Purpose: Enable organization administrators to manage team members with role-based access (owner/admin/member) and manage API tokens for programmatic access to projects, including creation, listing, and revocation.

Output: New `api/team.mpl` with team and token endpoints, extended `queries.mpl` with additional team/token queries, updated `main.mpl` with route registration.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91-rest-api/91-RESEARCH.md
@.planning/phases/91-rest-api/91-02-SUMMARY.md

@mesher/storage/queries.mpl
@mesher/ingestion/routes.mpl
@mesher/main.mpl
@mesher/types/user.mpl
@mesher/types/project.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add team and token management query functions to queries.mpl</name>
  <files>mesher/storage/queries.mpl</files>
  <action>
Add the following query functions to the END of storage/queries.mpl. Some team/token queries already exist (add_member, get_members, create_api_key, revoke_api_key). Add the MISSING ones:

**1. `pub fn update_member_role(pool :: PoolHandle, membership_id :: String, new_role :: String) -> Int!String`** -- ORG-04 role update
   - SQL: `UPDATE org_memberships SET role = $2 WHERE id = $1::uuid AND $2 IN ('owner', 'admin', 'member')`
   - The SQL-side validation (`$2 IN (...)`) ensures only valid roles are accepted.
   - Uses Pool.execute, returns affected row count.

**2. `pub fn remove_member(pool :: PoolHandle, membership_id :: String) -> Int!String`** -- ORG-04 member removal
   - SQL: `DELETE FROM org_memberships WHERE id = $1::uuid`
   - Uses Pool.execute, returns affected row count.

**3. `pub fn list_api_keys(pool :: PoolHandle, project_id :: String) -> List<Map<String, String>>!String`** -- ORG-05 token listing
   - SQL: `SELECT id::text, project_id::text, key_value, label, created_at::text, COALESCE(revoked_at::text, '') AS revoked_at FROM api_keys WHERE project_id = $1::uuid ORDER BY created_at DESC`
   - Returns raw Map rows (not ApiKey structs) for consistent JSON serialization pattern.
   - Note: key_value is included for display -- in production you might mask it, but for this phase, return full value.

**4. `pub fn get_members_with_users(pool :: PoolHandle, org_id :: String) -> List<Map<String, String>>!String`** -- ORG-04 enriched member listing
   - JOIN with users table to include display_name and email alongside membership data.
   - SQL: `SELECT m.id::text, m.user_id::text, m.org_id::text, m.role, m.joined_at::text, u.email, u.display_name FROM org_memberships m JOIN users u ON u.id = m.user_id WHERE m.org_id = $1::uuid ORDER BY m.joined_at`
   - Returns raw Map rows to avoid cross-module struct issues.
  </action>
  <verify>Run `cd /Users/sn0w/Documents/dev/snow && cargo build 2>&1 | tail -20` to verify no compilation errors.</verify>
  <done>Four new query functions added to queries.mpl: update_member_role with SQL-side role validation, remove_member, list_api_keys with revoked_at handling, and get_members_with_users with user JOIN.</done>
</task>

<task type="auto">
  <name>Task 2: Create team and token route handlers and register in main.mpl</name>
  <files>mesher/api/team.mpl, mesher/main.mpl</files>
  <action>
**Create `mesher/api/team.mpl`** with team membership and API token management endpoints. Follow established handler pattern.

**CRITICAL:** Order functions bottom-up per decision [90-03]. Extract case arm logic into helpers per decision [88-02]. Use POST for all mutation operations per decision [89-02].

**Imports:**
```
from Ingestion.Pipeline import PipelineRegistry
from Storage.Queries import get_members_with_users, add_member, update_member_role, remove_member, list_api_keys, create_api_key, revoke_api_key
```

**Helper functions (define at TOP):**

1. `query_or_default(request, param :: String, default :: String) -> String` -- Same pattern.

2. `member_to_json(row) -> String` -- Serialize member row with user info: `{"id":"...","user_id":"...","email":"...","display_name":"...","role":"...","joined_at":"..."}`.

3. `api_key_to_json(row) -> String` -- Serialize API key row: `{"id":"...","project_id":"...","key_value":"...","label":"...","created_at":"...","revoked_at":"..."}`. If revoked_at is empty string, embed `null`.

4. `json_array_loop(items, i :: Int, total :: Int, acc :: String) -> String` + `to_json_array(items) -> String` -- Recursive JSON array builder.

5. `extract_json_field(pool :: PoolHandle, body :: String, field :: String) -> String` -- Use PostgreSQL to parse JSON body and extract a field: `Pool.query(pool, "SELECT COALESCE($1::jsonb->>$2, '') AS val", [body, field])`. Return the value or empty string. This reuses the pattern from handle_assign_issue in routes.mpl.

6. Helper functions for case arm extraction in handlers (e.g., `add_member_success`, `update_role_success`, `remove_success`, `create_key_success`, `revoke_key_success`).

**Handler functions (Team - ORG-04):**

1. `pub fn handle_list_members(request)` -- GET /api/v1/orgs/:org_id/members
   - Extract: org_id (Request.param)
   - Call: get_members_with_users(pool, org_id)
   - Map rows through member_to_json, to_json_array, respond 200

2. `pub fn handle_add_member(request)` -- POST /api/v1/orgs/:org_id/members
   - Extract: org_id (Request.param), body (Request.body)
   - Parse body with PostgreSQL JSON extraction: user_id, role (default "member")
   - Validate user_id is non-empty, return 400 if missing
   - Call: add_member(pool, user_id, org_id, role)
   - Response: HTTP.response(201, `{"id":"..."}`) on success

3. `pub fn handle_update_member_role(request)` -- POST /api/v1/orgs/:org_id/members/:membership_id/role
   - Extract: membership_id (Request.param), body (Request.body)
   - Parse body: role field
   - Call: update_member_role(pool, membership_id, role)
   - Response: HTTP.response(200, `{"status":"ok","affected":N}`)

4. `pub fn handle_remove_member(request)` -- POST /api/v1/orgs/:org_id/members/:membership_id/remove
   - Extract: membership_id (Request.param)
   - Call: remove_member(pool, membership_id)
   - Response: HTTP.response(200, `{"status":"ok","affected":N}`)

**Handler functions (API Tokens - ORG-05):**

5. `pub fn handle_list_api_keys(request)` -- GET /api/v1/projects/:project_id/api-keys
   - Extract: project_id (Request.param)
   - Call: list_api_keys(pool, project_id)
   - Map rows through api_key_to_json, to_json_array, respond 200

6. `pub fn handle_create_api_key(request)` -- POST /api/v1/projects/:project_id/api-keys
   - Extract: project_id (Request.param), body (Request.body)
   - Parse body: label (default "default")
   - Call: create_api_key(pool, project_id, label)
   - Response: HTTP.response(201, `{"key_value":"..."}`)

7. `pub fn handle_revoke_api_key(request)` -- POST /api/v1/api-keys/:key_id/revoke
   - Extract: key_id (Request.param)
   - Call: revoke_api_key(pool, key_id)
   - Response: HTTP.response(200, `{"status":"ok","affected":N}`)

**Update `mesher/main.mpl`:**
- Add import: `from Api.Team import handle_list_members, handle_add_member, handle_update_member_role, handle_remove_member, handle_list_api_keys, handle_create_api_key, handle_revoke_api_key`
- Add 7 route registrations after the dashboard/detail routes:
  ```
  # Team management routes (ORG-04)
  let r = HTTP.on_get(r, "/api/v1/orgs/:org_id/members", handle_list_members)
  let r = HTTP.on_post(r, "/api/v1/orgs/:org_id/members", handle_add_member)
  let r = HTTP.on_post(r, "/api/v1/orgs/:org_id/members/:membership_id/role", handle_update_member_role)
  let r = HTTP.on_post(r, "/api/v1/orgs/:org_id/members/:membership_id/remove", handle_remove_member)

  # API token routes (ORG-05)
  let r = HTTP.on_get(r, "/api/v1/projects/:project_id/api-keys", handle_list_api_keys)
  let r = HTTP.on_post(r, "/api/v1/projects/:project_id/api-keys", handle_create_api_key)
  let r = HTTP.on_post(r, "/api/v1/api-keys/:key_id/revoke", handle_revoke_api_key)
  ```
  </action>
  <verify>Run `cd /Users/sn0w/Documents/dev/snow && cargo build 2>&1 | tail -30` to verify compilation succeeds with all 7 team/token routes.</verify>
  <done>Seven team and token management endpoints exist and compile: list/add/update-role/remove members, and list/create/revoke API keys. All registered in main.mpl router. POST used for all mutations per decision [89-02].</done>
</task>

</tasks>

<verification>
1. `cargo build` compiles without errors
2. All 4 new query functions exist in queries.mpl
3. api/team.mpl exports 7 pub handler functions
4. main.mpl registers all 7 new routes (4 team + 3 token)
5. POST used for all mutation operations (not PUT/DELETE) per decision [89-02]
6. Role validation happens in SQL (`$2 IN ('owner', 'admin', 'member')`)
7. API key listing includes revoked_at status
8. JSON body parsing uses PostgreSQL jsonb extraction pattern (not Mesh-level parsing)
</verification>

<success_criteria>
- ORG-04: User can list org members with roles, add members, update roles, and remove members
- ORG-05: User can create API tokens, list tokens for a project, and revoke tokens
- All mutations use POST endpoints per established convention
- Role values validated at database level
</success_criteria>

<output>
After completion, create `.planning/phases/91-rest-api/91-03-SUMMARY.md`
</output>
