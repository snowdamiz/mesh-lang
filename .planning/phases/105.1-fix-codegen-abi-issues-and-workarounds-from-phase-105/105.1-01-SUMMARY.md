---
phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
plan: 01
subsystem: codegen
tags: [llvm, abi, pointer-boxing, sum-type, result, struct, variant, codegen]

# Dependency graph
requires:
  - phase: 105-verify-mesher-runtime-02
    provides: "Identified struct-in-Result ABI segfault requiring codegen fix"
provides:
  - "Pointer-boxing for struct payloads in sum type variant construction"
  - "Tests documenting sum type layout behavior (generic vs user-defined)"
  - "E2E test for Result<MultiFieldStruct, String> construct+match roundtrip"
affects: [codegen-abi, service-call-serialization, mesher-ingestion]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Pointer-box struct payloads >8 bytes when constructing sum type variants with {i8, ptr} layout"
    - "Heap-allocate via mesh_gc_alloc_actor and store pointer in ptr slot instead of overflowing"

key-files:
  created:
    - "tests/e2e/struct_in_result_roundtrip.mpl"
  modified:
    - "crates/mesh-codegen/src/codegen/expr.rs"
    - "crates/mesh-codegen/src/codegen/types.rs"
    - "crates/mesh-codegen/src/codegen/mod.rs"
    - "crates/meshc/tests/e2e_stdlib.rs"

key-decisions:
  - "Construction-side fix only: heap-allocate struct payload and store pointer in ptr slot; destructuring side already correctly loads through pointer via existing deref_struct logic in codegen_leaf"
  - "No changes needed to create_sum_type_layout or navigate_access_path_ptr -- the {i8, ptr} layout and GEP are correct; only the value being stored needed boxing"

patterns-established:
  - "When storing a StructValue into a generic sum type's {i8, ptr} layout, check store size > 8 bytes and pointer-box via mesh_gc_alloc_actor"
  - "Layout tests use TargetData::create('') for unit testing without full target machine initialization"

# Metrics
duration: 17min
completed: 2026-02-17
---

# Phase 105.1 Plan 01: Fix Struct-in-Result ABI Segfault Summary

**Pointer-boxing fix for multi-field struct payloads in Result/Option sum type construction, preventing buffer overflow segfault when struct size exceeds 8-byte ptr slot**

## Performance

- **Duration:** 17 min
- **Started:** 2026-02-17T03:40:33Z
- **Completed:** 2026-02-17T03:58:09Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Verified that the pointer-boxing fix in `codegen_construct_variant` (already committed in a3e1a8f9 from plan 105.1-02) correctly heap-allocates struct payloads >8 bytes and stores the pointer in the sum type's ptr slot
- Added layout documentation test verifying the mismatch between generic `{i8, ptr}` layouts (builtin Result/Option) and struct variant overlays that would overflow
- Added IR-level tests confirming the heap allocation pattern (variant_box) in construction and pointer dereferencing (deref_struct) in destructuring
- Added e2e runtime test: Pair{42,99} and Triple{10,20,30} wrapped in Result<Struct, String>, construct+match roundtrip produces correct sums (141, -1, 60) with no segfault

## Task Commits

Each task was committed atomically:

1. **Task 1: Pointer-box struct payloads in sum type variant construction** - `a3e1a8f9` (already committed in plan 105.1-02, verified working)
2. **Task 2: Add codegen tests for struct-in-Result layout and construct+match roundtrip** - `7b68efe0` (test: layout + IR + e2e tests)

## Files Created/Modified
- `crates/mesh-codegen/src/codegen/expr.rs` - Pointer-boxing in `codegen_construct_variant`: heap-allocates struct payloads >8 bytes via mesh_gc_alloc_actor (from a3e1a8f9)
- `crates/mesh-codegen/src/codegen/types.rs` - Layout documentation test `test_sum_type_layout_struct_payload`
- `crates/mesh-codegen/src/codegen/mod.rs` - IR-level tests: `test_struct_in_result_pointer_boxing` and `test_struct_in_result_construct_and_match_ir`
- `crates/meshc/tests/e2e_stdlib.rs` - E2e runtime test `e2e_struct_in_result_roundtrip`
- `tests/e2e/struct_in_result_roundtrip.mpl` - Mesh fixture: multi-struct Result construct+match

## Decisions Made
- **Construction-side fix only**: The plan asked for changes on both construction and destructuring sides. Analysis showed that the destructuring side already works correctly because: (1) the generic Result def has `MirType::Ptr` fields, so `variant_struct_type` produces `{i8, ptr}` -- the correct GEP overlay, (2) `navigate_access_path` loads a pointer from the ptr slot, and (3) `codegen_leaf` already has deref logic (lines 185-194) that detects when a binding type is `Struct` but the value is a pointer and loads through it. Only the construction side needed fixing.
- **No pattern.rs changes needed**: The `navigate_access_path_ptr` VariantField arm already uses the correct overlay because `variant_def.fields` from the generic Result has `[Ptr]`, not `[Struct]`. No override to `{i8, ptr}` is needed since it already IS `{i8, ptr}`.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Task 1 code change already committed by plan 105.1-02**
- **Found during:** Task 1 (pointer-boxing implementation)
- **Issue:** The variant construction fix was already present in commit a3e1a8f9 from plan 105.1-02 (service call reply serialization fix). That plan was executed before this one despite being numbered later.
- **Fix:** Verified the existing fix is correct and working via manual testing. No duplicate code changes needed.
- **Files modified:** None (already committed)
- **Impact:** Task 1 was reduced to verification-only; no new commit needed.

**2. [Rule 1 - Bug] Skipped unnecessary pattern.rs changes**
- **Found during:** Task 1 (analyzing destructuring side)
- **Issue:** The plan specified changes to `navigate_access_path_ptr` in pattern.rs, but analysis revealed these are unnecessary because the generic Result def already has `Ptr` fields (not `Struct`), so the variant overlay is already `{i8, ptr}` and the existing deref logic handles pointer-to-struct conversion.
- **Fix:** Documented why no changes are needed instead of adding unnecessary code.
- **Impact:** Simpler fix with no risk of breaking existing pattern matching behavior.

---

**Total deviations:** 2 (1 blocking/already-done, 1 skipped unnecessary change)
**Impact on plan:** Both deviations improved correctness. The fix works as intended with fewer code changes than planned.

## Issues Encountered
None -- the fix was already functional from a previous plan execution. Tests confirmed correctness.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Struct-in-Result ABI segfault is fixed and tested
- The workaround in mesher (String!String instead of Struct!String) can now be reverted to use proper struct return types
- Service call reply serialization fix (plan 105.1-02, already done) complements this fix
- Event ingestion pipeline may now work if the service call ABI was the remaining blocker

## Self-Check: PASSED
- [x] crates/mesh-codegen/src/codegen/expr.rs exists (pointer-boxing code present)
- [x] crates/mesh-codegen/src/codegen/types.rs exists (layout test present)
- [x] crates/mesh-codegen/src/codegen/mod.rs exists (IR tests present)
- [x] crates/meshc/tests/e2e_stdlib.rs exists (e2e test present)
- [x] tests/e2e/struct_in_result_roundtrip.mpl exists (fixture present)
- [x] Commit 7b68efe0 exists

---
*Phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105*
*Completed: 2026-02-17*
