---
phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
plan: 03
type: execute
wave: 2
depends_on: ["105.1-01", "105.1-02"]
files_modified:
  - mesher/ingestion/auth.mpl
  - mesher/storage/queries.mpl
  - mesher/ingestion/routes.mpl
autonomous: false

must_haves:
  truths:
    - "authenticate_request returns Project!String (not String!String workaround)"
    - "POST /api/v1/events endpoint works without segfault"
    - "EventProcessor.process_event service call completes successfully"
    - "All other Mesher endpoints continue to work"
  artifacts:
    - path: "mesher/ingestion/auth.mpl"
      provides: "authenticate_request returning Project!String"
      contains: "Project!String"
    - path: "mesher/ingestion/routes.mpl"
      provides: "Event ingestion using project struct fields"
      contains: "project.id"
    - path: "mesher/mesher"
      provides: "Rebuilt Mesher binary"
  key_links:
    - from: "mesher/ingestion/routes.mpl"
      to: "EventProcessor.process_event"
      via: "service call"
      pattern: "EventProcessor.process_event"
    - from: "mesher/ingestion/auth.mpl"
      to: "Storage.Queries.get_project_by_api_key"
      via: "direct function call returning Project struct"
      pattern: "get_project_by_api_key"
---

<objective>
Remove the Phase 105 workaround that avoided struct-in-Result, restore the original `Project!String` return type in authenticate_request, rebuild Mesher, and verify POST /api/v1/events works end-to-end.

Purpose: The workaround in Phase 105 changed `authenticate_request` to return `String!String` instead of `Project!String` to avoid a segfault. With the codegen fixes from Plans 01 and 02, the original code should work. Additionally, the EventProcessor service call should now work without segfaulting.

Output: Mesher with all endpoints working including event ingestion.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105/105.1-01-SUMMARY.md
@.planning/phases/105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105/105.1-02-SUMMARY.md
@mesher/ingestion/auth.mpl
@mesher/ingestion/routes.mpl
@mesher/storage/queries.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Revert auth.mpl workaround and restore Project!String return type</name>
  <files>mesher/ingestion/auth.mpl, mesher/storage/queries.mpl, mesher/ingestion/routes.mpl</files>
  <action>
**In `mesher/ingestion/auth.mpl`:**

1. Change the import back to `get_project_by_api_key` (instead of `get_project_id_by_key`)
2. Change `authenticate_request` return type from `String!String` to `Project!String`
3. Change the body to call `get_project_by_api_key(pool, key)` instead of `get_project_id_by_key(pool, key)`
4. Remove the comment about ABI workaround

**In `mesher/ingestion/routes.mpl`:**

1. Update the event ingestion handler to use `project.id` instead of the raw `project_id` string
2. Specifically, wherever `authenticate_request` result is pattern-matched, change from `Ok(project_id)` to `Ok(project)` and use `project.id` for the project ID

**In `mesher/storage/queries.mpl`:**

1. The `get_project_id_by_key` function can remain (it's still useful as a query), but verify `get_project_by_api_key` still exists and returns `Project!String`

After editing, rebuild Mesher: `meshc build mesher`

If the build fails, check error messages. If it segfaults at COMPILE time, that indicates the codegen fix from Plan 01 didn't work -- investigate.
  </action>
  <verify>
`meshc build mesher` succeeds with zero errors. The resulting binary exists at `mesher/mesher`.
  </verify>
  <done>
`authenticate_request` returns `Project!String`. Mesher compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all Mesher endpoints work with live PostgreSQL</name>
  <files>mesher/mesher</files>
  <action>
Rebuilt Mesher with codegen ABI fixes and removed workarounds. All three fixes applied: struct-in-Result pointer boxing, service call reply type handling, and auth workaround removal.

Verify by running the Mesher binary and testing all endpoints:

1. Start: `DATABASE_URL=postgres://mesh:mesh@localhost:5432/mesher ./mesher/mesher`
2. GET health: `curl -s http://localhost:8080/api/v1/projects/33333333-3333-3333-3333-333333333333/dashboard/health` -> HTTP 200 with JSON
3. POST event: `curl -s -X POST http://localhost:8080/api/v1/events -H 'x-sentry-auth: Sentry sentry_key=mshr_testkey123' -H 'Content-Type: application/json' -d '{"message":"test event","level":"info"}'` -> HTTP 200/201 (NOT segfault)
4. WebSocket: `curl -s -i -H 'Connection: Upgrade' -H 'Upgrade: websocket' -H 'Sec-WebSocket-Version: 13' -H 'Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==' http://localhost:8081/ingest` -> HTTP 101
  </action>
  <verify>Human confirms all endpoints respond correctly, especially POST /api/v1/events which was previously crashing.</verify>
  <done>All Mesher endpoints verified working by human tester. Event ingestion no longer segfaults.</done>
</task>

</tasks>

<verification>
1. Mesher compiles with `meshc build mesher` (zero errors)
2. All HTTP endpoints return correct responses
3. POST /api/v1/events does NOT segfault
4. WebSocket upgrade completes
5. No regressions in any previously-working endpoint
</verification>

<success_criteria>
- authenticate_request returns Project!String (workaround removed)
- POST /api/v1/events endpoint is functional (EventProcessor service call works)
- All other Mesher endpoints continue working (no regressions)
- Human verification confirms all endpoints via live testing
</success_criteria>

<output>
After completion, create `.planning/phases/105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105/105.1-03-SUMMARY.md`
</output>
