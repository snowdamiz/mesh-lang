---
phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
plan: 02
subsystem: codegen
tags: [llvm, service-call, abi, tuple-encoding, inttoptr, sum-type, struct-state]

# Dependency graph
requires:
  - phase: 105-verify-mesher-runtime-02
    provides: "Identified EventProcessor service call ABI segfault in reply deserialization"
provides:
  - "Type-aware service call reply conversion (inttoptr for complex types, raw i64 for scalars)"
  - "Size-aware service loop state extraction (bitcast for small structs, inttoptr+load for large)"
affects: [event-ingestion, codegen-abi, service-call-serialization, mesher-runtime]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Service call reply uses MIR return type to determine inttoptr vs raw i64 return"
    - "Struct state extraction in service loop uses target_data.get_store_size to match tuple encoding strategy"

key-files:
  created: []
  modified:
    - "crates/mesh-codegen/src/codegen/expr.rs"

key-decisions:
  - "Pass MIR return type to codegen_service_call_helper for type-aware reply conversion instead of always converting to pointer"
  - "Use target_data.get_store_size threshold (<=8 bytes) to match tuple encoding for struct state extraction"

patterns-established:
  - "Service call reply conversion: SumType/Struct/String/Ptr -> inttoptr, Int/Bool/Float/Pid -> raw i64"
  - "Struct state extraction: small (<= 8 bytes) -> alloca bitcast, large (> 8 bytes) -> inttoptr+load"

# Metrics
duration: 9min
completed: 2026-02-17
---

# Phase 105.1 Plan 02: Fix Service Call Reply Serialization Summary

**Type-aware service call reply conversion using MIR return type with size-based struct state extraction matching tuple encoding strategy**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-17T03:38:43Z
- **Completed:** 2026-02-17T03:48:33Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Service call helper now returns pointer (inttoptr) for complex return types (SumType, Struct, String, Ptr), enabling the let-binding coercion path to automatically load struct values through the pointer
- Scalar return types (Int, Bool, Float, Pid) continue returning raw i64, preserving backward compatibility with all existing service tests
- Service loop state extraction now distinguishes small structs (<= 8 bytes, bitcast from i64) from large structs (> 8 bytes, inttoptr+load), matching the tuple encoding strategy in codegen_make_tuple
- All 176 mesh-codegen tests, 509 mesh-rt tests, 11 concurrency e2e tests, and 90+ meshc tests pass

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix service loop reply to send actual reply data** - `a3e1a8f9` (fix)

## Files Created/Modified
- `crates/mesh-codegen/src/codegen/expr.rs` - Fixed codegen_service_call_helper to return type-appropriate reply values and codegen_service_loop struct state extraction to handle both small and large structs

## Decisions Made
- Passed MIR return type (`reply_ty`) to `codegen_service_call_helper` instead of always converting to pointer, avoiding breakage for scalar service calls (Int counters, etc.)
- Used `target_data.get_store_size` with 8-byte threshold for struct state extraction, matching the exact same logic used in `codegen_make_tuple` for encoding

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Type-aware reply conversion instead of unconditional inttoptr**
- **Found during:** Task 1 (implementing inttoptr fix)
- **Issue:** Plan suggested always converting reply i64 to ptr, but this would break existing service calls returning Int/Bool/Float since the calling code expects IntValue, not PointerValue
- **Fix:** Pass MIR return type to codegen_service_call_helper; only convert to ptr for SumType/Struct/String/Ptr, return raw i64 for scalars
- **Files modified:** crates/mesh-codegen/src/codegen/expr.rs
- **Verification:** All 3 existing service e2e tests (counter, call_cast, state_management) pass
- **Committed in:** a3e1a8f9 (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Essential fix to prevent regression on scalar service calls. No scope creep.

## Issues Encountered
- 2 pre-existing HTTP e2e test failures (e2e_http_server_runtime, e2e_http_crash_isolation) confirmed unrelated to this change by testing against the pre-change codebase

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Service call reply serialization is now type-aware, ready for Plan 03 to test end-to-end with Mesher's EventProcessor service
- Plan 01 (ConstructVariant struct-in-Result fix) may interact with this fix for the full event ingestion pipeline

---
*Phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105*
*Completed: 2026-02-17*
