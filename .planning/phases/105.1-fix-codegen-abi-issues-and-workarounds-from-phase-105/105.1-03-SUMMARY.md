---
phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
plan: 03
subsystem: codegen
tags: [abi, struct-in-result, auth, workaround-removal, service-call, mesher]

# Dependency graph
requires:
  - phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
    plan: 01
    provides: "Struct-in-Result pointer-boxing fix for ConstructVariant"
  - phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105
    plan: 02
    provides: "Type-aware service call reply conversion (inttoptr for complex types)"
provides:
  - "Auth workaround removed: authenticate_request returns Project!String directly"
  - "Confirmed struct-in-Result ABI fix works end-to-end in Mesher auth pipeline"
  - "Identified remaining SIGSEGV in EventProcessor service call background processing"
affects: [mesher-runtime, ingestion-auth, service-call-abi]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Struct-in-Result return from cross-module service queries works after Plan 01 pointer-boxing fix"

key-files:
  created: []
  modified:
    - "mesher/ingestion/auth.mpl"
    - "mesher/ingestion/routes.mpl"

key-decisions:
  - "Reverted auth workaround to return full Project struct instead of just project_id String"
  - "Documented remaining service call SIGSEGV as out-of-scope for this plan (requires deeper investigation)"

patterns-established:
  - "Cross-module struct-in-Result returns work correctly after Plan 01 fix"
  - "Service call ABI still has outstanding issues with background EventProcessor processing"

# Metrics
duration: 9min
completed: 2026-02-17
---

# Phase 105.1 Plan 03: Revert Auth Workaround and Verify Mesher Endpoints Summary

**Reverted authenticate_request to return Project!String, confirming struct-in-Result fix works for auth but EventProcessor service call SIGSEGV persists**

## Performance

- **Duration:** 9 min
- **Started:** 2026-02-17T04:05:52Z
- **Completed:** 2026-02-17T04:15:15Z
- **Tasks:** 2 (1 auto + 1 human-verify)
- **Files modified:** 2 (+ binary rebuild)

## Accomplishments
- Reverted the `String!String` auth workaround from Phase 105, restoring `authenticate_request` to return `Project!String` with full struct
- Confirmed struct-in-Result pointer-boxing fix (Plan 01) works end-to-end: API key auth lookup returns a 5-field Project struct in a Result without segfault
- Health endpoint returns HTTP 200 with correct JSON dashboard data
- WebSocket upgrade returns HTTP 101 correctly
- Event ingestion auth pipeline completes without crash (rate limiter responds HTTP 429 correctly)
- Identified remaining SIGSEGV: EventProcessor service call crashes during asynchronous background event processing after the HTTP response is sent

## Task Commits

Each task was committed atomically:

1. **Task 1: Revert auth.mpl workaround and restore Project!String** - `f9f74455` (fix)
2. **Task 2: Verify Mesher endpoints** - human-verify checkpoint (no commit, verification only)

## Files Created/Modified
- `mesher/ingestion/auth.mpl` - Changed import to get_project_by_api_key, return type to Project!String, removed workaround comments
- `mesher/ingestion/routes.mpl` - Updated handle_event and handle_bulk to destructure Ok(project) and pass project.id
- `mesher/mesher` - Rebuilt binary with all Phase 105.1 codegen fixes applied

## Decisions Made
- Reverted to `get_project_by_api_key` (returns `Project!String`) instead of `get_project_id_by_key` (returns `String!String`), confirming the ABI fix works for this code path
- Kept `get_project_id_by_key` function in queries.mpl as it may still be useful and does not cause harm
- Documented remaining EventProcessor SIGSEGV as a known issue requiring further investigation rather than blocking this plan

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Rebuilt meshc before building Mesher**
- **Found during:** Task 1 (building Mesher)
- **Issue:** The installed meshc symlink at `/Users/sn0w/.local/bin/meshc` could not locate `libmesh_rt.a` when invoked, even though the file existed at `target/release/libmesh_rt.a`
- **Fix:** Rebuilt meshc with `cargo build -p meshc --release` to pick up Plans 01/02 codegen changes, then invoked meshc directly via full path
- **Files modified:** None (build tooling only)
- **Verification:** `meshc build mesher` succeeded, producing valid arm64 Mach-O binary
- **Committed in:** f9f74455 (Task 1 commit, binary included)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Build tooling workaround, no scope change.

## Verification Results (Human-Verify)

| Endpoint | Method | Result | Status |
| --- | --- | --- | --- |
| /api/v1/projects/{id}/dashboard/health | GET | HTTP 200, correct JSON | PASS |
| /api/v1/events (Sentry header format) | POST | HTTP 401, no crash | PASS (header parsing expected) |
| /api/v1/events (raw key) | POST | HTTP 429, auth succeeded | PASS (auth), FAIL (background SIGSEGV) |
| /ingest (WebSocket) | GET | HTTP 101 upgrade | PASS |

**Auth pipeline (struct-in-Result):** CONFIRMED WORKING -- `Project!String` returned and destructured without segfault.

**EventProcessor service call:** STILL CRASHING -- exit code 139 (SIGSEGV) during asynchronous background processing after the HTTP response is sent. The crash occurs in the service call to EventProcessor, not in the auth pipeline.

## Issues Encountered
- EventProcessor service call SIGSEGV persists despite Plan 02 fixes. The service call reply conversion fix may not cover all code paths in the EventProcessor pipeline, or there may be an additional ABI issue in the service loop state management. This requires a dedicated investigation in a future plan.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Auth workaround successfully removed, struct-in-Result works for Project!String
- EventProcessor service call ABI issue remains and needs dedicated investigation
- Potential areas: service loop state extraction for EventProcessor's specific state struct, or tuple encoding/decoding in the process_event return path

## Self-Check: PASSED

- FOUND: mesher/ingestion/auth.mpl
- FOUND: mesher/ingestion/routes.mpl
- FOUND: mesher/mesher
- FOUND: 105.1-03-SUMMARY.md
- FOUND: commit f9f74455

---
*Phase: 105.1-fix-codegen-abi-issues-and-workarounds-from-phase-105*
*Completed: 2026-02-17*
