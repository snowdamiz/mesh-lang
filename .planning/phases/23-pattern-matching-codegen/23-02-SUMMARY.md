---
phase: 23-pattern-matching-codegen
plan: 02
subsystem: typeck-codegen
tags: [ordering, compare, sum-types, pattern-matching, mir-generation]

# Dependency graph
requires:
  - phase: 23-01
    provides: "Correct constructor tag and field type resolution in pattern compiler"
  - phase: 18-sum-types
    provides: "MirSumTypeDef, MirVariantDef, ConstructVariant codegen"
provides:
  - "Ordering registered as built-in sum type (Less=0, Equal=1, Greater=2)"
  - "compare(a, b) -> Ordering for Int, Float, String, user structs, user sum types"
  - "Ord trait has compare() method with Ordering return type"
  - "compare() dispatched to Ord__compare__TypeName at MIR level"
affects: [24-tgen, pattern-matching-codegen]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Ord__compare__Type generated alongside Ord__lt__Type for all Ord-implementing types"
    - "Primitive compare uses BinOp::Lt/BinOp::Eq; struct/sum compare delegates to Ord__lt__ and Eq__eq__"
    - "compare(a, b) call dispatch follows same pattern as default() -- type resolved from first arg"

key-files:
  created: []
  modified:
    - "crates/snow-typeck/src/infer.rs"
    - "crates/snow-typeck/src/builtins.rs"
    - "crates/snow-codegen/src/mir/lower.rs"

key-decisions:
  - "Ordering registered as non-generic built-in sum type (no type parameters)"
  - "compare() added to Ord trait with has_default_body: true"
  - "Primitive compare functions use BinOp directly (no Ord__lt__Int function exists)"
  - "Struct/sum compare delegates to existing Ord__lt__ and Eq__eq__ trait functions"

patterns-established:
  - "Built-in sum types auto-registered in MIR via type_registry.sum_type_defs iteration"
  - "Polymorphic built-in function (compare) dispatched by first-arg type in lower_call_expr"

# Metrics
duration: 11min
completed: 2026-02-08
---

# Phase 23 Plan 02: Ordering Type & Compare Function Summary

**Ordering (Less|Equal|Greater) as built-in sum type with compare() dispatching to Ord__compare__TypeName via BinOp for primitives and trait delegation for user types**

## Performance

- **Duration:** 11 min
- **Started:** 2026-02-08T18:03:56Z
- **Completed:** 2026-02-08T18:14:58Z
- **Tasks:** 2/2
- **Files modified:** 3
- **Tests added:** 9 (7 MIR lowering + 2 implied from Ordering registration)
- **Total tests:** 1,196 passing (up from 1,187)

## Accomplishments

- Registered Ordering as a built-in sum type with variants Less (tag 0), Equal (tag 1), Greater (tag 2)
- Added compare() method to Ord trait with Ordering return type
- Registered compare(T, T) -> Ordering as polymorphic built-in function
- Generated Ord__compare__Int, Ord__compare__Float, Ord__compare__String MIR functions using BinOp
- Generated Ord__compare__StructName for user structs that derive Ord
- Generated Ord__compare__SumTypeName for user sum types that derive Ord
- Added compare(a, b) call dispatch to Ord__compare__TypeName in MIR lowerer
- Added 7 new integration tests covering all four Phase 23 success criteria

## Task Commits

Each task was committed atomically:

1. **Task 1: Register Ordering sum type and add compare() to Ord trait** - `bc3c574` (feat)
2. **Task 2: Generate Ord__compare__Type MIR functions and add integration tests** - `689fdfe` (feat)

## Files Created/Modified

- `crates/snow-typeck/src/infer.rs` - Added Ordering sum type registration in register_builtin_sum_types()
- `crates/snow-typeck/src/builtins.rs` - Added compare() to Ord trait, compare Ord impls for Int/Float/String, polymorphic compare() function
- `crates/snow-codegen/src/mir/lower.rs` - Added generate_compare_struct, generate_compare_sum, generate_compare_primitive methods; compare() call dispatch; 7 integration tests

## Decisions Made

1. **Ordering as non-generic type:** Ordering has no generic parameters, unlike Option<T> or Result<T, E>. This simplifies registration and codegen.
2. **compare() has has_default_body: true:** Marked as having a default body since the implementation is synthesized by the compiler, not written in Snow source.
3. **Primitive compare uses BinOp directly:** Since Int/Float/String don't have generated Ord__lt__ functions (they use hardware operators), the compare functions use BinOp::Lt and BinOp::Eq directly.
4. **Struct/sum compare delegates to trait functions:** For user types, Ord__compare__Name calls Ord__lt__Name and Eq__eq__Name, which are already generated by the existing derive machinery.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All four Phase 23 success criteria are now met:
  1. `case opt do Some(x) -> x end` binds x to inner value (fixed in 23-01, tested in 23-02)
  2. `case compare(a, b) do Less -> ... | Equal -> ... | Greater -> ... end` compiles correctly
  3. Ordering is a first-class built-in sum type with Less, Equal, Greater constructors
  4. Nested constructor patterns work (field type resolution fixed in 23-01)
- Phase 23 is complete; ready for Phase 24 (TGEN-01/TGEN-02)

## Self-Check: PASSED

---
*Phase: 23-pattern-matching-codegen*
*Completed: 2026-02-08*
