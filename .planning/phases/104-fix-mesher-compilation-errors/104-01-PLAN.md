---
phase: 104-fix-mesher-compilation-errors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/mesh-typeck/src/infer.rs
  - mesher/storage/queries.mpl
  - mesher/services/org.mpl
  - mesher/services/project.mpl
  - mesher/services/user.mpl
  - mesher/api/team.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "meshc build mesher completes with zero compilation errors and produces a binary"
    - "All Repo calls (insert, get, get_by, all, delete) use concrete Result types in the typechecker"
    - "All 6 affected Mesher files import and export correctly with no cascading errors"
  artifacts:
    - path: "crates/mesh-typeck/src/infer.rs"
      provides: "Concrete typeck signatures for Repo.insert/get/get_by/all/delete"
      contains: "Ty::result"
  key_links:
    - from: "crates/mesh-typeck/src/infer.rs"
      to: "mesher/storage/queries.mpl"
      via: "Repo.insert/get/get_by/all/delete type signatures"
      pattern: "Ty::result.*Ty::map"
    - from: "mesher/storage/queries.mpl"
      to: "mesher/services/org.mpl"
      via: "insert_org export"
      pattern: "from Storage.Queries import insert_org"
---

<objective>
Fix all 46 Mesher compilation errors by updating the Mesh type checker to use concrete Result types for Repo.insert, Repo.get, Repo.get_by, Repo.all, and Repo.delete -- matching the concrete types already used by Repo.query_raw and Repo.execute_raw since Phase 103.

Purpose: These 5 functions still use opaque `Ptr` return types in the typechecker, but the runtime actually returns `Result<Map<String,String>, String>` or `Result<List<Map<String,String>>, String>`. This mismatch causes 13 direct errors in queries.mpl (Ptr-vs-Map, ?-on-Ptr), which cascade into 33 more errors across org.mpl, project.mpl, user.mpl, team.mpl, and main.mpl (failed exports, undefined variables, argument count mismatches, type mismatches).

Output: Zero-error `meshc build mesher` producing a working binary.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher/103-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Repo typeck signatures from Ptr to concrete Result types</name>
  <files>crates/mesh-typeck/src/infer.rs</files>
  <action>
In `crates/mesh-typeck/src/infer.rs`, inside the Repo module registration block (around lines 1136-1231), change the return types for 5 functions from `Ptr` to concrete `Result<...>` types. Use the exact same pattern as `Repo.query_raw` and `Repo.execute_raw` (which were already fixed in Phase 103-04).

**Changes (return type only unless noted):**

1. `Repo.all` (line ~1142): Change return from `ptr_t.clone()` to `Ty::result(Ty::list(Ty::map(Ty::string(), Ty::string())), Ty::string())`
   - Runtime returns `Result<List<Map<String,String>>, String>` per mesh_repo_all docs
   - Query arg stays `ptr_t.clone()` (Query objects are opaque Ptr)

2. `Repo.get` (line ~1152): Change return from `ptr_t.clone()` to `Ty::result(Ty::map(Ty::string(), Ty::string()), Ty::string())`
   - Runtime returns `Result<Map<String,String>, String>` per mesh_repo_get docs

3. `Repo.get_by` (line ~1157): Change return from `ptr_t.clone()` to `Ty::result(Ty::map(Ty::string(), Ty::string()), Ty::string())`
   - Runtime returns `Result<Map<String,String>, String>` per mesh_repo_get_by docs

4. `Repo.insert` (line ~1172): Change return from `ptr_t.clone()` to `Ty::result(Ty::map(Ty::string(), Ty::string()), Ty::string())` AND change the third parameter (fields) from `ptr_t.clone()` to `Ty::map(Ty::string(), Ty::string())`
   - Runtime accepts Map<String,String> fields and returns `Result<Map<String,String>, String>` per mesh_repo_insert docs
   - The Mesh source passes Map literals like `%{"name" => name, "slug" => slug}` which have type `Map<String, String>`

5. `Repo.delete` (line ~1182): Change return from `ptr_t.clone()` to `Ty::result(Ty::map(Ty::string(), Ty::string()), Ty::string())`
   - Runtime returns `Result<Map<String,String>, String>` per mesh_repo_delete docs

**Do NOT change:** Repo.one, Repo.count, Repo.exists, Repo.update, Repo.transaction, Repo.update_where, Repo.delete_where, Repo.query_raw, Repo.execute_raw, Repo.insert_changeset, Repo.update_changeset, Repo.preload. These either are not used in Mesher or already have correct types.

**Why this works:** The MIR lowerer and codegen use `MirType::Ptr` for all Repo functions regardless of typeck, and the runtime FFI uses opaque `*mut u8` pointers. Only the typechecker layer needs concrete types so Mesh source code type-checks correctly. This is the exact same approach used to fix Repo.query_raw/execute_raw in Phase 103-04.

After making changes, rebuild the compiler: `cargo build --release`
  </action>
  <verify>
Run `cargo build --release` -- must succeed with no Rust compilation errors.
Run `cargo test --release` -- existing tests must still pass (no regressions from type signature changes).
  </verify>
  <done>
Compiler rebuilds successfully. Repo.insert/get/get_by/all/delete typeck signatures use concrete Result types matching their runtime behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Mesher builds with zero errors and fix any remaining issues</name>
  <files>mesher/storage/queries.mpl, mesher/services/org.mpl, mesher/services/project.mpl, mesher/services/user.mpl, mesher/api/team.mpl, mesher/main.mpl</files>
  <action>
Run `cargo run --release -- build mesher` and verify zero compilation errors.

**Expected outcome:** All 46 errors should resolve because:
- The 13 direct errors in queries.mpl (3x Ptr-vs-Map for Repo.insert args, 10x ?-on-Ptr for Repo.get/get_by/all) are fixed by the new concrete types
- The 3 "expected Map, found Result" file-level errors in queries.mpl are cascading artifacts that resolve when the direct errors are fixed
- The 7 E0034 "name not found in module" errors in org.mpl, project.mpl, user.mpl, team.mpl resolve because queries.mpl now exports all functions (insert_org, insert_project, add_member)
- The 16 E0004 undefined variable errors cascade-resolve when imports work
- The 3 E0003 argument count errors cascade-resolve when service modules compile
- The main.mpl E0034/E0004 errors resolve when service modules export OrgService/ProjectService/UserService
- The team.mpl and main.mpl type mismatch errors (Response vs Result, Unit vs Response) are cascading artifacts

**If any errors remain after the typeck fix,** diagnose and fix them in the Mesh source files:

Possible residual issues to check:
1. If `Repo.all` returns `Result<List<Map<String,String>>, String>`, then `let rows = Repo.all(pool, q)?` gives `rows` type `List<Map<String,String>>`. The `List.map(rows, fn(row) do ... end)` should work. Verify.
2. If `Repo.insert` returns `Result<Map<String,String>, String>`, then `let row = Repo.insert(pool, table, fields)?` gives `row` type `Map<String,String>`. The `Map.get(row, "id")` should work. Verify.
3. If `Repo.delete` returns `Result<Map<String,String>, String>`, then `let _ = Repo.delete(pool, table, id)?` should work since `?` unwraps Result. But `remove_member` returns `Ok(1)` (Int), and the delete result is discarded with `let _`. Verify this type-checks.

For any remaining errors, apply minimal targeted fixes to the .mpl files. Do NOT rewrite working code. Only fix what the compiler reports.

After zero errors, verify the binary was produced: `ls -la mesher/mesher`
  </action>
  <verify>
Run `cargo run --release -- build mesher 2>&1 | grep -c "Error"` -- must output `0`.
Run `ls -la mesher/mesher` -- binary must exist and have a recent timestamp.
  </verify>
  <done>
`meshc build mesher` completes with zero compilation errors. A fresh mesher binary exists at mesher/mesher. All 6 affected files compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cargo run --release -- build mesher` produces zero errors
2. `mesher/mesher` binary exists with current timestamp
3. `cargo test --release` passes (no regressions in Rust test suite)
</verification>

<success_criteria>
- meshc build mesher exits 0 with no error output
- mesher/mesher binary produced
- No Rust test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/104-fix-mesher-compilation-errors/104-01-SUMMARY.md`
</output>
