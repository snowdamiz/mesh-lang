---
phase: 21-extended-protocols
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - crates/snow-typeck/src/builtins.rs
  - crates/snow-codegen/src/mir/lower.rs
autonomous: true

must_haves:
  truths:
    - "default() returns 0 for Int, 0.0 for Float, false for Bool, empty string for String"
    - "default() return type resolved from call-site context (type annotation or inference)"
    - "Default trait registered as compiler-known with static method (no self parameter)"
  artifacts:
    - path: "crates/snow-typeck/src/builtins.rs"
      provides: "Default trait registration with primitive impls"
      contains: "Default"
    - path: "crates/snow-codegen/src/mir/lower.rs"
      provides: "Default__default primitive short-circuits + call-site type resolution"
      contains: "Default__default"
  key_links:
    - from: "crates/snow-codegen/src/mir/lower.rs"
      to: "crates/snow-typeck/src/builtins.rs"
      via: "TraitRegistry lookup for Default impls during default() call lowering"
      pattern: "Default__default"
---

<objective>
Implement the Default protocol: trait registration with a static method (no self parameter), primitive impls that short-circuit to MIR literals, and call-site type resolution for the Self return type.

Purpose: Enables zero-initialization for any type with a Default impl. First static trait method in Snow (no self parameter), establishing the pattern for future static trait methods.
Output: Working `default()` calls that return 0/0.0/false/"" for primitives, resolved from type annotation context.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-extended-protocols/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Default trait + primitive impls</name>
  <files>
    crates/snow-typeck/src/builtins.rs
  </files>
  <action>
    In `register_compiler_known_traits()` in `builtins.rs`:

    1. Register Default trait with single method:
       - name: "default"
       - has_self: false (STATIC method -- this is the key difference from all prior traits)
       - param_count: 0
       - return_type: None (indicates "Self" -- resolved per concrete type at call site)
       - has_default_body: false

    2. Register Default impls for Int, Float, String, Bool:
       - Follow same registration pattern as Hash/Display
       - Each impl has method "default" with has_self=false, param_count=0
       - return_type for each impl: Some(Ty::int()), Some(Ty::float()), etc. (concrete type, not None)

    3. Add test `default_trait_registered_for_primitives`:
       - Verify `has_impl("Default", &Ty::int())` returns true for all four primitives
       - Verify `find_method_traits("default", &Ty::int())` returns `["Default"]`

    Note: Do NOT auto-derive Default for structs (per research: require explicit `impl Default for MyStruct`). The success criteria say "user-defined for structs" which implies user-written impls.
  </action>
  <verify>
    `cargo test --workspace` passes with zero regressions.
    `cargo test -p snow-typeck -- default_trait_registered` passes.
  </verify>
  <done>
    Default trait registered in TraitRegistry with has_self=false and return_type=None. Primitive Default impls registered for Int, Float, String, Bool.
  </done>
</task>

<task type="auto">
  <name>Task 2: Default__default primitive short-circuits + call-site type resolution in MIR lowering</name>
  <files>
    crates/snow-codegen/src/mir/lower.rs
  </files>
  <action>
    In `lower_call_expr` in `lower.rs`:

    1. Add detection for bare `default()` calls:
       - When the callee is a bare identifier "default" with zero arguments
       - Look up the call expression's resolved type from the typeck types map using `self.resolve_range(call.syntax().text_range())` or equivalent
       - Use `mir_type_to_impl_name` (or similar) to get the concrete type name
       - Construct mangled name: `Default__default__TypeName`

    2. Add primitive Default short-circuits (same pattern as Display primitive redirects):
       - `Default__default__Int` -> return `MirExpr::IntLit(0, MirType::Int)`
       - `Default__default__Float` -> return `MirExpr::FloatLit(0.0, MirType::Float)`
       - `Default__default__Bool` -> return `MirExpr::BoolLit(false, MirType::Bool)`
       - `Default__default__String` -> return `MirExpr::StringLit("".to_string(), MirType::String)`

    3. For non-primitive types (user structs with explicit Default impl):
       - Emit `MirExpr::Call { func: Default__default__TypeName, args: [] }` -- the impl method body was already lowered by the standard impl lowering pipeline
       - The return type is the concrete struct type from the typeck context

    4. Add tests:
       - `default_int_short_circuits_to_literal`: verify `let x: Int = default()` produces `IntLit(0)` in MIR
       - `default_float_short_circuits_to_literal`: verify Float produces `FloatLit(0.0)`
       - `default_string_short_circuits_to_literal`: verify String produces `StringLit("")`
       - `default_bool_short_circuits_to_literal`: verify Bool produces `BoolLit(false)`

    IMPORTANT: The type resolution from call context is critical. `default()` has no arguments, so the type comes from the assignment target or type annotation. If the typeck pass hasn't resolved the type (e.g., `let x = default()` with no annotation and no subsequent usage), this should fall through to a warning (not panic), following the existing error recovery pattern from 19-03.
  </action>
  <verify>
    `cargo test --workspace` passes with zero regressions.
    `cargo test -p snow-codegen -- default_` passes (all four short-circuit tests).
    `cargo build --workspace` compiles cleanly.
  </verify>
  <done>
    `default()` calls resolve type from context, short-circuit to MIR literals for primitives, and emit function calls for user types. All four primitive Default short-circuits verified.
  </done>
</task>

</tasks>

<verification>
- `cargo test --workspace` -- all existing tests pass plus new Default tests
- `cargo build --workspace` -- clean compilation
- Default trait registered with has_self=false (static method)
- Primitive defaults short-circuit to MIR literals (no runtime call)
- Call-site type resolution works for annotated `let x: Int = default()`
</verification>

<success_criteria>
- Default trait registered for Int, Float, String, Bool
- `default()` resolves type from call-site context
- Primitive defaults: 0, 0.0, false, "" as MIR literals
- User struct defaults emit call to `Default__default__TypeName`
- All tests pass, zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/21-extended-protocols/21-02-SUMMARY.md`
</output>
