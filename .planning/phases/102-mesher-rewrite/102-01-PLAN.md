---
phase: 102-mesher-rewrite
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mesher/types/project.mpl
  - mesher/types/user.mpl
  - mesher/types/event.mpl
  - mesher/types/issue.mpl
  - mesher/types/alert.mpl
  - mesher/types/retention.mpl
  - mesher/migrations/20260216120000_create_initial_schema.mpl
  - mesher/storage/schema.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "All 11 Mesher type structs use deriving(Schema) and compile successfully"
    - "Schema metadata functions (__table__, __fields__, __primary_key__, __relationships__) return correct values for each struct"
    - "Session struct uses primary_key :token (not default :id)"
    - "RetentionSettings exists as a new struct with table 'projects' and fields retention_days, sample_rate"
    - "A versioned migration file creates all 10 tables, extensions, and indexes in FK dependency order"
    - "storage/schema.mpl's create_schema function is replaced by the migration file; partition functions remain"
  artifacts:
    - path: "mesher/types/project.mpl"
      provides: "Organization, Project, ApiKey with deriving(Schema) and relationship declarations"
      contains: "deriving(Schema"
    - path: "mesher/types/user.mpl"
      provides: "User, OrgMembership, Session with deriving(Schema) and relationship declarations"
      contains: "primary_key :token"
    - path: "mesher/types/event.mpl"
      provides: "Event with deriving(Schema) and belongs_to relationships"
      contains: "table \"events\""
    - path: "mesher/types/issue.mpl"
      provides: "Issue with deriving(Schema) and belongs_to/has_many relationships"
      contains: "deriving(Schema"
    - path: "mesher/types/alert.mpl"
      provides: "AlertRule and Alert with deriving(Schema) and relationships"
      contains: "deriving(Schema"
    - path: "mesher/types/retention.mpl"
      provides: "RetentionSettings struct with table 'projects'"
      contains: "table \"projects\""
    - path: "mesher/migrations/20260216120000_create_initial_schema.mpl"
      provides: "Initial migration with all tables, indexes, and extensions"
      contains: "pub fn up"
  key_links:
    - from: "mesher/types/project.mpl"
      to: "Organization.__table__()"
      via: "deriving(Schema) with table option"
      pattern: "table \"organizations\""
    - from: "mesher/types/user.mpl"
      to: "Session.__primary_key__()"
      via: "deriving(Schema) with primary_key option"
      pattern: "primary_key :token"
    - from: "mesher/migrations/20260216120000_create_initial_schema.mpl"
      to: "Migration.create_table"
      via: "Migration DSL from Phase 101"
      pattern: "Migration\\.create_table"
---

<objective>
Convert all 11 Mesher type structs to use `deriving(Schema)` with correct schema options, table names, primary keys, and relationship declarations. Create a new RetentionSettings struct. Write the initial migration file to replace storage/schema.mpl's imperative DDL.

Purpose: Establishes the Schema metadata foundation that all subsequent ORM query conversions depend on. Migration file enables versioned schema management instead of imperative ensure_schema().
Output: 11 Schema-annotated structs across 6 type files, 1 new RetentionSettings type, 1 migration file, updated main.mpl to remove ensure_schema call.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/102-mesher-rewrite/102-RESEARCH.md
@mesher/types/project.mpl
@mesher/types/user.mpl
@mesher/types/event.mpl
@mesher/types/issue.mpl
@mesher/types/alert.mpl
@mesher/storage/schema.mpl
@mesher/main.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deriving(Schema) to all 11 type structs with schema options and relationships</name>
  <files>
    mesher/types/project.mpl
    mesher/types/user.mpl
    mesher/types/event.mpl
    mesher/types/issue.mpl
    mesher/types/alert.mpl
    mesher/types/retention.mpl
  </files>
  <action>
Convert all existing type structs from `deriving(Json, Row)` to `deriving(Schema, Json, Row)` and add schema options and relationship declarations. Create a new RetentionSettings struct in a new file.

**mesher/types/project.mpl** -- 3 structs:

Organization: Add `table "organizations"` and `has_many :projects, Project` and `has_many :org_memberships, OrgMembership`. Keep all existing fields. Change deriving to `deriving(Schema, Json, Row)`.

Project: Add `table "projects"`, `has_many :api_keys, ApiKey`, `has_many :issues, Issue`, `has_many :events, Event`, `has_many :alert_rules, AlertRule`, `has_many :alerts, Alert`, `belongs_to :org, Organization`. Keep all existing fields. Change deriving to `deriving(Schema, Json, Row)`.

ApiKey: Add `table "api_keys"`, `belongs_to :project, Project`. Keep all existing fields including `revoked_at :: Option<String>`. Change deriving to `deriving(Schema, Json, Row)`.

**mesher/types/user.mpl** -- 3 structs:

User: Add `table "users"`, `has_many :org_memberships, OrgMembership`, `has_many :sessions, Session`. Note: NO password_hash field exists in the struct (deliberately excluded). Change deriving to `deriving(Schema, Json, Row)`.

OrgMembership: Add `table "org_memberships"`, `belongs_to :user, User`, `belongs_to :org, Organization`. Change deriving to `deriving(Schema, Json, Row)`.

Session: Add `table "sessions"` and `primary_key :token` (CRITICAL -- Session's PK is token, not id). Add `belongs_to :user, User`. Change deriving to `deriving(Schema, Json, Row)`.

**mesher/types/event.mpl** -- 1 struct (Event only; EventPayload, StackFrame, ExceptionInfo, Breadcrumb, Severity stay as-is):

Event: Add `table "events"`, `belongs_to :project, Project`, `belongs_to :issue, Issue`. Change deriving to `deriving(Schema, Json, Row)`. Keep ALL existing String fields (exception, stacktrace, breadcrumbs, tags, extra, user_context, sdk_name, sdk_version).

**mesher/types/issue.mpl** -- 1 struct (Issue only; IssueStatus stays as-is):

Issue: Add `table "issues"`, `belongs_to :project, Project`, `has_many :events, Event`. Change deriving to `deriving(Schema, Json, Row)`. Note: `event_count :: Int` field -- Schema should handle this since Phase 97 maps Int to BIGINT. `assigned_to :: String` stays as-is.

**mesher/types/alert.mpl** -- 2 structs (AlertRule, Alert; AlertCondition stays as-is):

AlertRule: Add `table "alert_rules"`, `belongs_to :project, Project`, `has_many :alerts, Alert`. Note: `enabled :: Bool` field is fine -- Schema handles Bool. Change deriving to `deriving(Schema, Json, Row)`.

Alert: Add `table "alerts"`, `belongs_to :rule, AlertRule`, `belongs_to :project, Project`. Change deriving to `deriving(Schema, Json, Row)`.

**mesher/types/retention.mpl** -- NEW FILE:

Create a new file with:
```
# Retention and sampling settings -- virtual projection of the projects table.
# Used for settings-specific queries (get/update retention_days, sample_rate).

pub struct RetentionSettings do
  table "projects"
  retention_days :: String
  sample_rate :: String
end deriving(Schema, Json, Row)
```

Schema option syntax uses contextual identifiers INSIDE the struct body, before field declarations. Example from e2e tests:
```
struct User do
  table "people"
  primary_key :uuid
  timestamps true
  uuid :: String
  name :: String
end deriving(Schema)
```

Relationship declarations also go inside the struct body, typically after field declarations:
```
struct Post do
  id :: String
  user_id :: String
  belongs_to :user, User
end deriving(Schema)
```

IMPORTANT: Do NOT add `timestamps true` to any struct -- the existing structs already have explicit created_at fields (and some don't have updated_at). Adding timestamps would inject inserted_at/updated_at fields that conflict with existing created_at fields.

IMPORTANT: The `from` import at the top of project.mpl is NOT needed since the types are in the same module system. Only add forward references if the compiler requires them (it resolves types within the same build).
  </action>
  <verify>
Run `cargo build --release -p meshc 2>&1 | tail -20` to verify the compiler builds.
Then run `cd /Users/sn0w/Documents/dev/snow && cargo run --release -p meshc -- build mesher/ 2>&1 | tail -30` to verify all Mesher files compile with the new deriving(Schema) annotations. There should be no compilation errors from the type files.
  </verify>
  <done>
All 11 type structs (Organization, User, OrgMembership, Session, Project, ApiKey, Event, Issue, AlertRule, Alert, RetentionSettings) have `deriving(Schema, Json, Row)` with correct table names, primary keys, and relationship declarations. RetentionSettings exists as a new struct in mesher/types/retention.mpl. The Mesher project compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create initial migration file and update main.mpl</name>
  <files>
    mesher/migrations/20260216120000_create_initial_schema.mpl
    mesher/storage/schema.mpl
    mesher/main.mpl
  </files>
  <action>
Create the initial migration file that replaces storage/schema.mpl's `create_schema` function. The migration must create all 10 tables, the pgcrypto extension, all indexes (including partial and GIN indexes), and ALTER TABLE additions -- all in a single initial migration.

**Create `mesher/migrations/20260216120000_create_initial_schema.mpl`:**

Write `pub fn up(pool)` and `pub fn down(pool)` functions using the Migration DSL from Phase 101.

The `up` function must:
1. Create pgcrypto extension: `Pool.execute(pool, "CREATE EXTENSION IF NOT EXISTS pgcrypto", [])?`
2. Create tables in FK dependency order using `Migration.create_table(pool, table_name, column_specs)`:
   - organizations (id UUID PK, name TEXT NOT NULL, slug TEXT NOT NULL UNIQUE, created_at TIMESTAMPTZ NOT NULL DEFAULT now())
   - users (id UUID PK, email TEXT NOT NULL UNIQUE, password_hash TEXT NOT NULL, display_name TEXT NOT NULL, created_at TIMESTAMPTZ NOT NULL DEFAULT now())
   - org_memberships (id UUID PK, user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE, org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, role TEXT NOT NULL DEFAULT 'member', joined_at TIMESTAMPTZ NOT NULL DEFAULT now(), UNIQUE(user_id, org_id))
   - sessions (token TEXT PRIMARY KEY, user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE, created_at TIMESTAMPTZ NOT NULL DEFAULT now(), expires_at TIMESTAMPTZ NOT NULL DEFAULT now() + interval '7 days')
   - projects (id UUID PK, org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, name TEXT NOT NULL, platform TEXT, slug TEXT, retention_days INTEGER NOT NULL DEFAULT 90, sample_rate REAL NOT NULL DEFAULT 1.0, created_at TIMESTAMPTZ NOT NULL DEFAULT now())
   - api_keys (id UUID PK, project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE, key_value TEXT NOT NULL UNIQUE, label TEXT NOT NULL DEFAULT 'default', created_at TIMESTAMPTZ NOT NULL DEFAULT now(), revoked_at TIMESTAMPTZ)
   - issues (id UUID PK, project_id UUID NOT NULL, fingerprint TEXT NOT NULL, title TEXT NOT NULL, level TEXT NOT NULL, status TEXT NOT NULL DEFAULT 'unresolved', event_count INTEGER NOT NULL DEFAULT 0, first_seen TIMESTAMPTZ NOT NULL DEFAULT now(), last_seen TIMESTAMPTZ NOT NULL DEFAULT now(), assigned_to UUID REFERENCES users(id), UNIQUE(project_id, fingerprint))
   - events (PARTITIONED -- use raw Pool.execute since Migration DSL may not support PARTITION BY RANGE)
   - alert_rules (id UUID PK, project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE, name TEXT NOT NULL, condition_json JSONB NOT NULL, action_json JSONB NOT NULL, enabled BOOLEAN NOT NULL DEFAULT true, cooldown_minutes INTEGER NOT NULL DEFAULT 60, last_fired_at TIMESTAMPTZ, created_at TIMESTAMPTZ NOT NULL DEFAULT now())
   - alerts (id UUID PK, rule_id UUID NOT NULL REFERENCES alert_rules(id) ON DELETE CASCADE, project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE, status TEXT NOT NULL DEFAULT 'active', message TEXT NOT NULL, condition_snapshot JSONB NOT NULL, triggered_at TIMESTAMPTZ NOT NULL DEFAULT now(), acknowledged_at TIMESTAMPTZ, resolved_at TIMESTAMPTZ)

   NOTE: The `projects` table includes slug, retention_days, and sample_rate columns (which were ALTER TABLE additions in the old schema.mpl) in the initial CREATE TABLE -- since this is a fresh migration, include the CURRENT desired state.

   NOTE: For the `events` table, use `Pool.execute` with the full CREATE TABLE ... PARTITION BY RANGE(received_at) SQL since Migration.create_table does not support partitioning.

   NOTE: For tables with complex constraints (UNIQUE composites, REFERENCES with ON DELETE CASCADE), check if Migration.create_table column spec format supports these. Column specs use "name:TYPE:CONSTRAINTS" format (e.g., "user_id:UUID:NOT NULL REFERENCES users(id) ON DELETE CASCADE"). If this doesn't work, fall back to raw `Pool.execute` for that table.

3. Create all indexes using `Migration.create_index(pool, table, name, columns, options)` where possible, falling back to `Pool.execute` for:
   - Partial indexes: `WHERE revoked_at IS NULL`, `WHERE enabled = true`, `WHERE slug IS NOT NULL`
   - GIN indexes: `USING GIN(tags jsonb_path_ops)`
   - Composite indexes with ordering: `(project_id, last_seen DESC)`

   Full index list from schema.mpl:
   - idx_projects_slug (UNIQUE, partial WHERE slug IS NOT NULL)
   - idx_org_memberships_user (user_id)
   - idx_org_memberships_org (org_id)
   - idx_sessions_user (user_id)
   - idx_sessions_expires (expires_at)
   - idx_projects_org (org_id)
   - idx_api_keys_project (project_id)
   - idx_api_keys_value (key_value, partial WHERE revoked_at IS NULL)
   - idx_issues_project_status (project_id, status)
   - idx_issues_project_last_seen (project_id, last_seen DESC)
   - idx_events_project_received (project_id, received_at DESC)
   - idx_events_issue_received (issue_id, received_at DESC)
   - idx_events_level (level, received_at DESC)
   - idx_events_fingerprint (fingerprint)
   - idx_events_tags (GIN tags jsonb_path_ops)
   - idx_alert_rules_project (project_id, partial WHERE enabled = true)
   - idx_alerts_project_status (project_id, status)
   - idx_alerts_rule (rule_id)
   - idx_alerts_triggered (triggered_at DESC)

4. Return `Ok(0)` on success.

The `down` function must drop tables in reverse FK dependency order using `Migration.drop_table`.

**Update `mesher/storage/schema.mpl`:**
Remove the `create_schema` function entirely. Keep ONLY the partition-related functions: `create_partition`, `create_partitions_loop`, and `create_partitions_ahead`. These are NOT DDL schema management -- they are runtime partition creation that must remain callable.

Update the module comment to reflect that schema DDL is now managed by migration files.

**Update `mesher/main.mpl`:**
- Remove the `create_schema` import: `from Storage.Schema import create_schema, create_partitions_ahead` becomes `from Storage.Schema import create_partitions_ahead`
- Remove the `create_schema(pool)` call and its result handling in `start_services`
- The partition creation call `create_partitions_ahead(pool, 7)` stays -- partitions are runtime operations, not schema migrations
- Add a comment noting that schema is managed by `meshc migrate up` run before starting the application
  </action>
  <verify>
Run `cargo run --release -p meshc -- build mesher/ 2>&1 | tail -30` to verify the Mesher project compiles after schema.mpl and main.mpl changes.
Verify the migration file exists: `ls -la mesher/migrations/20260216120000_create_initial_schema.mpl`
Verify the migration file has both up and down functions: `grep -c 'pub fn' mesher/migrations/20260216120000_create_initial_schema.mpl`
  </verify>
  <done>
Migration file mesher/migrations/20260216120000_create_initial_schema.mpl exists with up/down functions creating all 10 tables, pgcrypto extension, and all 19 indexes. storage/schema.mpl retains only partition functions. main.mpl no longer calls create_schema. The Mesher project compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `cargo run --release -p meshc -- build mesher/ 2>&1` compiles without errors
2. All 6 type files (project.mpl, user.mpl, event.mpl, issue.mpl, alert.mpl, retention.mpl) contain `deriving(Schema`
3. Session struct has `primary_key :token`
4. RetentionSettings struct has `table "projects"`
5. Migration file has `pub fn up` and `pub fn down`
6. main.mpl does NOT import or call `create_schema`
7. storage/schema.mpl retains partition functions only
</verification>

<success_criteria>
- All 11 Mesher type structs compile with `deriving(Schema, Json, Row)`
- Schema metadata is correct: table names match DB tables, primary keys correct, relationships declared
- Initial migration file covers all tables, indexes, and extensions
- main.mpl startup no longer runs imperative DDL
- Zero compilation errors in Mesher project
</success_criteria>

<output>
After completion, create `.planning/phases/102-mesher-rewrite/102-01-SUMMARY.md`
</output>
