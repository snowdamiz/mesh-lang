---
phase: 87.2-refactor-phase-87-code-to-use-cross-module-services
plan: 02
type: execute
wave: 2
depends_on: ["87.2-01"]
files_modified:
  - mesher/services/writer.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "StorageWriter service is defined in services/writer.mpl and importable from Services.Writer"
    - "WriterState struct, buffer helpers, and flush/retry logic are co-located with StorageWriter in services/writer.mpl"
    - "flush_ticker actor is co-located with StorageWriter in services/writer.mpl"
    - "flush_loop uses ? operator instead of explicit case/match for insert_event"
    - "main.mpl contains only imports, start_services, and main (~50-70 lines)"
    - "meshc build mesher/ compiles without errors"
  artifacts:
    - path: "mesher/services/writer.mpl"
      provides: "StorageWriter service + WriterState + buffer/flush/retry logic + flush_ticker actor"
      contains: "service StorageWriter"
    - path: "mesher/main.mpl"
      provides: "Entry point with imports, start_services, and main"
      contains: "from Services.Writer import StorageWriter"
  key_links:
    - from: "mesher/services/writer.mpl"
      to: "mesher/storage/writer.mpl"
      via: "from Storage.Writer import insert_event"
      pattern: "from Storage.Writer import insert_event"
    - from: "mesher/main.mpl"
      to: "mesher/services/writer.mpl"
      via: "from Services.Writer import StorageWriter"
      pattern: "from Services.Writer import StorageWriter"
    - from: "mesher/main.mpl"
      to: "mesher/services/org.mpl"
      via: "from Services.Org import OrgService"
      pattern: "from Services.Org import OrgService"
---

<objective>
Extract StorageWriter, WriterState, all buffer/flush/retry logic, and flush_ticker actor from main.mpl into services/writer.mpl. Apply the ? operator in flush_loop. Slim main.mpl down to an entry-point-only module.

Purpose: Complete the refactoring by moving the most complex service (StorageWriter with its 6 helper functions, struct, and ticker actor) into its own module. Apply the ? operator fix from Phase 87.1-01 to simplify flush_loop. The result is a clean separation of concerns: main.mpl orchestrates, service modules implement.

Output: New services/writer.mpl + final lean main.mpl (~50-70 lines).
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/87.2-refactor-phase-87-code-to-use-cross-module-services/87.2-RESEARCH.md
@.planning/phases/87.2-refactor-phase-87-code-to-use-cross-module-services/87.2-01-SUMMARY.md
@mesher/main.mpl
@mesher/storage/writer.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StorageWriter service module with all buffer/flush logic</name>
  <files>mesher/services/writer.mpl</files>
  <action>
Create `mesher/services/writer.mpl` (module: Services.Writer) by extracting from main.mpl:

**Imports:**
- `from Storage.Writer import insert_event`

**Struct (move verbatim):**
- WriterState struct (main.mpl lines 25-32) with fields: pool, project_id, buffer, buffer_len, batch_size, max_buffer

**Batch flush functions (move in order, apply ? operator to flush_loop):**

1. `flush_loop` -- Move from main.mpl but APPLY ? OPERATOR:
   ```mesh
   fn flush_loop(pool :: PoolHandle, project_id :: String, events, i :: Int, total :: Int) -> Int!String do
     if i < total do
       let event_json = List.get(events, i)
       insert_event(pool, project_id, event_json)?
       flush_loop(pool, project_id, events, i + 1, total)
     else
       Ok(0)
     end
   end
   ```
   This replaces the explicit `let r = insert_event(...)` + `case r do Ok(_) -> ... | Err(_) -> Err("flush failed") end` pattern with the `?` operator. The error message changes from "flush failed" to the original insert_event error, which is acceptable (and more informative).

2. `flush_batch` -- Move verbatim
3. `flush_drop` -- Move verbatim
4. `flush_retry3` -- Move verbatim (KEEP explicit case -- Err branch calls retry logic, not propagation)
5. `flush_retry2` -- Move verbatim (KEEP explicit case -- same reason)
6. `flush_with_retry` -- Move verbatim (KEEP explicit case -- same reason)

**Buffer management helpers (move verbatim):**
7. `writer_store` -- Move verbatim
8. `writer_flush` -- Move verbatim

**Service definition (move verbatim):**
- StorageWriter service with init, Store cast, Flush cast

**Actor (move verbatim):**
- flush_ticker actor -- MUST be in same module as StorageWriter because it calls `StorageWriter.flush(writer_pid)`. Co-locating avoids the untested cross-module actor-to-service reference pattern.

The file should follow this top-to-bottom order: imports, WriterState struct, flush functions, buffer helpers, service definition, flush_ticker actor. Add a module-level comment explaining this is the per-project batch writer with bounded buffer and dual flush triggers.

Do NOT add `pub` to any functions -- only insert_event (in Storage.Writer) needs pub. The functions in this module are internal helpers used only by the service itself.

Do NOT add `pub` before `service` -- services export by default.
  </action>
  <verify>File exists at mesher/services/writer.mpl. Contains WriterState struct, 8 functions (flush_loop through writer_flush), StorageWriter service, and flush_ticker actor. flush_loop uses `?` operator (no explicit case block for insert_event result).</verify>
  <done>services/writer.mpl contains the complete StorageWriter module: struct, 8 helper functions, service definition, and flush_ticker actor. flush_loop uses ? operator for insert_event.</done>
</task>

<task type="auto">
  <name>Task 2: Slim main.mpl to entry-point-only module</name>
  <files>mesher/main.mpl</files>
  <action>
Rewrite main.mpl to contain ONLY: service imports, start_services, and main. Remove everything that was extracted to services/writer.mpl.

**Final main.mpl content should be approximately:**

```mesh
# Mesher monitoring platform entry point.
# Connects to PostgreSQL, creates schema and partitions, starts all services.
# Services are defined in mesher/services/ modules.

from Storage.Schema import create_schema, create_partitions_ahead
from Services.Org import OrgService
from Services.Project import ProjectService
from Services.User import UserService
from Services.Writer import StorageWriter

fn start_services(pool :: PoolHandle) do
  # Run schema creation (idempotent -- all CREATE IF NOT EXISTS)
  let schema_result = create_schema(pool)
  case schema_result do
    Ok(_) -> println("[Mesher] Schema created/verified")
    Err(_) -> println("[Mesher] Schema error")
  end

  # Create initial partitions (7 days ahead)
  let partition_result = create_partitions_ahead(pool, 7)
  case partition_result do
    Ok(_) -> println("[Mesher] Partitions created (7 days ahead)")
    Err(_) -> println("[Mesher] Partition error")
  end

  # Start services
  let org_svc = OrgService.start(pool)
  println("[Mesher] OrgService started")

  let project_svc = ProjectService.start(pool)
  println("[Mesher] ProjectService started")

  let user_svc = UserService.start(pool)
  println("[Mesher] UserService started")

  println("[Mesher] Foundation ready")

  # Keep the main process alive (services run as actors).
  # In Phase 88, this will be replaced by HTTP.serve which blocks.
  Timer.sleep(999999999)
end

fn main() do
  println("[Mesher] Connecting to PostgreSQL...")
  let pool_result = Pool.open("postgres://mesh:mesh@localhost:5432/mesher", 2, 10, 5000)
  case pool_result do
    Ok(pool) -> start_services(pool)
    Err(_) -> println("[Mesher] Failed to connect to PostgreSQL")
  end
end
```

**Key changes from Plan 01 state:**
- Remove `from Storage.Writer import insert_event` (now imported by services/writer.mpl)
- Remove WriterState struct
- Remove ALL flush/retry/buffer functions (flush_loop, flush_batch, flush_drop, flush_retry3, flush_retry2, flush_with_retry, writer_store, writer_flush)
- Remove StorageWriter service definition
- Remove flush_ticker actor
- Add `from Services.Writer import StorageWriter`
- Update the header comment to reference services/ modules

**KEEP start_services and main exactly as they are** -- the case blocks in start_services and main do NOT return Result, so ? operator cannot be used there.

Note: start_services currently does NOT start StorageWriter (it is started per-project in Phase 88 ingestion pipeline). The import of StorageWriter is for future use and to verify cross-module service import works.

Run `meshc build mesher/` (or `cargo run --release -p meshc -- build mesher/`) to verify compilation succeeds.
  </action>
  <verify>`meshc build mesher/` compiles without errors. main.mpl is approximately 50-70 lines. main.mpl does NOT contain WriterState, StorageWriter, flush_ticker, flush_loop, or any buffer management code. main.mpl imports from Services.Org, Services.Project, Services.User, and Services.Writer.</verify>
  <done>main.mpl is a lean entry-point module (~50-70 lines) that imports all 4 services from their dedicated modules. All service logic lives in mesher/services/. meshc build mesher/ compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `meshc build mesher/` compiles without errors
2. `mesher/services/writer.mpl` contains `service StorageWriter`, WriterState struct, flush_ticker actor, and all 8 helper functions
3. `mesher/services/writer.mpl` contains `insert_event(pool, project_id, event_json)?` in flush_loop (? operator, no explicit case)
4. `mesher/main.mpl` is ~50-70 lines containing only imports, start_services, and main
5. `mesher/main.mpl` contains `from Services.Writer import StorageWriter`
6. `mesher/main.mpl` does NOT contain WriterState, StorageWriter service, flush_ticker, or any flush/buffer functions
7. All 4 service modules exist: services/org.mpl, services/project.mpl, services/user.mpl, services/writer.mpl
8. No behavior change in any service handler (same call/cast APIs, same return types)
</verification>

<success_criteria>
- services/writer.mpl created with complete StorageWriter module (~120 lines)
- main.mpl reduced to ~50-70 lines (entry point only)
- ? operator applied in flush_loop (1 case block simplified)
- meshc build mesher/ compiles successfully
- Total mesher/ line count unchanged (code moved, not deleted or added)
</success_criteria>

<output>
After completion, create `.planning/phases/87.2-refactor-phase-87-code-to-use-cross-module-services/87.2-02-SUMMARY.md`
</output>
