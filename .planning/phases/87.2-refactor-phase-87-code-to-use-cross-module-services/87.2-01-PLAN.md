---
phase: 87.2-refactor-phase-87-code-to-use-cross-module-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mesher/services/org.mpl
  - mesher/services/project.mpl
  - mesher/services/user.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "OrgService is defined in services/org.mpl and importable from Services.Org"
    - "ProjectService is defined in services/project.mpl and importable from Services.Project"
    - "UserService + login_user helper is defined in services/user.mpl and importable from Services.User"
    - "main.mpl imports services from their new module locations instead of defining them inline"
    - "meshc build mesher/ compiles without errors"
  artifacts:
    - path: "mesher/services/org.mpl"
      provides: "OrgService with 3 call handlers (CreateOrg, GetOrg, ListOrgs)"
      contains: "service OrgService"
    - path: "mesher/services/project.mpl"
      provides: "ProjectService with 6 call handlers"
      contains: "service ProjectService"
    - path: "mesher/services/user.mpl"
      provides: "UserService with 7 call handlers + login_user helper"
      contains: "service UserService"
    - path: "mesher/main.mpl"
      provides: "Entry point importing all 4 services"
      contains: "from Services.Org import OrgService"
  key_links:
    - from: "mesher/services/org.mpl"
      to: "mesher/storage/queries.mpl"
      via: "from Storage.Queries import"
      pattern: "from Storage.Queries import"
    - from: "mesher/services/user.mpl"
      to: "mesher/storage/queries.mpl"
      via: "from Storage.Queries import"
      pattern: "from Storage.Queries import"
    - from: "mesher/main.mpl"
      to: "mesher/services/org.mpl"
      via: "from Services.Org import OrgService"
      pattern: "from Services.Org import OrgService"
---

<objective>
Extract OrgService, ProjectService, and UserService from main.mpl into dedicated module files under mesher/services/.

Purpose: Remove the "all services in main.mpl" workaround from Phase 87. Cross-module service export is now supported (fixed in Phase 87.1-02). Each service gets its own module with proper imports, following the established Mesh module naming convention (file path -> PascalCase module name).

Output: 3 new service module files + updated main.mpl with service definitions removed and imports added.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/87.2-refactor-phase-87-code-to-use-cross-module-services/87.2-RESEARCH.md
@mesher/main.mpl
@mesher/storage/queries.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OrgService and ProjectService module files</name>
  <files>mesher/services/org.mpl, mesher/services/project.mpl</files>
  <action>
Create two new module files by extracting service definitions from main.mpl:

**mesher/services/org.mpl** (module: Services.Org):
- Add imports: `from Storage.Queries import insert_org, get_org, list_orgs`
- Add import: `from Types.Project import Organization`
- Copy the OrgService definition (main.mpl lines 131-150) verbatim -- 3 call handlers (CreateOrg, GetOrg, ListOrgs)
- Do NOT add `pub` prefix to `service` -- services export by default (decision 87.1-02)
- Do NOT import PoolHandle -- it is a builtin type

**mesher/services/project.mpl** (module: Services.Project):
- Add imports: `from Storage.Queries import insert_project, get_project, list_projects_by_org, create_api_key, get_project_by_api_key, revoke_api_key`
- Add import: `from Types.Project import Project`
- Copy the ProjectService definition (main.mpl lines 155-189) verbatim -- 6 call handlers (CreateProject, GetProject, ListProjectsByOrg, CreateApiKey, GetProjectByApiKey, RevokeApiKey)

Both files follow the exact same pattern already proven in E2E test `e2e_cross_module_service`. Service handler bodies remain UNCHANGED -- they delegate to query functions.
  </action>
  <verify>Both files exist with correct service definitions. Verify file names match expected module paths: `services/org.mpl` -> `Services.Org`, `services/project.mpl` -> `Services.Project`.</verify>
  <done>OrgService in services/org.mpl with 3 call handlers, ProjectService in services/project.mpl with 6 call handlers, both with correct imports from Storage.Queries and Types.Project.</done>
</task>

<task type="auto">
  <name>Task 2: Create UserService module and update main.mpl imports</name>
  <files>mesher/services/user.mpl, mesher/main.mpl</files>
  <action>
**mesher/services/user.mpl** (module: Services.User):
- Add imports: `from Storage.Queries import create_user, authenticate_user, get_user, create_session, validate_session, delete_session, add_member, get_members`
- Add imports: `from Types.User import User, Session, OrgMembership`
- Copy the `login_user` helper function (main.mpl lines 38-44) -- this is a standalone function used by UserService.Login handler. It uses explicit case matching for custom error message ("authentication failed") instead of ? operator. Keep it exactly as-is.
- Copy the UserService definition (main.mpl lines 195-234) verbatim -- 7 call handlers (Register, Login, ValidateSession, Logout, GetUser, AddMember, GetMembers)

**mesher/main.mpl** (update imports, remove extracted services):
- Remove the large import line for Storage.Queries (line 17) -- individual service modules now import what they need
- Remove the Types.Project and Types.User imports (lines 19-20) -- service modules import these
- KEEP: `from Storage.Schema import create_schema, create_partitions_ahead` (still used by start_services)
- KEEP: `from Storage.Writer import insert_event` (still used by StorageWriter which remains in main.mpl for now)
- Add new imports for the extracted services:
  ```
  from Services.Org import OrgService
  from Services.Project import ProjectService
  from Services.User import UserService
  ```
- Remove the OrgService definition (lines 131-150)
- Remove the ProjectService definition (lines 155-189)
- Remove the UserService definition (lines 195-234)
- Remove the login_user helper function (lines 38-44)
- KEEP everything else (WriterState, flush/retry logic, buffer helpers, StorageWriter, flush_ticker, start_services, main) -- these will be extracted in Plan 02

After this task, main.mpl should contain: WriterState struct, all flush/retry/buffer functions, StorageWriter service, flush_ticker actor, start_services, and main. The 3 entity services are now in separate files.

Run `meshc build mesher/` (or `cargo run --release -p meshc -- build mesher/`) to verify compilation succeeds.
  </action>
  <verify>`meshc build mesher/` (or equivalent cargo command) compiles without errors. main.mpl no longer contains OrgService, ProjectService, or UserService definitions. The 3 service module files exist and are syntactically correct.</verify>
  <done>UserService + login_user in services/user.mpl with 7 call handlers. main.mpl updated to import OrgService, ProjectService, UserService from their new modules. All 3 extracted services importable cross-module. Project compiles cleanly with meshc.</done>
</task>

</tasks>

<verification>
1. `meshc build mesher/` compiles without errors
2. `mesher/services/org.mpl` contains `service OrgService` with 3 call handlers
3. `mesher/services/project.mpl` contains `service ProjectService` with 6 call handlers
4. `mesher/services/user.mpl` contains `service UserService` with 7 call handlers and `login_user` function
5. `mesher/main.mpl` contains `from Services.Org import OrgService`, `from Services.Project import ProjectService`, `from Services.User import UserService`
6. `mesher/main.mpl` does NOT contain `service OrgService`, `service ProjectService`, or `service UserService`
7. `mesher/main.mpl` still contains WriterState, StorageWriter, flush_ticker, start_services, main (preserved for Plan 02)
</verification>

<success_criteria>
- 3 new service module files created under mesher/services/
- main.mpl reduced from ~321 lines to ~170 lines (entity services removed, writer logic preserved)
- meshc build mesher/ compiles successfully
- No behavior change -- service APIs (handler names, parameter types, return types) are identical
</success_criteria>

<output>
After completion, create `.planning/phases/87.2-refactor-phase-87-code-to-use-cross-module-services/87.2-01-SUMMARY.md`
</output>
