---
phase: 87.2-refactor-phase-87-code-to-use-cross-module-services
plan: 01
subsystem: services
tags: [mesh, cross-module-services, refactoring, service-extraction]

# Dependency graph
requires:
  - phase: 87.1-02
    provides: "Cross-module service export/import, normalized TyVar IDs"
  - phase: 87-02
    provides: "Original OrgService, ProjectService, UserService definitions in main.mpl"
provides:
  - "OrgService in dedicated module mesher/services/org.mpl"
  - "ProjectService in dedicated module mesher/services/project.mpl"
  - "UserService + login_user in dedicated module mesher/services/user.mpl"
  - "main.mpl updated with cross-module service imports"
affects: [87.2-02, 88-ingestion-pipeline]

# Tech tracking
tech-stack:
  added: []
  patterns: ["cross-module service import via from Services.X import XService"]

key-files:
  created:
    - mesher/services/org.mpl
    - mesher/services/project.mpl
    - mesher/services/user.mpl
  modified:
    - mesher/main.mpl

key-decisions:
  - "Keep service handler bodies unchanged -- pure mechanical extraction"
  - "Service modules only depend on Storage.Queries and Types.*, never on each other"

patterns-established:
  - "Service module convention: mesher/services/X.mpl -> from Services.X import XService"
  - "Services import their own query dependencies rather than main.mpl importing everything"

# Metrics
duration: 3min
completed: 2026-02-15
---

# Phase 87.2 Plan 01: Extract Entity Services Summary

**OrgService, ProjectService, and UserService extracted from main.mpl into dedicated cross-module service files under mesher/services/**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-15T00:45:40Z
- **Completed:** 2026-02-15T00:48:21Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Extracted 3 entity services from main.mpl into dedicated module files (org.mpl, project.mpl, user.mpl)
- main.mpl reduced from 321 to 190 lines (131 lines removed -- all service definitions and unused imports)
- Cross-module service import verified: `from Services.Org import OrgService` pattern compiles and works
- meshc build mesher/ compiles successfully with no errors

## Task Commits

Each task was committed atomically:

1. **Task 1: Create OrgService and ProjectService module files** - `33f603b1` (feat)
2. **Task 2: Create UserService module and update main.mpl imports** - `c0548a39` (feat)

## Files Created/Modified
- `mesher/services/org.mpl` - OrgService with 3 call handlers (CreateOrg, GetOrg, ListOrgs)
- `mesher/services/project.mpl` - ProjectService with 6 call handlers (CreateProject, GetProject, ListProjectsByOrg, CreateApiKey, GetProjectByApiKey, RevokeApiKey)
- `mesher/services/user.mpl` - UserService with 7 call handlers (Register, Login, ValidateSession, Logout, GetUser, AddMember, GetMembers) + login_user helper
- `mesher/main.mpl` - Updated imports, removed inline service definitions, kept StorageWriter + entry point

## Decisions Made
- Kept service handler bodies unchanged -- pure mechanical extraction, no logic changes
- Service modules only depend on Storage.Queries and Types.*, never on each other (flat hierarchy)
- login_user helper moved alongside UserService since it is only used by UserService.Login handler

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- StorageWriter, WriterState, flush/retry logic, flush_ticker actor, and buffer helpers remain in main.mpl -- ready for Plan 02 extraction
- main.mpl is now 190 lines, with clear separation between writer logic (to be extracted) and entry point (to remain)
- All 3 entity service modules compile and import correctly

## Self-Check: PASSED

All artifacts verified:
- mesher/services/org.mpl: FOUND
- mesher/services/project.mpl: FOUND
- mesher/services/user.mpl: FOUND
- Commit 33f603b1 (Task 1): FOUND
- Commit c0548a39 (Task 2): FOUND

---
*Phase: 87.2-refactor-phase-87-code-to-use-cross-module-services*
*Completed: 2026-02-15*
