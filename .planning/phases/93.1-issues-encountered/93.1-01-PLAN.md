---
phase: 93.1-issues-encountered
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mesher/api/detail.mpl
  - mesher/api/team.mpl
  - mesher/main.mpl
autonomous: true

must_haves:
  truths:
    - "Mesher compiles with 0 errors (down from 7)"
    - "All API handler functions are reachable via HTTP router registration in main.mpl"
    - "No forward references remain in detail.mpl or team.mpl"
  artifacts:
    - path: "mesher/api/detail.mpl"
      provides: "Event detail handlers with correct leaf-first ordering"
      contains: "fn build_nav_response"
    - path: "mesher/api/team.mpl"
      provides: "Team membership and API key handlers with correct leaf-first ordering"
      contains: "fn check_user_id"
    - path: "mesher/main.mpl"
      provides: "Entry point with all handler registrations compiling cleanly"
      contains: "handle_top_issues"
  key_links:
    - from: "mesher/api/detail.mpl"
      to: "mesher/main.mpl"
      via: "from Api.Detail import handle_event_detail"
      pattern: "from Api\\.Detail import"
    - from: "mesher/api/team.mpl"
      to: "mesher/main.mpl"
      via: "from Api.Team import handle_list_members, ..."
      pattern: "from Api\\.Team import"
---

<objective>
Fix 7 compilation errors in Mesher caused by forward-reference violations in detail.mpl and team.mpl, plus a cascading type mismatch in main.mpl.

Purpose: Unblock Mesher compilation so Phase 94 (Multi-Node Clustering) can proceed. These are application-level Mesh code bugs (define-before-use violations), not compiler bugs.

Output: 0 compilation errors from `cargo run --release -- build mesher/`
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/93.1-issues-encountered/93.1-RESEARCH.md
@mesher/api/detail.mpl
@mesher/api/team.mpl
@mesher/main.mpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder functions in detail.mpl and team.mpl to fix forward references</name>
  <files>mesher/api/detail.mpl, mesher/api/team.mpl</files>
  <action>
Fix all define-before-use violations by reordering functions to leaf-first order. No logic changes -- only move function definitions.

**detail.mpl** (fixes 3 of 7 errors):

Current broken order:
```
fn add_navigation (line 62) -- calls build_nav_response (FORWARD REF)
fn build_nav_response (line 71)
fn build_event_response_from_rows (line 83)
pub fn handle_event_detail (line 100)
```

Correct leaf-first order (swap add_navigation and build_nav_response):
```
fn build_nav_response          -- leaf: calls only HTTP.response and build_detail_response (both defined above)
fn add_navigation              -- calls build_nav_response (now defined above)
fn build_event_response_from_rows  -- calls add_navigation (now defined above)
pub fn handle_event_detail     -- pub handler, last
```

Specifically: move the `build_nav_response` function (current lines 70-79, including its comment on line 70) to BEFORE the `add_navigation` function (current lines 59-68, including its comment on line 59). Keep the comment block "Helper: build response from navigation rows." with `build_nav_response`, and keep the comment "Helper: add navigation data..." with `add_navigation`.

**team.mpl** (fixes 3 of 7 errors):

Three forward-reference pairs need swapping. In each case, move the callee function ABOVE the caller:

1. `validate_add_member` (line 102) calls `check_user_id` (line 111) -- move `check_user_id` above `validate_add_member`
   - Move lines 110-117 (comment + fn check_user_id) to before line 101 (comment + fn validate_add_member)

2. `do_update_role` (line 122) calls `perform_role_update` (line 131) -- move `perform_role_update` above `do_update_role`
   - Move lines 130-137 (comment + fn perform_role_update) to before line 119 (section comment + fn do_update_role)

3. `do_create_key` (line 142) calls `perform_create_key` (line 151) -- move `perform_create_key` above `do_create_key`
   - Move lines 150-157 (comment + fn perform_create_key) to before line 139 (section comment + fn do_create_key)

After reordering, the team.mpl helper chain sections should be:

```
# --- Add member helper chain ---
fn do_add_member               -- calls add_member (imported)
fn add_member_with_role        -- calls do_add_member
fn check_user_id               -- calls add_member_with_role
fn validate_add_member         -- calls check_user_id

# --- Update member role helper chain ---
fn perform_role_update         -- calls update_member_role (imported)
fn do_update_role              -- calls perform_role_update

# --- Create API key helper chain ---
fn perform_create_key          -- calls create_api_key (imported)
fn do_create_key               -- calls perform_create_key
```

Do NOT change any function signatures, bodies, imports, or pub handlers. Only reorder the function definitions.
  </action>
  <verify>
Run `cargo run --release -- build mesher/ 2>&1 | grep "Error:"` and confirm either 0 errors or only the main.mpl type mismatch remains (1 error max).
  </verify>
  <done>detail.mpl has build_nav_response defined before add_navigation. team.mpl has check_user_id before validate_add_member, perform_role_update before do_update_role, perform_create_key before do_create_key.</done>
</task>

<task type="auto">
  <name>Task 2: Verify main.mpl cascading fix and apply fallback if needed</name>
  <files>mesher/main.mpl</files>
  <action>
After Task 1 reordering, compile with `cargo run --release -- build mesher/` and check if the main.mpl `handle_top_issues` type mismatch (error on lines 78-79) is resolved.

**If 0 errors:** No changes to main.mpl needed. The type mismatch was a cascading inference failure from the broken Api.Detail module.

**If the main.mpl error persists:** Open `mesher/api/dashboard.mpl` and add an explicit return type annotation to `handle_top_issues`:

Change: `pub fn handle_top_issues(request) do`
To: `pub fn handle_top_issues(request) -> Response do`

This forces the type checker to use the declared return type instead of inferring from the function body.

After either path, run a final compilation and confirm 0 errors.
  </action>
  <verify>
Run `cargo run --release -- build mesher/ 2>&1 | grep -c "Error:"` and confirm output is `0`. Also run `cargo run --release -- build mesher/ 2>&1 | tail -5` to see the success message.
  </verify>
  <done>Mesher compiles with 0 errors. All 7 original errors are resolved.</done>
</task>

</tasks>

<verification>
1. `cargo run --release -- build mesher/` exits with 0 errors (was 7)
2. No function logic was changed -- only definition order in detail.mpl and team.mpl
3. All pub handler functions remain in place as the last functions in each file
4. If main.mpl was modified, only a return type annotation was added (no logic change)
</verification>

<success_criteria>
- `cargo run --release -- build mesher/` produces 0 compilation errors
- Error count reduced from 7 to 0
- All existing API routes remain functional (no logic changes, only reordering)
</success_criteria>

<output>
After completion, create `.planning/phases/93.1-issues-encountered/93.1-01-SUMMARY.md`
</output>
