---
phase: 62-rooms-channels
plan: 02
type: execute
wave: 2
depends_on: ["62-01"]
files_modified:
  - crates/snow-codegen/src/codegen/intrinsics.rs
  - crates/snow-codegen/src/mir/lower.rs
autonomous: true

must_haves:
  truths:
    - "Ws.join(conn, room) compiles from Snow source to snow_ws_join LLVM call"
    - "Ws.leave(conn, room) compiles from Snow source to snow_ws_leave LLVM call"
    - "Ws.broadcast(room, msg) compiles from Snow source to snow_ws_broadcast LLVM call"
    - "Ws.broadcast_except(room, msg, conn) compiles from Snow source to snow_ws_broadcast_except LLVM call"
  artifacts:
    - path: "crates/snow-codegen/src/codegen/intrinsics.rs"
      provides: "LLVM external function declarations for snow_ws_join, snow_ws_leave, snow_ws_broadcast, snow_ws_broadcast_except"
      contains: "snow_ws_join"
    - path: "crates/snow-codegen/src/mir/lower.rs"
      provides: "known_functions entries and map_builtin_name mappings for room functions"
      contains: "snow_ws_join"
  key_links:
    - from: "crates/snow-codegen/src/codegen/intrinsics.rs"
      to: "crates/snow-rt/src/ws/rooms.rs"
      via: "LLVM external function declarations matching extern C signatures"
      pattern: "snow_ws_join.*snow_ws_leave.*snow_ws_broadcast"
    - from: "crates/snow-codegen/src/mir/lower.rs"
      to: "crates/snow-codegen/src/codegen/intrinsics.rs"
      via: "known_functions type signatures matching LLVM declarations"
      pattern: "snow_ws_join.*MirType"
---

<objective>
Wire the four room functions through the codegen pipeline so Snow source can call Ws.join, Ws.leave, Ws.broadcast, and Ws.broadcast_except.

Purpose: Complete the Snow-level API by connecting source-level function calls to the runtime functions created in Plan 01. Without this wiring, the runtime functions exist but cannot be called from Snow programs.

Output: Updated `intrinsics.rs` with LLVM declarations and `lower.rs` with MIR type signatures and builtin name mappings.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-rooms-channels/62-RESEARCH.md
@.planning/phases/62-rooms-channels/62-01-SUMMARY.md
@crates/snow-codegen/src/codegen/intrinsics.rs
@crates/snow-codegen/src/mir/lower.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LLVM intrinsic declarations and MIR wiring for room functions</name>
  <files>crates/snow-codegen/src/codegen/intrinsics.rs, crates/snow-codegen/src/mir/lower.rs</files>
  <action>
**In `intrinsics.rs`** -- add four LLVM external function declarations after the existing `snow_ws_serve_tls` declaration (around line 440). Follow the exact same pattern:

```rust
// snow_ws_join(conn: ptr, room: ptr) -> i64
module.add_function("snow_ws_join", i64_type.fn_type(&[ptr_type.into(), ptr_type.into()], false), Some(inkwell::module::Linkage::External));

// snow_ws_leave(conn: ptr, room: ptr) -> i64
module.add_function("snow_ws_leave", i64_type.fn_type(&[ptr_type.into(), ptr_type.into()], false), Some(inkwell::module::Linkage::External));

// snow_ws_broadcast(room: ptr, msg: ptr) -> i64
module.add_function("snow_ws_broadcast", i64_type.fn_type(&[ptr_type.into(), ptr_type.into()], false), Some(inkwell::module::Linkage::External));

// snow_ws_broadcast_except(room: ptr, msg: ptr, except_conn: ptr) -> i64
module.add_function("snow_ws_broadcast_except", i64_type.fn_type(&[ptr_type.into(), ptr_type.into(), ptr_type.into()], false), Some(inkwell::module::Linkage::External));
```

**In `intrinsics.rs` test** (around line 1014 where existing ws assertions are) -- add four test assertions:
```rust
assert!(module.get_function("snow_ws_join").is_some());
assert!(module.get_function("snow_ws_leave").is_some());
assert!(module.get_function("snow_ws_broadcast").is_some());
assert!(module.get_function("snow_ws_broadcast_except").is_some());
```

**In `lower.rs` known_functions** (around line 684 after `snow_ws_serve_tls`) -- add four entries using MirType::Ptr for all SnowString pointer args (consistent with WS function family convention from Phase 60-02):

```rust
// snow_ws_join(conn: ptr, room: ptr) -> i64
self.known_functions.insert("snow_ws_join".to_string(), MirType::FnPtr(vec![MirType::Ptr, MirType::Ptr], Box::new(MirType::Int)));
// snow_ws_leave(conn: ptr, room: ptr) -> i64
self.known_functions.insert("snow_ws_leave".to_string(), MirType::FnPtr(vec![MirType::Ptr, MirType::Ptr], Box::new(MirType::Int)));
// snow_ws_broadcast(room: ptr, msg: ptr) -> i64
self.known_functions.insert("snow_ws_broadcast".to_string(), MirType::FnPtr(vec![MirType::Ptr, MirType::Ptr], Box::new(MirType::Int)));
// snow_ws_broadcast_except(room: ptr, msg: ptr, except_conn: ptr) -> i64
self.known_functions.insert("snow_ws_broadcast_except".to_string(), MirType::FnPtr(vec![MirType::Ptr, MirType::Ptr, MirType::Ptr], Box::new(MirType::Int)));
```

**In `lower.rs` map_builtin_name** (around line 9513 after `ws_serve_tls`) -- add four mappings:

```rust
"ws_join" => "snow_ws_join".to_string(),
"ws_leave" => "snow_ws_leave".to_string(),
"ws_broadcast" => "snow_ws_broadcast".to_string(),
"ws_broadcast_except" => "snow_ws_broadcast_except".to_string(),
```

"Ws" is already in STDLIB_MODULES -- no change needed there.

IMPORTANT: Use MirType::Ptr (not MirType::String) for all SnowString pointer arguments. This is the established WS function family convention from Phase 60-02 decision.
  </action>
  <verify>
Run `cargo test -p snow-codegen test_declare_intrinsics` -- must pass (verifies all LLVM declarations including the 4 new ones). Then run `cargo check --workspace` to verify full workspace compiles.
  </verify>
  <done>
Four LLVM declarations exist in intrinsics.rs with correct arg types. Four known_functions entries exist in lower.rs with MirType::Ptr convention. Four map_builtin_name entries connect ws_join/ws_leave/ws_broadcast/ws_broadcast_except to their snow_ runtime names. Intrinsics test passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full workspace build and run complete test suite</name>
  <files></files>
  <action>
Run the full workspace build and test suite to verify no regressions.

1. `cargo build --workspace` -- must succeed
2. `cargo test --workspace` -- all tests must pass (expect ~1515+ tests based on Phase 61 count, plus any new tests from Plan 01)
3. Verify the four new LLVM declarations exist by checking the intrinsics test output
4. Verify the linker can resolve all four symbols by checking that `cargo build --workspace` completes without undefined reference errors

If any test failures occur, they must be investigated and fixed before marking this task complete.
  </action>
  <verify>
`cargo test --workspace` exits with 0 failures. Output shows test count >= 1515.
  </verify>
  <done>
Full workspace builds and all tests pass. The room functions are fully wired from Snow source (Ws.join/Ws.leave/Ws.broadcast/Ws.broadcast_except) through the codegen pipeline to the runtime extern "C" functions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p snow-codegen test_declare_intrinsics` passes
2. `cargo test --workspace` -- all tests pass, 0 failures
3. intrinsics.rs contains 4 new LLVM declarations for room functions
4. lower.rs contains 4 new known_functions entries and 4 new map_builtin_name entries
5. All use MirType::Ptr for SnowString pointer args (consistent with WS convention)
</verification>

<success_criteria>
- Snow source `Ws.join(conn, room)` resolves through codegen to `snow_ws_join` runtime call
- Snow source `Ws.leave(conn, room)` resolves through codegen to `snow_ws_leave` runtime call
- Snow source `Ws.broadcast(room, msg)` resolves through codegen to `snow_ws_broadcast` runtime call
- Snow source `Ws.broadcast_except(room, msg, conn)` resolves through codegen to `snow_ws_broadcast_except` runtime call
- All LLVM declarations match the exact extern "C" signatures from rooms.rs
- Full workspace compiles and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/62-rooms-channels/62-02-SUMMARY.md`
</output>
