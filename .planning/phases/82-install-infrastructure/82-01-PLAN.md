---
phase: 82-install-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/release.yml
  - crates/meshc/Cargo.toml
  - crates/meshc/src/main.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Tag push (v*) triggers a build across all 6 targets and creates a GitHub Release with tarballs and SHA256SUMS"
    - "PR pushes build all 6 targets without creating a release"
    - "Each target builds natively on its platform runner (no cross-compilation)"
    - "LLVM 21 is statically linked so release binaries have zero LLVM runtime dependency"
    - "musl target uses mimalloc allocator for acceptable performance"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "CI pipeline for building meshc on 6 targets and creating GitHub Releases"
      contains: "strategy"
    - path: "crates/meshc/Cargo.toml"
      provides: "mimalloc dependency for musl target"
      contains: "mimalloc"
    - path: "crates/meshc/src/main.rs"
      provides: "Global allocator configuration for musl"
      contains: "global_allocator"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "GitHub Releases"
      via: "softprops/action-gh-release@v2"
      pattern: "softprops/action-gh-release"
    - from: ".github/workflows/release.yml"
      to: "LLVM_SYS_211_PREFIX"
      via: "Environment variable for llvm-sys crate"
      pattern: "LLVM_SYS_211_PREFIX"
---

<objective>
Create the GitHub Actions CI pipeline that builds meshc for all 6 targets (macOS x86_64/ARM64, Linux x86_64/ARM64/musl, Windows x86_64) and publishes GitHub Releases with versioned tarballs and checksums.

Purpose: This is the build infrastructure that produces the prebuilt binaries users download via the install script. Without it, there are no artifacts to install.
Output: `.github/workflows/release.yml` workflow file, mimalloc allocator for musl target
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-install-infrastructure/82-RESEARCH.md
@.planning/phases/82-install-infrastructure/82-CONTEXT.md
@Cargo.toml
@crates/meshc/Cargo.toml
@crates/meshc/src/main.rs
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mimalloc global allocator for musl target</name>
  <files>crates/meshc/Cargo.toml, crates/meshc/src/main.rs, Cargo.toml</files>
  <action>
Add mimalloc as the global allocator for the musl target to avoid musl's slow default allocator (up to 10x perf regression under multi-threaded workloads).

In `Cargo.toml` (workspace root), add to `[workspace.dependencies]`:
```
mimalloc = { version = "0.1", default-features = false }
```

In `crates/meshc/Cargo.toml`, add a target-specific dependency:
```
[target.'cfg(target_env = "musl")'.dependencies]
mimalloc = { workspace = true }
```

In `crates/meshc/src/main.rs`, add at the top of the file (before any other code, after any existing use statements):
```rust
#[cfg(target_env = "musl")]
#[global_allocator]
static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
```

This is a no-op on non-musl targets. The cfg guard ensures it only activates for musl builds.
  </action>
  <verify>Run `cargo check` to confirm the workspace builds cleanly with the new dependency. The mimalloc code path won't activate on the host (macOS/glibc Linux), but the cfg-guarded code must parse and type-check.</verify>
  <done>Workspace Cargo.toml has mimalloc in workspace deps, meshc Cargo.toml has target-specific musl dep, main.rs has cfg-guarded global_allocator static. `cargo check` passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions release workflow with 6-target matrix build</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` implementing a two-phase workflow (build matrix + release job).

**Triggers:**
- `push.branches: [main]` -- build all targets on every push to main (catch failures early; per user decision, PR pushes build all targets)
- `push.tags: ['v*']` -- build all targets AND create GitHub Release on tag push
- Use `pull_request` trigger as well so PRs also build all targets

**Permissions:**
- `contents: write` (needed for creating releases)

**Build job (`build`):**
Matrix with `fail-fast: false` and 6 entries:

| target | os | llvm_method | archive_ext |
|--------|-----|-------------|-------------|
| x86_64-apple-darwin | macos-15-intel | brew | tar.gz |
| aarch64-apple-darwin | macos-14 | brew | tar.gz |
| x86_64-unknown-linux-gnu | ubuntu-24.04 | tarball | tar.gz |
| aarch64-unknown-linux-gnu | ubuntu-24.04-arm | tarball | tar.gz |
| x86_64-unknown-linux-musl | ubuntu-24.04 | tarball | tar.gz |
| x86_64-pc-windows-msvc | windows-latest | tarball | zip |

Steps for each matrix entry:
1. `actions/checkout@v4`
2. Install LLVM 21 based on `matrix.llvm_method`:
   - **brew:** `brew install llvm@21` then set `LLVM_SYS_211_PREFIX=$(brew --prefix llvm@21)`
   - **tarball (Linux x86_64 targets):** Download `clang+llvm-21.1.8-x86_64-pc-linux-gnu.tar.xz` from `https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/`, extract to `$HOME/llvm`, set `LLVM_SYS_211_PREFIX=$HOME/llvm`
   - **tarball (Linux ARM64):** Download `clang+llvm-21.1.3-aarch64-linux-gnu.tar.xz` from `https://github.com/ycm-core/llvm/releases/download/21.1.3/`, extract to `$HOME/llvm`, set `LLVM_SYS_211_PREFIX=$HOME/llvm`
   - **tarball (Windows):** Download `clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz` from official LLVM releases, extract, set `LLVM_SYS_211_PREFIX`
   - For the musl target, also install `musl-tools`: `sudo apt-get install -y musl-tools`
3. `dtolnay/rust-toolchain@stable` with `targets: ${{ matrix.target }}`
4. `Swatinem/rust-cache@v2` with `key: ${{ matrix.target }}`
5. Build: `cargo build --release --target ${{ matrix.target }}` with env `LLVM_SYS_211_PREFIX`. Do NOT pass `--features inkwell/llvm21-1-force-static` on the cargo command line -- instead, the LLVM_SYS build script already prefers static linking when static libraries are available in the prefix directory. If static linking doesn't work by default, add the feature flag. The current workspace Cargo.toml uses `inkwell = { version = "0.8.0", features = ["llvm21-1"] }` which is sufficient.
6. Strip binary: `strip target/${{ matrix.target }}/release/meshc` (Linux/macOS). On Windows, skip stripping.
7. Package:
   - Extract version from tag (or use `dev` for non-tag builds): `VERSION=${GITHUB_REF_NAME#v}` (for tags) or `VERSION=dev`
   - For .tar.gz targets: `tar czf meshc-v${VERSION}-${TARGET}.tar.gz -C target/${TARGET}/release meshc`
   - For .zip (Windows): Use PowerShell `Compress-Archive` to create `meshc-v${VERSION}-${TARGET}.zip` containing `meshc.exe`
8. Upload artifact: `actions/upload-artifact@v4` with name `meshc-${{ matrix.target }}` uploading the archive file

**Release job (`release`):**
- `needs: build`
- `if: startsWith(github.ref, 'refs/tags/v')`
- `runs-on: ubuntu-latest`
- Steps:
  1. Download ALL build artifacts using `actions/download-artifact@v4` with `path: artifacts/` and `merge-multiple: true`
  2. Generate SHA256SUMS: `cd artifacts && sha256sum *.tar.gz *.zip > SHA256SUMS`
  3. Create release: `softprops/action-gh-release@v2` with `files: artifacts/*` and `generate_release_notes: false` (per user decision: no auto-generated release notes). Set `draft: false` and `prerelease: false`.

**Important implementation details:**
- For Windows LLVM install, use PowerShell to download and extract the tarball. Use `7z` (available on windows-latest) to extract `.tar.xz`. Set `LLVM_SYS_211_PREFIX` via `echo "LLVM_SYS_211_PREFIX=..." >> $env:GITHUB_ENV`.
- For Windows binary, the output is `meshc.exe` at `target/x86_64-pc-windows-msvc/release/meshc.exe`.
- Use `shell: bash` for Linux/macOS steps and `shell: pwsh` or default for Windows steps. Alternatively, use conditional steps with `if: runner.os == 'Windows'` / `if: runner.os != 'Windows'`.
- For the LLVM tarball downloads, verify the downloads succeed (curl with `-f` flag to fail on HTTP errors).
- Cache LLVM downloads using `actions/cache@v4` keyed on LLVM version + target to avoid re-downloading on every build.
  </action>
  <verify>Validate the YAML is well-formed: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`. Verify the file contains all 6 matrix targets, both build and release jobs, and uses the correct action versions.</verify>
  <done>`.github/workflows/release.yml` exists with: (1) triggers on push to main, PRs, and tag pushes; (2) build job with 6-target matrix using native runners; (3) LLVM 21 installation per platform; (4) cargo build with static LLVM; (5) binary stripping and packaging; (6) release job that creates GitHub Release with all artifacts + SHA256SUMS on tag push only.</done>
</task>

</tasks>

<verification>
1. `cargo check` passes (mimalloc dependency added correctly)
2. `.github/workflows/release.yml` is valid YAML
3. Workflow has all 6 targets in matrix: x86_64-apple-darwin, aarch64-apple-darwin, x86_64-unknown-linux-gnu, aarch64-unknown-linux-gnu, x86_64-unknown-linux-musl, x86_64-pc-windows-msvc
4. Build job uses native runners (macos-14, macos-15-intel, ubuntu-24.04, ubuntu-24.04-arm, windows-latest)
5. Release job has `if: startsWith(github.ref, 'refs/tags/v')` guard
6. SHA256SUMS generation step exists in release job
7. No auto-generated release notes (generate_release_notes: false)
</verification>

<success_criteria>
- GitHub Actions workflow file exists at .github/workflows/release.yml
- Workflow builds all 6 targets using native runners with LLVM 21 statically linked
- Tag pushes create GitHub Releases with .tar.gz/.zip artifacts and SHA256SUMS
- PR/main pushes build all targets without creating releases
- meshc Cargo.toml has mimalloc for musl target performance
</success_criteria>

<output>
After completion, create `.planning/phases/82-install-infrastructure/82-01-SUMMARY.md`
</output>
