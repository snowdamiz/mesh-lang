---
phase: 82-install-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - install/install.sh
  - install/install.ps1
  - website/docs/public/install.sh
  - website/docs/public/install.ps1
autonomous: true

must_haves:
  truths:
    - "POSIX install script detects platform (macOS/Linux) and architecture (x86_64/aarch64) including Rosetta detection"
    - "Install script downloads correct tarball from GitHub Releases and verifies SHA-256 checksum"
    - "Install script places binary at ~/.mesh/bin/meshc and configures PATH in bash, zsh, and fish profiles"
    - "Re-running install script skips if already up-to-date, updates if newer version available"
    - "Install script supports --version flag for pinning and --uninstall flag for cleanup"
    - "PowerShell install script installs meshc on Windows with persistent PATH configuration"
    - "Output is minimal with subtle colors, respects NO_COLOR, no interactive prompts"
  artifacts:
    - path: "install/install.sh"
      provides: "POSIX shell install script for macOS and Linux"
      contains: "detect_platform"
    - path: "install/install.ps1"
      provides: "PowerShell install script for Windows"
      contains: "mesh-lang"
    - path: "website/docs/public/install.sh"
      provides: "Install script served at mesh-lang.org/install.sh"
    - path: "website/docs/public/install.ps1"
      provides: "PowerShell script served at mesh-lang.org/install.ps1"
  key_links:
    - from: "install/install.sh"
      to: "GitHub Releases API"
      via: "curl to api.github.com/repos/.../releases/latest"
      pattern: "api.github.com.*releases"
    - from: "install/install.sh"
      to: "~/.mesh/bin/meshc"
      via: "tar extraction to install directory"
      pattern: "mesh/bin"
    - from: "install/install.sh"
      to: "shell profiles"
      via: "PATH configuration with marker comment"
      pattern: "Mesh compiler"
---

<objective>
Create the POSIX shell install script (install.sh) and PowerShell install script (install.ps1) that let users install meshc with a single command. The scripts handle platform detection, binary download from GitHub Releases, SHA-256 checksum verification, installation to ~/.mesh/bin, PATH configuration, version checking for updates, and uninstall.

Purpose: This is the user-facing installation experience. Without it, users cannot install meshc.
Output: `install/install.sh`, `install/install.ps1`, copies in `website/docs/public/` for serving via mesh-lang.org
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/82-install-infrastructure/82-RESEARCH.md
@.planning/phases/82-install-infrastructure/82-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create POSIX shell install script</name>
  <files>install/install.sh</files>
  <action>
Create `install/install.sh` -- a POSIX-compatible shell script for installing meshc on macOS and Linux.

**Structure:** Wrap everything in a `main()` function called at the end (prevents partial execution during `curl | sh`). Use `set -eu` at top.

**Constants:**
- `REPO="mesh-lang/mesh"` (GitHub repo)
- `INSTALL_DIR="$HOME/.mesh/bin"`
- `ENV_FILE="$HOME/.mesh/env"`
- `VERSION_FILE="$HOME/.mesh/version"`
- `MARKER="# Mesh compiler"`

**Argument parsing:**
Parse `--version VERSION`, `--yes` (for CI, though script is already non-interactive -- accept and ignore), `--uninstall`, and `--help`. Use a while loop with `case` on `$1`.

**Color output:**
Define color functions that respect `NO_COLOR` env var and detect if stdout is a terminal (for piped output). Use ANSI codes only when appropriate:
- `say()` -- normal message
- `say_green()` -- success (green)
- `say_red()` -- error (red, to stderr)
- `say_bold()` -- emphasis (bold)

**detect_platform():**
Use `uname -s` for OS and `uname -m` for architecture. Handle:
- Linux -> `unknown-linux-gnu` (not musl -- musl is for CI/Docker, users get glibc by default)
- Darwin -> `apple-darwin`
- MINGW/MSYS/CYGWIN -> tell user to use install.ps1 instead
- Rosetta detection: if Darwin and `uname -m` = x86_64, check `sysctl -n hw.optional.arm64 2>/dev/null` -- if returns "1", use aarch64
- x86_64/amd64 -> x86_64, aarch64/arm64 -> aarch64
- Return string like `aarch64-apple-darwin`

**get_latest_version():**
Use GitHub API: `curl -sSf https://api.github.com/repos/${REPO}/releases/latest | grep '"tag_name"' | sed 's/.*"v\(.*\)".*/\1/'`
Fallback: if `jq` is available, use it. But don't require it.

**check_update_needed():**
Read `$VERSION_FILE`. If current version equals target version, print "meshc vX.Y.Z is already installed and up-to-date." and exit 0. If different, print "Updating meshc from vX to vY...".

**download():**
Prefer `curl -sSfL`, fallback to `wget -qO-`. Detect which is available.

**verify_checksum():**
Download `SHA256SUMS` from the release. Extract the expected hash for the target archive. Use `sha256sum` (Linux) or `shasum -a 256` (macOS) to verify. If neither available, print warning and skip (don't fail).

**install():**
1. Determine version (from `--version` flag or latest)
2. Check if update needed (skip if same version)
3. Detect platform
4. Construct download URL: `https://github.com/${REPO}/releases/download/v${VERSION}/meshc-v${VERSION}-${PLATFORM}.tar.gz`
5. Create temp dir with `mktemp -d`
6. Download tarball to temp dir
7. Download SHA256SUMS to temp dir
8. Verify checksum
9. Extract: `tar xzf archive.tar.gz -C tempdir`
10. Create `$INSTALL_DIR` with `mkdir -p`
11. Move binary: `mv tempdir/meshc $INSTALL_DIR/meshc`
12. Make executable: `chmod +x $INSTALL_DIR/meshc`
13. On macOS: `xattr -d com.apple.quarantine $INSTALL_DIR/meshc 2>/dev/null || true`
14. Write version: `echo "$VERSION" > $VERSION_FILE`
15. Configure PATH (call configure_path)
16. Clean up temp dir
17. Print success: installed version and location, and tell user to restart shell or run `. $ENV_FILE`

**configure_path():**
Create `~/.mesh/env` file containing `export PATH="$HOME/.mesh/bin:$PATH"`.
Add `. "$HOME/.mesh/env"` to shell profiles with marker comment for idempotency:
- Bash: check `~/.bashrc` first, then `~/.bash_profile`. Only modify one.
- Zsh: modify `~/.zshrc` (create if user's SHELL is zsh and file doesn't exist yet)
- Fish: `fish_add_path $HOME/.mesh/bin` in `~/.config/fish/config.fish`
Check for marker before adding (idempotent).

**uninstall():**
Remove `~/.mesh/` directory entirely. Remove the marker line and source line from bash/zsh/fish profiles. Print "meshc has been uninstalled."

**Output style (per locked decisions):**
- Minimal: just what was installed, where, and the version
- Example success output:
  ```
  Installing meshc v0.2.0 (aarch64-apple-darwin)...
  Installed meshc v0.2.0 to ~/.mesh/bin/meshc
  Run 'meshc --version' to verify, or restart your shell.
  ```
- Example error: `error: Failed to download meshc v0.2.0 (HTTP 404). Check https://github.com/mesh-lang/mesh/releases for available versions.`
- No banner, no ASCII art, no progress bars (curl -s suppresses its own output)

The script must be POSIX sh compatible (no bash-isms like `[[ ]]`, arrays, `local -a`, etc.). Use `local` (widely supported but technically a bash-ism -- it's accepted by dash, ash, and all practical POSIX shells).
  </action>
  <verify>Run `shellcheck install/install.sh` (if shellcheck is available) to verify POSIX compliance and catch common shell scripting errors. Also verify: `sh -n install/install.sh` (syntax check). Check that the script contains all required functions: detect_platform, get_latest_version, check_update_needed, verify_checksum, configure_path, uninstall, main.</verify>
  <done>install/install.sh exists, is POSIX-compatible, handles all 4 platforms (macOS x86_64/ARM64, Linux x86_64/ARM64), includes Rosetta detection, checksum verification, PATH configuration for bash/zsh/fish, --version and --uninstall flags, NO_COLOR support, minimal output, and is wrapped in main() for curl|sh safety.</done>
</task>

<task type="auto">
  <name>Task 2: Create PowerShell install script and deploy to website</name>
  <files>install/install.ps1, website/docs/public/install.sh, website/docs/public/install.ps1</files>
  <action>
**Part A: Create `install/install.ps1`** -- PowerShell install script for Windows.

Usage: `powershell -ExecutionPolicy ByPass -c "irm https://mesh-lang.org/install.ps1 | iex"`

Implementation:
- `$ErrorActionPreference = 'Stop'`
- Constants: `$Repo = "mesh-lang/mesh"`, `$MeshHome = "$env:USERPROFILE\.mesh"`, `$BinDir = "$MeshHome\bin"`
- Detect architecture using `[System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture`. Only support X64. Error on ARM64/others.
- Parse arguments: `-Version` parameter for pinning, `-Uninstall` switch, `-Yes` switch (accept and ignore)
- Get latest version from GitHub API (Invoke-RestMethod)
- Check if already installed and up-to-date (read `$MeshHome\version` file)
- Download `.zip` archive: `meshc-v${Version}-x86_64-pc-windows-msvc.zip`
- Download SHA256SUMS, verify checksum using `Get-FileHash`
- Extract using `Expand-Archive` to temp directory
- Create `$BinDir`, move `meshc.exe` there
- Write version file
- Add `$BinDir` to user PATH via registry: `[Environment]::SetEnvironmentVariable("Path", "$BinDir;$CurrentPath", "User")` -- check if already present first
- Print success message with minimal output, respect `$env:NO_COLOR`
- Uninstall: remove `$MeshHome`, remove from PATH in registry

**Part B: Copy scripts to website public directory.**

Copy `install/install.sh` to `website/docs/public/install.sh` and `install/install.ps1` to `website/docs/public/install.ps1`. These will be served at `https://mesh-lang.org/install.sh` and `https://mesh-lang.org/install.ps1` via GitHub Pages (the deploy.yml workflow already deploys `website/docs/.vitepress/dist` which includes the `public/` directory contents at the root).

Note: The canonical source is `install/` in the repo root. The copies in `website/docs/public/` are for serving. In the future these could be symlinks, but for now direct copies are simpler and more portable.

**Output style (matching install.sh, per locked decisions):**
- Minimal: version, location, done
- Colors: use `Write-Host` with `-ForegroundColor Green/Red` but check `$env:NO_COLOR` first
- No interactive prompts
  </action>
  <verify>Verify PowerShell syntax: `pwsh -Command "& { \$ast = [System.Management.Automation.Language.Parser]::ParseFile('install/install.ps1', [ref]\$null, [ref]\$null) }"` (if pwsh available on macOS). Verify the website public copies exist and match: `diff install/install.sh website/docs/public/install.sh` and `diff install/install.ps1 website/docs/public/install.ps1`.</verify>
  <done>install/install.ps1 exists with Windows support (download, checksum verify, install, PATH config, --version, --uninstall). website/docs/public/install.sh and website/docs/public/install.ps1 exist as copies of the canonical scripts. Both scripts follow minimal output style with NO_COLOR support.</done>
</task>

</tasks>

<verification>
1. `install/install.sh` passes `sh -n` syntax check
2. `install/install.sh` contains detect_platform, verify_checksum, configure_path, main functions
3. `install/install.sh` handles --version, --uninstall, --yes flags
4. `install/install.sh` handles Rosetta detection (sysctl hw.optional.arm64)
5. `install/install.sh` respects NO_COLOR environment variable
6. `install/install.ps1` exists with download + checksum + PATH config
7. `website/docs/public/install.sh` and `website/docs/public/install.ps1` exist
8. No interactive prompts in either script
9. Marker-based idempotent PATH configuration in install.sh
</verification>

<success_criteria>
- `curl -sSf https://mesh-lang.org/install.sh | sh` pattern supported (script is valid POSIX sh, wrapped in main())
- Platform detection covers macOS ARM64/x86_64 (with Rosetta), Linux x86_64/ARM64
- SHA-256 checksum verification before installation
- Binary installed to ~/.mesh/bin/meshc with PATH configured in bash, zsh, and fish
- Re-running updates or skips if up-to-date
- --version and --uninstall flags work
- PowerShell script covers Windows x86_64
- Scripts served at mesh-lang.org via website public directory
</success_criteria>

<output>
After completion, create `.planning/phases/82-install-infrastructure/82-02-SUMMARY.md`
</output>
