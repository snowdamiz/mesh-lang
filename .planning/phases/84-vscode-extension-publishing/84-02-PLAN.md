---
phase: 84-vscode-extension-publishing
plan: 02
type: execute
wave: 2
depends_on: ["84-01"]
files_modified:
  - .github/workflows/publish-extension.yml
autonomous: false
user_setup:
  - service: vs-code-marketplace
    why: "Publish extension to VS Code Marketplace"
    env_vars:
      - name: VS_MARKETPLACE_TOKEN
        source: "Azure DevOps -> User Settings -> Personal Access Tokens -> New Token (All accessible organizations, Marketplace > Manage scope)"
    account_setup:
      - task: "Create Azure DevOps organization (if none exists)"
        location: "https://dev.azure.com"
      - task: "Create publisher 'mesh-lang' on VS Code Marketplace"
        location: "https://marketplace.visualstudio.com/manage/createpublisher"
  - service: open-vsx
    why: "Publish extension to Open VSX for Cursor, VSCodium, Windsurf users"
    env_vars:
      - name: OPEN_VSX_TOKEN
        source: "Open VSX -> User Settings -> Access Tokens -> Create new token"
    account_setup:
      - task: "Create Eclipse Foundation account and sign Publisher Agreement"
        location: "https://accounts.eclipse.org"
      - task: "Log in to Open VSX with GitHub, connect Eclipse account"
        location: "https://open-vsx.org"
      - task: "Create namespace 'mesh-lang'"
        location: "Run: npx ovsx create-namespace mesh-lang --pat <token>"

must_haves:
  truths:
    - "Pushing an ext-v* tag triggers the publish workflow"
    - "Workflow packages the extension once and publishes to both registries"
    - "ext-v* tags do not conflict with compiler v* release tags"
    - "Workflow fails gracefully if a token is missing or invalid"
  artifacts:
    - path: ".github/workflows/publish-extension.yml"
      provides: "Dual-registry publish workflow triggered on ext-v* tags"
      contains: "ext-v"
  key_links:
    - from: ".github/workflows/publish-extension.yml"
      to: "editors/vscode-mesh/package.json"
      via: "npm ci and vsce:prepublish in working-directory"
      pattern: "working-directory.*editors/vscode-mesh"
    - from: ".github/workflows/publish-extension.yml"
      to: "HaaLeo/publish-vscode-extension@v2"
      via: "GitHub Action for packaging and publishing"
      pattern: "HaaLeo/publish-vscode-extension"
    - from: ".github/workflows/publish-extension.yml"
      to: "secrets.VS_MARKETPLACE_TOKEN"
      via: "GitHub secret for VS Code Marketplace PAT"
      pattern: "secrets\\.VS_MARKETPLACE_TOKEN"
---

<objective>
Create the GitHub Actions workflow for publishing the Mesh extension to both VS Code Marketplace and Open VSX Registry, triggered by ext-v* tags.

Purpose: Automated dual-registry publishing ensures every release reaches VS Code, Cursor, VSCodium, and Windsurf users with a single `git tag ext-v0.2.0 && git push --tags` command. Manual publishing is error-prone and easy to forget for one registry.
Output: `.github/workflows/publish-extension.yml` ready for use once the user adds repository secrets.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/84-vscode-extension-publishing/84-RESEARCH.md
@.planning/phases/84-vscode-extension-publishing/84-01-SUMMARY.md
@.github/workflows/release.yml
@editors/vscode-mesh/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dual-registry publish workflow</name>
  <files>
    .github/workflows/publish-extension.yml
  </files>
  <action>
Create `.github/workflows/publish-extension.yml` with these specifications:

Trigger: `push.tags: ["ext-v*"]` -- uses `ext-v` prefix to avoid conflicting with the compiler `release.yml` which triggers on `v*` tags.

Permissions: `contents: read` (only needs to read the repo, no write needed).

Single job `publish` on `ubuntu-latest`:
1. `actions/checkout@v4`
2. `actions/setup-node@v4` with `node-version: 20`
3. `npm ci` with `working-directory: editors/vscode-mesh`
4. Compile TypeScript: `npm run compile` with `working-directory: editors/vscode-mesh` (belt-and-suspenders; vscode:prepublish also runs compile, but explicit compile ensures errors surface early)
5. Publish to Open VSX Registry using `HaaLeo/publish-vscode-extension@v2`:
   - `id: publishToOpenVSX`
   - `pat: ${{ secrets.OPEN_VSX_TOKEN }}`
   - `packagePath: ./editors/vscode-mesh`
   This step packages the VSIX AND publishes to Open VSX in one shot.
6. Publish to VS Code Marketplace using `HaaLeo/publish-vscode-extension@v2`:
   - `pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}`
   - `registryUrl: https://marketplace.visualstudio.com`
   - `extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}`
   This step REUSES the VSIX from step 5 (does not re-package), ensuring both registries get identical artifacts.

Important: The HaaLeo action's `packagePath` input tells it to run `vsce package` in that directory. The `extensionFile` input on the second step skips packaging and directly publishes the existing VSIX. This "package once, publish twice" pattern is the recommended approach per the action's documentation.

Add a brief comment at the top of the workflow file explaining the ext-v* tag convention and how to trigger a publish:
```yaml
# Publish Mesh VS Code extension to VS Code Marketplace and Open VSX
# Trigger: git tag ext-v0.2.0 && git push origin ext-v0.2.0
# Requires secrets: VS_MARKETPLACE_TOKEN, OPEN_VSX_TOKEN
```
  </action>
  <verify>
    - `test -f .github/workflows/publish-extension.yml && echo "workflow exists"`
    - The workflow file is valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/publish-extension.yml'))" && echo "valid YAML"`
    - `grep 'ext-v' .github/workflows/publish-extension.yml` shows the tag pattern
    - `grep 'HaaLeo/publish-vscode-extension' .github/workflows/publish-extension.yml` shows the action is used
    - `grep 'VS_MARKETPLACE_TOKEN' .github/workflows/publish-extension.yml` shows marketplace secret reference
    - `grep 'OPEN_VSX_TOKEN' .github/workflows/publish-extension.yml` shows Open VSX secret reference
    - `grep 'extensionFile' .github/workflows/publish-extension.yml` confirms VSIX reuse pattern
  </verify>
  <done>Workflow file exists, triggers on ext-v* tags, packages once via Open VSX step, reuses VSIX for Marketplace step, references both secrets</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify extension packaging and review publish workflow</name>
  <what-built>
    Complete VS Code extension marketplace preparation (Plan 01) and publish automation workflow (Plan 02):
    - Extension icon (PNG), README, CHANGELOG
    - Enhanced package.json with version 0.2.0 and all marketplace fields
    - Comprehensive .vscodeignore
    - GitHub Actions workflow for dual-registry publishing
  </what-built>
  <how-to-verify>
    1. Review the generated icon at `editors/vscode-mesh/images/icon.png` -- does it look correct?
    2. Review `editors/vscode-mesh/README.md` -- does the feature list and content look good for a Marketplace page?
    3. Run `cd editors/vscode-mesh && npx vsce package --no-dependencies` and verify it produces a clean VSIX
    4. Review `.github/workflows/publish-extension.yml` -- does the workflow look correct?
    5. When ready to publish:
       a. Create publisher accounts (VS Code Marketplace + Open VSX) per the user_setup instructions
       b. Add `VS_MARKETPLACE_TOKEN` and `OPEN_VSX_TOKEN` as GitHub repository secrets
       c. Tag and push: `git tag ext-v0.2.0 && git push origin ext-v0.2.0`
  </how-to-verify>
  <resume-signal>Type "approved" to complete the phase, or describe any issues with the icon, README, workflow, or other files</resume-signal>
</task>

</tasks>

<verification>
1. `.github/workflows/publish-extension.yml` exists with correct trigger, steps, and secret references
2. The workflow does NOT conflict with `release.yml` (different tag patterns: `ext-v*` vs `v*`)
3. `vsce package` in `editors/vscode-mesh/` succeeds and produces a valid VSIX
4. The VSIX contains: extension metadata, compiled JS, grammar, language config, icon, README, CHANGELOG
5. The VSIX does NOT contain: TypeScript source, tsconfig.json, node_modules, package-lock.json
</verification>

<success_criteria>
- EXT-01: Extension ready to publish to VS Code Marketplace (workflow + metadata in place, user just needs to add secrets and push tag)
- EXT-02: Extension ready to publish to Open VSX (workflow handles both registries)
- Workflow uses ext-v* tag prefix to avoid conflict with compiler releases
- Package-once-publish-twice pattern ensures identical artifacts on both registries
</success_criteria>

<output>
After completion, create `.planning/phases/84-vscode-extension-publishing/84-02-SUMMARY.md`
</output>
