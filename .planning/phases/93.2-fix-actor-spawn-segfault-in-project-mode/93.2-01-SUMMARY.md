---
phase: 93.2-fix-actor-spawn-segfault-in-project-mode
plan: 01
subsystem: codegen
tags: [llvm, actors, abi, spawn, wrapper, deserialization]

# Dependency graph
requires:
  - phase: 48-tce
    provides: "Tail-call elimination rewrite for recursive actors"
  - phase: 87-mesher
    provides: "Actor spawn codegen with args buffer serialization"
provides:
  - "Actor wrapper function generation for ABI-correct spawn with typed args"
  - "Monomorphize pass awareness of actor body functions"
  - "E2E test for actors spawned with arguments"
affects: [94-multi-node-clustering, actor-codegen, spawn-codegen]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Actor wrapper+body function pair for ABI bridging (mirrors service loop pattern)"]

key-files:
  created:
    - tests/e2e/actors_with_args.mpl
  modified:
    - crates/mesh-codegen/src/mir/lower.rs
    - crates/mesh-codegen/src/codegen/mod.rs
    - crates/mesh-codegen/src/codegen/expr.rs
    - crates/mesh-codegen/src/mir/mono.rs
    - crates/meshc/tests/e2e_actors.rs

key-decisions:
  - "Actor wrapper keeps original name; body renamed to __actor_{name}_body"
  - "TCE rewrite uses original actor name (not body name) since recursive calls reference the original"
  - "Monomorphize pass explicitly marks __actor_*_body as reachable from wrapper functions"
  - "Helper function pattern for multi-line receive arms (Mesh parser single-expression constraint)"

patterns-established:
  - "Actor wrapper+body pair: wrapper accepts Ptr, loads args at 8-byte offsets, calls typed body (mirrors service loop pattern)"

# Metrics
duration: 14min
completed: 2026-02-15
---

# Phase 93.2 Plan 01: Fix Actor Spawn Segfault Summary

**Actor ABI wrapper generation in MIR lowering: wrapper accepts raw Ptr buffer, deserializes typed args at 8-byte offsets, calls body function -- fixes segfault for all actors with parameters**

## Performance

- **Duration:** 14 min
- **Started:** 2026-02-15T18:50:44Z
- **Completed:** 2026-02-15T19:04:16Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Fixed ABI mismatch between runtime spawn mechanism (passes `*const u8` buffer) and actor entry functions (expected typed params)
- Actors with parameters now generate a wrapper+body function pair: wrapper deserializes args, body contains original logic
- Zero-argument actors unchanged (no wrapper needed, null args_ptr harmlessly ignored)
- New e2e test validates single-arg and multi-arg actor spawn with correct argument values
- Mesher project (5 parameterized actors) compiles cleanly with wrapper generation

## Task Commits

Each task was committed atomically:

1. **Task 1: Generate actor wrapper function in lower_actor_def** - `2e488c8b` (feat)
2. **Task 2: Add e2e test for actors with arguments and verify Mesher builds** - `718ab9f2` (test)

## Files Created/Modified
- `crates/mesh-codegen/src/mir/lower.rs` - Modified lower_actor_def to generate wrapper+body pair for actors with params
- `crates/mesh-codegen/src/codegen/mod.rs` - Added actor wrapper detection in compile_function (after service loop check)
- `crates/mesh-codegen/src/codegen/expr.rs` - New codegen_actor_wrapper method: loads args at 8-byte offsets and calls body
- `crates/mesh-codegen/src/mir/mono.rs` - Monomorphize pass keeps __actor_*_body functions reachable from wrappers
- `tests/e2e/actors_with_args.mpl` - New test fixture: single-arg adder actor and multi-arg calculator actor
- `crates/meshc/tests/e2e_actors.rs` - New actors_with_args test case (test 9)

## Decisions Made
- **Wrapper keeps original name:** The wrapper function retains the original actor name (e.g., `adder`) so spawn references resolve correctly. The body function gets `__actor_adder_body`.
- **TCE targets original name:** `rewrite_tail_calls` is called with the original actor name because recursive calls in source use `counter(next)`, not `__actor_counter_body(next)`. TCE codegen stores values into param allocas and branches to loop header regardless of function name.
- **Monomorphize awareness:** Added explicit reachability check for `__actor_*_body` functions since they're not referenced in MIR expressions (body is `MirExpr::Unit`, codegen handles invocation). Mirrors the service dispatch pattern.
- **Helper function for receive arms:** Mesh parser requires single-expression case arms in receive blocks. Used `add_and_print` helper function instead of inline let binding.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Monomorphize pass pruning actor body functions**
- **Found during:** Task 2 (e2e test running but actors producing no output)
- **Issue:** The monomorphize (dead code elimination) pass removes unreachable functions. Actor body functions like `__actor_adder_body` have no MIR expression references -- they're invoked by codegen-generated LLVM IR in the wrapper, not by MIR expressions. So they were pruned.
- **Fix:** Added actor wrapper detection in `collect_reachable_functions`: when a function has `__args_ptr` param and a matching `__actor_{name}_body` exists, mark the body as reachable.
- **Files modified:** `crates/mesh-codegen/src/mir/mono.rs`
- **Verification:** Actor body functions appear in LLVM IR, tests pass with correct output (15, 42)
- **Committed in:** 718ab9f2 (Task 2 commit)

**2. [Rule 1 - Bug] Multi-line receive body parse error**
- **Found during:** Task 2 (test fixture parsing)
- **Issue:** Mesh parser requires single-expression case arms in receive blocks. Multi-line body with let binding caused parse error.
- **Fix:** Extracted computation to `add_and_print` helper function called from receive arm.
- **Files modified:** `tests/e2e/actors_with_args.mpl`
- **Verification:** Test fixture parses and compiles correctly
- **Committed in:** 718ab9f2 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both auto-fixes necessary for correctness. The monomorphize fix is critical infrastructure -- without it, actor body functions are silently eliminated. No scope creep.

## Issues Encountered
None beyond the auto-fixed deviations above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Actor spawn with arguments works correctly for all parameter types (int, ptr, float)
- Mesher project compiles with all 5 parameterized actors generating correct wrappers
- Ready for Phase 94 (Multi-Node Clustering) which will involve distributed actor spawning

---
*Phase: 93.2-fix-actor-spawn-segfault-in-project-mode*
*Completed: 2026-02-15*
