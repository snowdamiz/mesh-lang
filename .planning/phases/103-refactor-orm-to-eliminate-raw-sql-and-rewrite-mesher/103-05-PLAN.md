---
phase: 103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher
plan: 05
type: execute
wave: 3
depends_on: ["103-01", "103-04"]
files_modified:
  - mesher/storage/writer.mpl
  - mesher/storage/schema.mpl
autonomous: true

must_haves:
  truths:
    - "writer.mpl insert_event uses Repo.execute_raw instead of Pool.execute"
    - "schema.mpl create_partition uses Repo.execute_raw instead of Pool.execute"
    - "schema.mpl create_partitions_loop uses Repo.query_raw instead of Pool.query"
    - "Zero Pool.query/Pool.execute calls remain in any mesher storage file"
    - "Zero Pool.query/Pool.execute calls remain in any mesher non-migration file"
    - "Mesher compiles and all function signatures are preserved"
  artifacts:
    - path: "mesher/storage/writer.mpl"
      provides: "insert_event using Repo.execute_raw"
    - path: "mesher/storage/schema.mpl"
      provides: "Partition management using Repo.query_raw/execute_raw"
  key_links:
    - from: "mesher/storage/writer.mpl"
      to: "crates/mesh-rt/src/db/repo.rs"
      via: "Repo.execute_raw"
    - from: "mesher/storage/schema.mpl"
      to: "crates/mesh-rt/src/db/repo.rs"
      via: "Repo.query_raw and Repo.execute_raw"
---

<objective>
Convert remaining raw SQL in writer.mpl and schema.mpl from Pool.query/Pool.execute to Repo.query_raw/Repo.execute_raw. Perform final audit to verify zero Pool.query/Pool.execute calls remain in all non-migration Mesher files.

Purpose: This is the final cleanup plan. After Plans 01 (JSON intrinsic for non-storage JSONB), 04 (queries.mpl full conversion), this plan handles the last 3 raw SQL calls in storage/writer.mpl and storage/schema.mpl. The result: every database access in Mesher application code flows through Repo.* APIs.

Output: All Mesher storage files use Repo namespace. Clean audit report.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher/103-RESEARCH.md
@.planning/phases/103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher/103-01-SUMMARY.md
@.planning/phases/103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher/103-04-SUMMARY.md
@mesher/storage/writer.mpl
@mesher/storage/schema.mpl

Remaining raw SQL calls (3 total):
1. writer.mpl: Pool.execute for INSERT ... SELECT with JSONB extraction (intentionally complex)
2. schema.mpl: Pool.execute for CREATE TABLE IF NOT EXISTS partition DDL
3. schema.mpl: Pool.query for date computation (SELECT to_char(now() + interval))
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert writer.mpl and schema.mpl to Repo.query_raw/execute_raw</name>
  <files>
    mesher/storage/writer.mpl
    mesher/storage/schema.mpl
  </files>
  <action>
  Mechanical replacements (3 calls):

  **mesher/storage/writer.mpl** -- `insert_event` function:
  Replace `Pool.execute(pool, ...)` with `Repo.execute_raw(pool, ...)`. The SQL and params stay identical:
  ```
  let result = Repo.execute_raw(pool, "INSERT INTO events ...", [project_id, issue_id, fingerprint, json_str])
  ```
  This is a one-line change.

  **mesher/storage/schema.mpl** -- `create_partition` function:
  Replace `Pool.execute(pool, sql, [])` with `Repo.execute_raw(pool, sql, [])`.
  One-line change. The dynamic SQL construction stays the same.

  **mesher/storage/schema.mpl** -- `create_partitions_loop` function:
  Replace `Pool.query(pool, "SELECT to_char(...)", [offset_str])` with `Repo.query_raw(pool, "SELECT to_char(...)", [offset_str])`.
  One-line change. The date computation SQL stays the same.

  After all 3 replacements, build mesher to verify compilation.
  </action>
  <verify>cd /Users/sn0w/Documents/dev/snow/mesher && ../target/debug/meshc build . 2>&1 | tail -5</verify>
  <done>All 3 Pool.query/Pool.execute calls in writer.mpl and schema.mpl replaced with Repo.query_raw/execute_raw</done>
</task>

<task type="auto">
  <name>Task 2: Final audit -- verify zero Pool.query/Pool.execute in non-migration Mesher files</name>
  <files>
    mesher/storage/queries.mpl
    mesher/storage/writer.mpl
    mesher/storage/schema.mpl
    mesher/ingestion/routes.mpl
    mesher/ingestion/ws_handler.mpl
    mesher/ingestion/pipeline.mpl
    mesher/api/alerts.mpl
    mesher/api/team.mpl
  </files>
  <action>
  Run the comprehensive audit:

  ```bash
  # Audit all non-migration Mesher files for Pool.query/Pool.execute
  grep -rn "Pool.query\|Pool.execute" mesher/ --include="*.mpl" | grep -v "migrations/"
  ```

  Expected result: ZERO matches. If any remain:
  - In storage files: replace with Repo.query_raw/Repo.execute_raw
  - In ingestion/api files: replace with Json.get (if JSONB parsing) or Repo.query_raw/execute_raw (if actual DB query)

  Also verify:
  ```bash
  # Count Repo.* usage to confirm migration
  grep -c "Repo\.\|Query\.\|Json\." mesher/storage/queries.mpl
  ```

  Build the final mesher binary:
  ```bash
  cd mesher && ../target/debug/meshc build .
  ```

  If build succeeds, the phase is complete. All database access in Mesher application code now flows through Repo.* APIs (for actual DB access) or Json.* (for JSON parsing that previously used PostgreSQL).
  </action>
  <verify>grep -rn "Pool.query\|Pool.execute" /Users/sn0w/Documents/dev/snow/mesher/ --include="*.mpl" | grep -v "migrations/" | wc -l</verify>
  <done>Zero Pool.query/Pool.execute calls remain in non-migration Mesher files; all database access goes through Repo.* namespace; all JSON parsing goes through Json.* namespace</done>
</task>

</tasks>

<verification>
1. `grep -rn "Pool.query\|Pool.execute" mesher/ --include="*.mpl" | grep -v "migrations/"` returns 0 matches
2. `grep -c "Repo\." mesher/storage/queries.mpl` shows high count (all functions use Repo)
3. `grep -c "Pool.query\|Pool.execute" mesher/storage/writer.mpl` returns 0
4. `grep -c "Pool.query\|Pool.execute" mesher/storage/schema.mpl` returns 0
5. `grep -c "Pool.query\|Pool.execute" mesher/ingestion/routes.mpl mesher/ingestion/ws_handler.mpl mesher/ingestion/pipeline.mpl mesher/api/alerts.mpl mesher/api/team.mpl` returns 0 for all
6. Mesher compiles: `cd mesher && ../target/debug/meshc build .`
</verification>

<success_criteria>
- Zero Pool.query/Pool.execute calls in any non-migration Mesher file
- writer.mpl uses Repo.execute_raw
- schema.mpl uses Repo.query_raw and Repo.execute_raw
- All function signatures unchanged
- Mesher compiles without new errors
- Phase 103 goal achieved: all raw SQL eliminated from application code (routed through Repo.* or Json.* APIs)
</success_criteria>

<output>
After completion, create `.planning/phases/103-refactor-orm-to-eliminate-raw-sql-and-rewrite-mesher/103-05-SUMMARY.md`
</output>
