---
phase: 63-pid-encoding-wire-format
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/snow-rt/src/actor/process.rs
  - crates/snow-rt/src/actor/mod.rs
autonomous: true

must_haves:
  truths:
    - "All 1,524 existing tests pass with zero regressions after PID encoding change"
    - "A PID with node_id=0 displays identically to the old format (<0.N>)"
    - "ProcessId::from_remote(node_id, creation, local_id) round-trips through node_id(), creation(), local_id()"
    - "Local send path is unchanged -- locality check routes node_id=0 PIDs to existing code"
    - "Remote send path calls a cold stub function (no-op for Phase 63)"
  artifacts:
    - path: "crates/snow-rt/src/actor/process.rs"
      provides: "ProcessId with bit-packing methods"
      contains: "fn node_id"
    - path: "crates/snow-rt/src/actor/mod.rs"
      provides: "Locality check in snow_actor_send"
      contains: "target_pid >> 48"
  key_links:
    - from: "crates/snow-rt/src/actor/mod.rs"
      to: "crates/snow-rt/src/actor/process.rs"
      via: "ProcessId::is_local() used in send routing"
      pattern: ">> 48 == 0"
---

<objective>
PID bit-packing and locality check in send path.

Encode node identity (16-bit node_id), creation counter (8-bit), and local process ID (40-bit) into the existing ProcessId(u64) newtype. Add a locality check at the top of snow_actor_send that routes local PIDs (node_id=0) to the existing fast path and remote PIDs to a cold stub. All existing tests must pass unchanged.

Purpose: Foundation for location-transparent PIDs -- every PID now carries enough information to identify which node it belongs to, enabling later phases to route messages to remote nodes.
Output: Modified process.rs with bit-packing methods, modified mod.rs with locality-checked send.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-pid-encoding-wire-format/63-RESEARCH.md
@crates/snow-rt/src/actor/process.rs
@crates/snow-rt/src/actor/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PID bit-packing methods to ProcessId</name>
  <files>crates/snow-rt/src/actor/process.rs</files>
  <action>
Add the following methods to the existing `impl ProcessId` block in `crates/snow-rt/src/actor/process.rs`:

1. `node_id(self) -> u16` -- extract upper 16 bits (bits 63..48): `(self.0 >> 48) as u16`
2. `creation(self) -> u8` -- extract bits 47..40: `((self.0 >> 40) & 0xFF) as u8`
3. `local_id(self) -> u64` -- extract lower 40 bits: `self.0 & 0x0000_00FF_FFFF_FFFF`
4. `is_local(self) -> bool` -- check upper 16 bits are zero: `self.0 >> 48 == 0`
5. `from_remote(node_id: u16, creation: u8, local_id: u64) -> Self` -- construct from components with debug_assert that local_id < 2^40

All methods should be `#[inline]` for zero-cost in the hot path.

Modify `ProcessId::next()` to mask the counter to 40 bits: `ProcessId(COUNTER.fetch_add(1, Ordering::Relaxed) & 0x0000_00FF_FFFF_FFFF)`. This is defensive -- the counter will never reach 2^40 in practice, but masking prevents silent corruption if it ever did.

Update `Display` implementation: keep the format as `<0.{local_id}>` when node_id=0 AND creation=0 (backward compatible). Use `<{node_id}.{local_id}.{creation}>` when node_id > 0 OR creation > 0. This preserves all existing snapshot test output.

Add unit tests in the existing `#[cfg(test)] mod tests` block:
- `test_pid_bit_packing_roundtrip`: create via from_remote(5, 3, 42), verify node_id()=5, creation()=3, local_id()=42
- `test_pid_local_is_local`: ProcessId::next() produces is_local()=true, node_id()=0, creation()=0
- `test_pid_remote_is_not_local`: from_remote(1, 0, 99) is not local
- `test_pid_display_local_unchanged`: format!("{}", ProcessId(42)) produces "<0.42>" (backward compat)
- `test_pid_display_remote`: format!("{}", ProcessId::from_remote(5, 2, 42)) produces "<5.42.2>"
- `test_pid_next_masked`: verify ProcessId::next().local_id() equals the raw value (no spillover)
  </action>
  <verify>
Run `cargo test -p snow-rt actor::process::tests` -- all existing and new process tests pass. Run `cargo test` across workspace -- all 1,524+ tests pass (no snapshot regressions from Display change).
  </verify>
  <done>
ProcessId has node_id(), creation(), local_id(), is_local(), from_remote() methods. Existing PID display format is unchanged for local PIDs. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add locality check to snow_actor_send</name>
  <files>crates/snow-rt/src/actor/mod.rs</files>
  <action>
Refactor `snow_actor_send` in `crates/snow-rt/src/actor/mod.rs` to add a locality check:

1. Extract the existing body of `snow_actor_send` (lines 262-297) into a new private function `fn local_send(target_pid: u64, msg_ptr: *const u8, msg_size: u64)`. The function body is the EXACT existing code, unchanged.

2. Replace the body of `snow_actor_send` with:
```rust
// Locality check: upper 16 bits == 0 means local PID.
// Single shift+compare -- essentially free on modern CPUs.
if target_pid >> 48 == 0 {
    local_send(target_pid, msg_ptr, msg_size);
} else {
    dist_send_stub(target_pid, msg_ptr, msg_size);
}
```

3. Add the stub function:
```rust
#[cold]
fn dist_send_stub(_target_pid: u64, _msg_ptr: *const u8, _msg_size: u64) {
    // Phase 65 will replace this with actual remote send via NodeSession.
    // For now, remote PIDs should not exist in single-node programs.
    // Silently drop -- no panic, no log.
}
```

The key constraint: the existing `snow_actor_send` function signature and `#[no_mangle]` attribute must remain identical. Only the internal routing changes.

Do NOT modify any other functions in this file. The `local_send` function should NOT be `pub` or `#[no_mangle]` -- it is an internal implementation detail.

Add a unit test `test_send_locality_check_local_path` that verifies sending to a local PID (node_id=0) still delivers to the mailbox (use the existing test pattern from `test_send_delivers_to_mailbox`).
  </action>
  <verify>
Run `cargo test -p snow-rt actor::tests` -- all existing send/receive/link tests pass. Run full `cargo test` -- all 1,524+ tests pass. Verify `dist_send_stub` exists via grep.
  </verify>
  <done>
snow_actor_send routes local PIDs (node_id=0) through existing local_send path, remote PIDs through cold dist_send_stub. All existing tests pass with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p snow-rt` -- all snow-rt unit tests pass
2. `cargo test` -- full workspace test suite passes (1,524+ tests, zero regressions)
3. ProcessId bit-packing round-trips correctly
4. PID Display format unchanged for local PIDs
5. snow_actor_send still delivers messages to local actors
</verification>

<success_criteria>
- ProcessId encodes node_id (16 bits), creation (8 bits), local_id (40 bits) in existing u64
- is_local() returns true for all existing local PIDs (node_id=0)
- from_remote() constructs remote PIDs correctly
- Display format backward compatible for local PIDs
- snow_actor_send routes local PIDs to existing code, remote to stub
- All 1,524+ existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/63-pid-encoding-wire-format/63-01-SUMMARY.md`
</output>
