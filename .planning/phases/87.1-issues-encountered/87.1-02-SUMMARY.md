---
phase: 87.1-issues-encountered
plan: 02
subsystem: typeck, codegen, module-system
tags: [type-inference, cross-module, services, polymorphism, scheme-normalization]

# Dependency graph
requires:
  - phase: 87.1-issues-encountered
    provides: codegen fixes from plan 01 (Result codegen, multi-clause, closures)
provides:
  - normalized polymorphic type scheme export for cross-module imports
  - cross-module service export/import pipeline (typeck + MIR lowering)
  - regression test for cross-module ? operator with Result types
affects: [module-system, services, type-inference]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Scheme::normalize_from_ty for self-contained type scheme export"
    - "ServiceExportInfo struct for cross-module service method propagation"
    - "service_modules checked before user_modules in MIR field access"

key-files:
  created: []
  modified:
    - crates/mesh-typeck/src/ty.rs
    - crates/mesh-typeck/src/lib.rs
    - crates/mesh-typeck/src/infer.rs
    - crates/mesh-typeck/src/unify.rs
    - crates/mesh-codegen/src/mir/lower.rs
    - crates/meshc/src/main.rs
    - crates/meshc/tests/e2e.rs

key-decisions:
  - "Normalize TyVar IDs to sequential 0-based in exported Schemes instead of preserving original IDs"
  - "Services exported by default (no pub prefix) since grammar lacks pub service syntax"
  - "Check service_modules before user_modules in MIR field access to use generated function names"

patterns-established:
  - "Cross-module service import: register helpers in env + qualified_modules for typeck, populate service_modules for MIR lowering"
  - "Scheme::normalize_from_ty collects free TyVars and remaps to 0-based sequential IDs"

# Metrics
duration: 12min
completed: 2026-02-14
---

# Phase 87.1 Plan 02: Module System Fixes Summary

**Normalized polymorphic type scheme export and cross-module service import pipeline with 3 new E2E regression tests**

## Performance

- **Duration:** ~12 min
- **Started:** 2026-02-14T18:00:00Z
- **Completed:** 2026-02-14T18:12:00Z
- **Tasks:** 4
- **Files modified:** 7

## Accomplishments
- Polymorphic function types now export with self-contained TyVar IDs (0-based), preventing index-out-of-bounds panics in importing modules
- Full service export/import pipeline: services defined in one module can be imported and used (start, call, cast) from another module
- Cross-module ? operator verified working with Result types from imported functions
- 495 tests pass with zero regressions (151 E2E + 92 stdlib + 76 typeck + 176 codegen)

## Task Commits

Each task was committed atomically:

1. **Task 1: Normalize polymorphic type schemes on export** - `07a0372f` (feat)
2. **Task 2: Add cross-module service export and import** - `1e134c71` (feat)
3. **Task 3: Add regression test for ? operator in cross-module Result chains** - `f5665baf` (test)
4. **Task 4: Verify no regressions** - no commit (verification only)

## Files Created/Modified
- `crates/mesh-typeck/src/ty.rs` - Added Scheme::normalize_from_ty, collect_free_tyvars, remap_tyvars
- `crates/mesh-typeck/src/lib.rs` - Added ServiceExportInfo struct, service_defs fields, local_service_exports, imported_service_methods
- `crates/mesh-typeck/src/infer.rs` - Service export info collection in infer_service_def, service import handling in ImportDecl/FromImportDecl
- `crates/mesh-typeck/src/unify.rs` - Added imported_service_methods and local_service_exports fields to InferCtx
- `crates/mesh-codegen/src/mir/lower.rs` - Populate service_modules from imported_service_methods, reorder field access resolution
- `crates/meshc/src/main.rs` - Pass service_defs through ModuleExports in build_import_context
- `crates/meshc/tests/e2e.rs` - 3 new E2E tests: cross-module polymorphic, cross-module service, cross-module try operator

## Decisions Made
- **Scheme normalization approach:** Chose to collect all free TyVars from resolved types and remap to sequential IDs starting from 0, rather than using InferCtx generalization (which would require access to the original InferCtx)
- **Service visibility:** Services are always exported since the grammar lacks `pub service` syntax. Adding pub prefix support would require parser changes (architectural -- deferred)
- **MIR field access ordering:** Moved service_modules check before user_modules in lower_field_access. Services registered in qualified_modules for typeck would otherwise resolve to bare names instead of generated function names (__service_*)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] MIR field access resolution ordering**
- **Found during:** Task 2 (cross-module service import)
- **Issue:** service_modules was checked after user_modules in MIR lowerer, but imported services also registered in qualified_modules/user_modules. user_modules resolved Store.start to bare "start" instead of "__service_store_start"
- **Fix:** Reordered lower_field_access to check service_modules before user_modules
- **Files modified:** crates/mesh-codegen/src/mir/lower.rs
- **Verification:** E2E test e2e_cross_module_service passes, all existing tests pass
- **Committed in:** 1e134c71 (Task 2 commit)

**2. [Rule 1 - Bug] Case expression scrutinee parsing limitation**
- **Found during:** Task 3 (try operator test)
- **Issue:** `case process(10) do` caused parse error -- case expressions require a variable/name ref as scrutinee, not inline function calls
- **Fix:** Used let binding pattern: `let r1 = process(10)` then `case r1 do`
- **Files modified:** crates/meshc/tests/e2e.rs (test code only)
- **Committed in:** f5665baf (Task 3 commit)

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug workaround)
**Impact on plan:** Both fixes necessary for correct service resolution and valid test syntax. No scope creep.

## Issues Encountered
- Polymorphic functions (truly generic like `identity(x) do x end`) cannot work cross-module at the codegen level because the MIR lowerer compiles unresolved TyVars as MirType::Unit. Cross-module polymorphic functions work only when the type is constrained to a concrete type (e.g., through arithmetic operators). This is an existing codegen limitation, not a regression.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Module system now supports cross-module function imports with inferred types and cross-module service imports
- Type scheme normalization prevents panics when importing polymorphic functions
- Service export/import pipeline is complete for the current service grammar
- Potential future work: `pub service` syntax, true polymorphic function monomorphization across modules

## Self-Check: PASSED

All 7 modified files verified present. All 3 task commits verified in git history.

---
*Phase: 87.1-issues-encountered*
*Completed: 2026-02-14*
