---
phase: 87.1-issues-encountered
plan: 01
subsystem: compiler
tags: [llvm, codegen, pattern-matching, result, option, try-operator]

# Dependency graph
requires:
  - phase: 87-foundation
    provides: "Mesher application code that surfaced the codegen bugs"
provides:
  - "Fixed alloca domination for pattern variable bindings in codegen_leaf"
  - "Defensive ptr-to-struct load in codegen_return for ? operator early returns"
  - "Working Err(e) binding in Result pattern matching"
  - "Working List.find Option pattern matching with Some(x)/None"
  - "Working chained ? operator calls across Result types"
affects: [88-ingestion-pipeline, 89-error-grouping, 90-search, 91-rest-api, 92-alerting]

# Tech tracking
tech-stack:
  added: []
  patterns: ["entry-block alloca placement for pattern bindings", "defensive type coercion in codegen_return"]

key-files:
  created:
    - tests/e2e/err_binding_pattern.mpl
    - tests/e2e/list_find_option_match.mpl
    - tests/e2e/try_operator_result.mpl
  modified:
    - crates/mesh-codegen/src/codegen/pattern.rs
    - crates/mesh-codegen/src/codegen/expr.rs
    - crates/meshc/tests/e2e.rs
    - crates/meshc/tests/e2e_stdlib.rs

key-decisions:
  - "Entry-block alloca placement in codegen_leaf matches existing codegen_guard pattern"
  - "Re-store to existing alloca when same variable name reused across case expressions (instead of skip)"
  - "Defensive ptr-to-struct load in codegen_return even though current codegen_construct_variant already returns struct values"

patterns-established:
  - "Entry-block alloca: all pattern variable allocas placed in function entry block for LLVM domination correctness"

# Metrics
duration: 10min
completed: 2026-02-14
---

# Phase 87.1 Plan 01: Codegen Fixes Summary

**Fixed LLVM alloca domination in pattern matching and added defensive return type coercion for ? operator early returns**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-14T23:47:31Z
- **Completed:** 2026-02-14T23:57:11Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Fixed alloca domination bug in `codegen_leaf` that prevented Err(e) binding and List.find Option pattern matching
- Fixed same-variable-name reuse across multiple case expressions in the same function (was causing segfault)
- Added defensive ptr-to-struct load in `codegen_return` for future-proofing ? operator return paths
- Three new E2E tests proving all three codegen issues are resolved
- Full test suite passes: 293 tests, 0 failures, 0 regressions

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix Err(e) alloca domination and List.find Option matching** - `0d62f018` (fix)
2. **Task 2: Fix ? operator LLVM codegen return type mismatch** - `e0daa42c` (fix)

## Files Created/Modified
- `crates/mesh-codegen/src/codegen/pattern.rs` - Entry-block alloca placement in codegen_leaf; re-store to existing alloca for reused names
- `crates/mesh-codegen/src/codegen/expr.rs` - Defensive ptr-to-struct load in codegen_return
- `tests/e2e/err_binding_pattern.mpl` - E2E test for Err(e) variable binding in Result pattern matching
- `tests/e2e/list_find_option_match.mpl` - E2E test for List.find Option pattern matching with Some(x)/None
- `tests/e2e/try_operator_result.mpl` - E2E test for chained ? operator with multiple Result types
- `crates/meshc/tests/e2e.rs` - Test runner entries for err_binding_pattern and try_operator_result
- `crates/meshc/tests/e2e_stdlib.rs` - Test runner entry for list_find_option_match

## Decisions Made
- Entry-block alloca placement in `codegen_leaf` matches the pattern already used by `codegen_guard` (lines 438-456). This is the standard LLVM approach for ensuring allocas dominate all uses.
- When `codegen_leaf` encounters a variable name already in `self.locals`, it re-stores the new value to the existing alloca instead of skipping entirely. This prevents stale values when the same variable name appears in multiple case expressions.
- The defensive ptr-to-struct load in `codegen_return` was added even though the current `codegen_construct_variant` already returns loaded struct values. This protects against future changes that might return pointers.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed same-variable-name segfault in multiple case expressions**
- **Found during:** Task 1 (alloca domination fix)
- **Issue:** When two `case` expressions in the same function used the same variable names (e.g., both using `Ok(s)` and `Err(e)`), the second case's `codegen_leaf` would skip binding because the name already existed in `self.locals`, causing the second case to read stale values from the first case and segfault.
- **Fix:** Changed the `contains_key` skip to instead re-store the new value to the existing alloca.
- **Files modified:** `crates/mesh-codegen/src/codegen/pattern.rs`
- **Verification:** Test with same variable names across case expressions produces correct output.
- **Committed in:** `0d62f018` (part of Task 1 commit)

**2. [Rule 1 - Bug] Issue 1 (? operator return type mismatch) was actually caused by alloca domination**
- **Found during:** Task 2 investigation
- **Issue:** The LLVM verification error attributed to a ptr-to-struct type mismatch in `codegen_return` was actually caused by the alloca domination bug in `codegen_leaf`. The `codegen_construct_variant` function already correctly loads the struct value, so no ptr-to-struct conversion is needed in the current code.
- **Fix:** Applied the defensive fix from the plan anyway as future-proofing, since it's harmless and protects against regressions.
- **Files modified:** `crates/mesh-codegen/src/codegen/expr.rs`
- **Verification:** All three new E2E tests pass. Full suite passes with 0 regressions.
- **Committed in:** `e0daa42c` (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes were necessary for correctness. The same-variable-name bug was discovered during testing of the alloca fix. The return type mismatch turned out to be a symptom of alloca domination, not a separate root cause.

## Issues Encountered
- The return type mismatch described in Issue 1 of the research was not a separate bug -- it was a manifestation of the alloca domination issue (Issue 2). After fixing alloca placement, all three issues (?, Err(e) binding, List.find Option matching) were resolved by the single fix in `codegen_leaf`.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All codegen fixes complete: ? operator, Err(e) binding, List.find Option matching all work
- Idiomatic Result/Option handling unblocked for phases 88-95
- Phase 87.1 Plan 02 (module system fixes) can proceed independently
- Phase 88 (Ingestion Pipeline) can use ? operator and pattern matching freely

---
*Phase: 87.1-issues-encountered*
*Completed: 2026-02-14*
