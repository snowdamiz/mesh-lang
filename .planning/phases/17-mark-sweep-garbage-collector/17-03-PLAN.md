---
phase: 17-mark-sweep-garbage-collector
plan: 03
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - crates/snow-rt/src/string.rs
  - crates/snow-rt/src/collections/list.rs
  - crates/snow-rt/src/collections/map.rs
  - crates/snow-rt/src/collections/set.rs
  - crates/snow-rt/src/collections/queue.rs
  - crates/snow-rt/src/collections/range.rs
  - crates/snow-rt/src/collections/tuple.rs
  - crates/snow-rt/src/io.rs
  - crates/snow-rt/src/file.rs
  - crates/snow-rt/src/env.rs
  - crates/snow-rt/src/json.rs
  - crates/snow-rt/src/http/server.rs
  - crates/snow-rt/src/http/client.rs
  - crates/snow-rt/src/actor/job.rs
  - crates/snow-rt/src/codegen/intrinsics.rs
  - crates/snow-codegen/src/codegen/intrinsics.rs
  - crates/snow-codegen/src/codegen/expr.rs
  - crates/snow-codegen/src/mir/lower.rs
autonomous: true

must_haves:
  truths:
    - "All runtime allocation functions use snow_gc_alloc_actor instead of snow_gc_alloc"
    - "Codegen emits snow_gc_alloc_actor instead of snow_gc_alloc for all heap allocations"
    - "Allocations in actor context get GcHeaders; allocations outside actor context fall back to global arena without headers"
    - "All existing e2e tests pass unchanged"
  artifacts:
    - path: "crates/snow-rt/src/string.rs"
      provides: "String operations using actor-aware allocation"
      contains: "snow_gc_alloc_actor"
    - path: "crates/snow-codegen/src/codegen/expr.rs"
      provides: "Codegen emitting snow_gc_alloc_actor calls"
      contains: "snow_gc_alloc_actor"
    - path: "crates/snow-codegen/src/codegen/intrinsics.rs"
      provides: "snow_gc_alloc_actor intrinsic declaration"
      contains: "snow_gc_alloc_actor"
  key_links:
    - from: "crates/snow-codegen/src/codegen/expr.rs"
      to: "snow_gc_alloc_actor"
      via: "get_intrinsic calls reference snow_gc_alloc_actor"
      pattern: "snow_gc_alloc_actor"
    - from: "crates/snow-rt/src/string.rs"
      to: "crates/snow-rt/src/gc.rs"
      via: "import and call snow_gc_alloc_actor"
      pattern: "snow_gc_alloc_actor"
---

<objective>
Migrate all runtime and codegen allocations from `snow_gc_alloc` (global arena, no headers) to `snow_gc_alloc_actor` (per-actor heap with GcHeaders, falls back to global arena when no actor context).

Purpose: Without this migration, objects allocated by runtime functions (string concat, list construction, etc.) and by compiled Snow code would land in the global arena without GcHeaders, making them invisible to the mark-sweep collector. After this change, all heap objects in actor context are GC-managed.

Output: All allocation call sites migrated, codegen updated, all existing tests pass.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-mark-sweep-garbage-collector/17-RESEARCH.md
@.planning/phases/17-mark-sweep-garbage-collector/17-01-SUMMARY.md
@crates/snow-rt/src/gc.rs
@crates/snow-rt/src/string.rs
@crates/snow-codegen/src/codegen/intrinsics.rs
@crates/snow-codegen/src/codegen/expr.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate all runtime modules from snow_gc_alloc to snow_gc_alloc_actor</name>
  <files>
    crates/snow-rt/src/string.rs
    crates/snow-rt/src/collections/list.rs
    crates/snow-rt/src/collections/map.rs
    crates/snow-rt/src/collections/set.rs
    crates/snow-rt/src/collections/queue.rs
    crates/snow-rt/src/collections/range.rs
    crates/snow-rt/src/collections/tuple.rs
    crates/snow-rt/src/io.rs
    crates/snow-rt/src/file.rs
    crates/snow-rt/src/env.rs
    crates/snow-rt/src/json.rs
    crates/snow-rt/src/http/server.rs
    crates/snow-rt/src/http/client.rs
    crates/snow-rt/src/actor/job.rs
  </files>
  <action>
For each file that imports and calls `snow_gc_alloc`, change it to use `snow_gc_alloc_actor` instead. This is a systematic find-and-replace with verification:

**For each file:**
1. Change the import: `use crate::gc::snow_gc_alloc;` -> `use crate::gc::snow_gc_alloc_actor;`
2. Change every call site: `snow_gc_alloc(...)` -> `snow_gc_alloc_actor(...)`

**Files to update (from grep results):**
- `string.rs`: `snow_string_new` and all string operations (line 12, 82)
- `collections/list.rs`: `snow_list_new` (line 9, 43)
- `collections/map.rs`: `snow_map_new` and related (line 13, 73)
- `collections/set.rs`: `snow_set_new` (line 9, 32)
- `collections/queue.rs`: `snow_queue_new`, `snow_queue_dequeue` (line 9, 25, 90)
- `collections/range.rs`: `snow_range_new` (line 8, 26)
- `collections/tuple.rs`: test code only (line 45, 51) -- keep snow_gc_alloc for test since tests run outside actor context
- `io.rs`: `snow_readline` (line 6, 25)
- `file.rs`: `snow_file_read` (line 9, 16)
- `env.rs`: `snow_env_get`, `snow_env_args` (line 5, 25, 67)
- `json.rs`: JSON parsing allocations (line 19, 46, 59)
- `http/server.rs`: HTTP request allocation (line 19, 59, 136, 360) -- note this file already imports both; remove the `snow_gc_alloc` import and change remaining calls
- `http/client.rs`: HTTP response allocation (line 6, 13)
- `actor/job.rs`: Service call result allocation (line 25, 44, 105, 365)

**IMPORTANT for test code**: Test files that use `snow_gc_alloc` in `#[cfg(test)]` blocks (like `tuple.rs` line 45) should keep using `snow_gc_alloc` because tests run outside actor context and need the global arena. Only change production code paths.

**IMPORTANT**: `snow_gc_alloc_actor` already falls back to `snow_gc_alloc` when no actor context is available, so this change is safe for code that runs on the main thread (e.g., during startup before actors exist). The behavior is identical in non-actor contexts.

After all changes, run `cargo test -p snow-rt` to verify all runtime tests pass.
  </action>
  <verify>
Run: `cargo test -p snow-rt`
All runtime tests pass. Grep confirms no production code (non-test) uses `snow_gc_alloc` directly except `gc.rs` itself.
  </verify>
  <done>
All runtime allocation functions route through snow_gc_alloc_actor. In actor context, objects get GcHeaders on the per-actor heap. Outside actor context, falls back to global arena unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update codegen to emit snow_gc_alloc_actor instead of snow_gc_alloc</name>
  <files>
    crates/snow-codegen/src/codegen/intrinsics.rs
    crates/snow-codegen/src/codegen/expr.rs
    crates/snow-codegen/src/mir/lower.rs
  </files>
  <action>
1. **Update `intrinsics.rs`**:
   - Change the intrinsic declaration from `"snow_gc_alloc"` to `"snow_gc_alloc_actor"`. The function signature is identical (size: u64, align: u64) -> ptr, so only the name changes.
   - Keep the same function type (`gc_alloc_ty`).
   - Update the assertion in tests: `assert!(module.get_function("snow_gc_alloc_actor").is_some());`

2. **Update `expr.rs`**:
   - Change all `get_intrinsic(&self.module, "snow_gc_alloc")` calls to `get_intrinsic(&self.module, "snow_gc_alloc_actor")`.
   - There are approximately 5 call sites (lines 1185, 1209, 1319, 2177 from grep).
   - Update any error messages that reference "snow_gc_alloc" to say "snow_gc_alloc_actor".

3. **Update `lower.rs`**:
   - The comment on line 2299 mentions "snow_gc_alloc" -- update to "snow_gc_alloc_actor".
   - Check if there are any actual function name references (not just comments) and update those too.

4. **Verify**: `cargo build -p snow-codegen` compiles without errors. Then run the full e2e test suite:
   ```
   cargo test -p snowc --test e2e
   ```
   All existing e2e tests must pass, confirming compiled Snow programs still work correctly with the new allocation routing.
  </action>
  <verify>
Run: `cargo build -p snow-codegen && cargo test -p snowc --test e2e`
Codegen compiles. All 61 e2e tests pass.
  </verify>
  <done>
Compiled Snow programs emit snow_gc_alloc_actor calls instead of snow_gc_alloc. All allocations in actor context now get GcHeaders. All existing e2e tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p snow-rt` -- all runtime tests pass
2. `cargo test -p snow-codegen` -- all codegen tests pass
3. `cargo test -p snowc --test e2e` -- all e2e tests pass
4. `grep -r "snow_gc_alloc\b" crates/snow-rt/src/ --include="*.rs"` -- only gc.rs and test code reference the global allocator
5. `grep -r "snow_gc_alloc\b" crates/snow-codegen/src/ --include="*.rs"` -- no references remain
</verification>

<success_criteria>
- Zero production runtime code calls snow_gc_alloc directly (only gc.rs definition and test code)
- Codegen emits snow_gc_alloc_actor for all heap allocations
- All 61 existing e2e tests pass without modification
- All runtime unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/17-mark-sweep-garbage-collector/17-03-SUMMARY.md`
</output>
