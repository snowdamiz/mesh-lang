---
phase: 91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mesher/api/helpers.mpl
  - mesher/api/search.mpl
  - mesher/api/dashboard.mpl
  - mesher/api/team.mpl
  - mesher/ingestion/routes.mpl
  - mesher/ingestion/fingerprint.mpl
autonomous: true

must_haves:
  truths:
    - "All json_array_loop / to_json_array recursive functions are removed from individual API modules"
    - "All query_or_default duplicates are removed from individual API modules"
    - "A single shared api/helpers.mpl module provides to_json_array and query_or_default"
    - "issues_to_json_loop in routes.mpl is replaced with String.join"
    - "issue_to_json_str in routes.mpl uses Json.encode(issue) instead of manual string concatenation"
    - "fingerprint_frames_loop is replaced with List.map + String.join"
    - "meshc build mesher/ compiles successfully with zero errors"
  artifacts:
    - path: "mesher/api/helpers.mpl"
      provides: "Shared helper functions for API modules"
      contains: "String.join"
    - path: "mesher/api/search.mpl"
      provides: "Search handlers using shared helpers"
      contains: "from Api.Helpers import"
    - path: "mesher/api/dashboard.mpl"
      provides: "Dashboard handlers using shared helpers"
      contains: "from Api.Helpers import"
    - path: "mesher/api/team.mpl"
      provides: "Team handlers using shared helpers"
      contains: "from Api.Helpers import"
    - path: "mesher/ingestion/routes.mpl"
      provides: "Routes using Json.encode for Issue serialization and String.join for array building"
      contains: "Json.encode"
    - path: "mesher/ingestion/fingerprint.mpl"
      provides: "Fingerprint computation with List.map + String.join"
      contains: "String.join"
  key_links:
    - from: "mesher/api/search.mpl"
      to: "mesher/api/helpers.mpl"
      via: "from Api.Helpers import"
      pattern: "from Api\\.Helpers import"
    - from: "mesher/api/dashboard.mpl"
      to: "mesher/api/helpers.mpl"
      via: "from Api.Helpers import"
      pattern: "from Api\\.Helpers import"
    - from: "mesher/api/team.mpl"
      to: "mesher/api/helpers.mpl"
      via: "from Api.Helpers import"
      pattern: "from Api\\.Helpers import"
---

<objective>
Extract shared helpers into api/helpers.mpl and replace all recursive JSON array builders with String.join.

Purpose: Eliminate ~70 lines of duplicated recursive code across 4 files and create a single source of truth for shared API utilities, making the codebase DRY and showcasing idiomatic Mesh.

Output: New mesher/api/helpers.mpl; updated search.mpl, dashboard.mpl, team.mpl, routes.mpl, fingerprint.mpl.
</objective>

<execution_context>
@/Users/sn0w/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sn0w/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features/91.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared api/helpers.mpl and update API modules to import from it</name>
  <files>
    mesher/api/helpers.mpl
    mesher/api/search.mpl
    mesher/api/dashboard.mpl
    mesher/api/team.mpl
  </files>
  <action>
Create a new file `mesher/api/helpers.mpl` with two shared helper functions:

1. `query_or_default(request, param :: String, default :: String) -> String` -- extract optional query parameter with a default. Identical to the current copies in search.mpl (line 13-19), dashboard.mpl (line 12-18), team.mpl (line 13-19). Keep the same implementation (case match on Request.query returning Some/None).

2. `to_json_array(items) -> String` -- convert a list of JSON strings to a JSON array. Replace the old recursive `json_array_loop` + `to_json_array` pair with a one-liner using String.join:
```mesh
pub fn to_json_array(items) -> String do
  "[" <> String.join(items, ",") <> "]"
end
```

Both functions must be `pub` for cross-module import.

IMPORTANT: `query_or_default` has an inferred type for `request` parameter. If the compiler fails on cross-module export of inferred types, add explicit type annotation `request :: HttpRequest` or fall back to keeping the function duplicated. The String.join refactoring is the primary win.

Then update each of the three API modules:

**search.mpl:**
- Add `from Api.Helpers import query_or_default, to_json_array` at the top (after existing imports)
- DELETE the local `query_or_default` function (lines 13-19)
- DELETE the local `json_array_loop` function (lines 98-106)
- DELETE the local `to_json_array` function (lines 109-111)
- All existing callers of `query_or_default` and `to_json_array` remain unchanged -- they now resolve to the imported versions

**dashboard.mpl:**
- Add `from Api.Helpers import query_or_default, to_json_array` at the top (after existing imports)
- DELETE the local `query_or_default` function (lines 12-18)
- DELETE the local `json_array_loop` function (lines 64-72)
- DELETE the local `to_json_array` function (lines 75-77)
- All callers remain unchanged

**team.mpl:**
- Add `from Api.Helpers import query_or_default, to_json_array` at the top (after existing imports)
- DELETE the local `query_or_default` function (lines 13-19)
- DELETE the local `json_array_loop` function (lines 48-56)
- DELETE the local `to_json_array` function (lines 59-61)
- All callers remain unchanged

CRITICAL: Do NOT change any handler logic, SQL queries, JSON field names, HTTP status codes, or error messages. This is purely extracting duplicated helpers. Every pub function must remain with the same name and behavior.

KNOWN LIMITATION: Mesh requires define-before-use. The `from` import must appear before the first usage of the imported function. Place the new import line after existing `from` imports but before any function definitions.
  </action>
  <verify>
Run `meshc build mesher/` from the project root. Must compile with zero errors. If cross-module import of `query_or_default` fails (inferred type issue), fall back to only exporting `to_json_array` from helpers.mpl and keeping `query_or_default` duplicated in each file. Then re-run `meshc build mesher/` to confirm.
  </verify>
  <done>
api/helpers.mpl exists with pub to_json_array using String.join and pub query_or_default. All three API modules (search, dashboard, team) import from Api.Helpers. No local copies of json_array_loop or to_json_array remain in any API module. meshc build mesher/ succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Use Json.encode for Issue serialization, replace recursive loops with String.join in routes.mpl and fingerprint.mpl</name>
  <files>
    mesher/ingestion/routes.mpl
    mesher/ingestion/fingerprint.mpl
  </files>
  <action>
**routes.mpl — Json.encode for Issue serialization:**

The Issue struct already has `deriving(Json)` with proper types (`event_count :: Int`), so `Json.encode(issue)` produces correctly-typed JSON output automatically. Replace the manual `issue_to_json_str` function (line 202-204) which builds JSON via string concatenation:

```mesh
# Before (manual string concatenation):
fn issue_to_json_str(issue :: Issue) -> String do
  "{\"id\":\"" <> issue.id <> "\",\"title\":\"" <> issue.title <> "\",...}"
end

# After (idiomatic — uses deriving(Json)):
fn issue_to_json_str(issue :: Issue) -> String do
  Json.encode(issue)
end
```

NOTE: `Json.encode(issue)` will include ALL Issue struct fields (id, project_id, fingerprint, title, level, status, event_count, first_seen, last_seen, assigned_to). The manual version omitted `project_id` and `fingerprint`. This adds two extra fields to the API response, which is backward-compatible (extra fields don't break clients).

**routes.mpl — String.join for array building:**

Replace the recursive `issues_to_json_loop` function (lines 207-216) and `issues_to_json` wrapper (lines 219-221) with a String.join-based implementation:

```mesh
# Build JSON array from list of issues.
fn issues_to_json(issues :: List<Issue>) -> String do
  let json_items = List.map(issues, fn(issue) do issue_to_json_str(issue) end)
  "[" <> String.join(json_items, ",") <> "]"
end
```

DELETE `issues_to_json_loop` entirely.

**fingerprint.mpl:**
Replace the recursive `fingerprint_frames_loop` function (lines 31-40) and `fingerprint_from_frames` wrapper (lines 44-47) with List.map + String.join:

```mesh
# Build fingerprint from stack trace frames and message (GROUP-01).
# Format: "file|func;file|func;...:normalized_message"
fn fingerprint_from_frames(frames, msg :: String) -> String do
  let parts = List.map(frames, fn(frame) do fingerprint_frame(frame) end)
  String.join(parts, ";") <> ":" <> normalize_message(msg)
end
```

DELETE `fingerprint_frames_loop` entirely. Keep `fingerprint_frame` (which handles a single frame) unchanged.

CRITICAL: The output format must remain identical: "file|func;file|func;...:normalized_message". Verify the separator is ";" between frames and ":" before the normalized message, matching the old recursive implementation exactly.

NOTE: The old code accumulated into `acc` and only appended ":" at the end (in the else branch). The new code joins frame parts with ";" then appends ":normalized_message", which produces the same output.

Edge case: empty frames list. Old code: `fingerprint_frames_loop([], "", 0, 0, msg)` -> immediately hits `i < total` false -> returns `"" <> ":" <> normalize_message(msg)` = `":normalized_msg"`. New code: `String.join([], ";")` returns `""`, then `"" <> ":" <> normalize_message(msg)` = `":normalized_msg"`. Same result.
  </action>
  <verify>
Run `meshc build mesher/` from the project root. Must compile with zero errors. Verify with `diff` or visual inspection that no logic, SQL, or API behavior changed -- only the recursive loop implementations were replaced.
  </verify>
  <done>
issue_to_json_str uses Json.encode(issue) instead of manual string concatenation. issues_to_json_loop is removed from routes.mpl, replaced by List.map + String.join in issues_to_json. fingerprint_frames_loop is removed from fingerprint.mpl, replaced by List.map + String.join in fingerprint_from_frames. meshc build mesher/ succeeds.
  </done>
</task>

</tasks>

<verification>
1. `meshc build mesher/` compiles successfully with zero errors
2. No recursive json_array_loop / issues_to_json_loop / fingerprint_frames_loop functions remain in any .mpl file (grep confirms)
3. api/helpers.mpl exists and exports to_json_array and query_or_default
4. All three API modules import from Api.Helpers
5. No behavior changes: all pub handler function signatures unchanged, all HTTP status codes unchanged
6. routes.mpl issue_to_json_str uses Json.encode(issue) — deriving(Json) handles serialization
</verification>

<success_criteria>
- meshc build mesher/ produces a valid binary
- grep -r "json_array_loop" mesher/ returns no matches
- grep -r "issues_to_json_loop" mesher/ returns no matches
- grep -r "fingerprint_frames_loop" mesher/ returns no matches
- mesher/api/helpers.mpl exists with String.join-based to_json_array
- grep "Json.encode" mesher/ingestion/routes.mpl returns a match (issue serialization)
- Net reduction of ~60-70 lines of recursive boilerplate
</success_criteria>

<output>
After completion, create `.planning/phases/91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features/91.1-01-SUMMARY.md`
</output>
