---
phase: 91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features
plan: 01
subsystem: api
tags: [mesh, string-join, json-encode, refactoring, dry]

# Dependency graph
requires:
  - phase: 91-rest-api
    provides: API modules (search.mpl, dashboard.mpl, team.mpl, routes.mpl) with duplicated helpers
provides:
  - Shared api/helpers.mpl with pub query_or_default and pub to_json_array
  - String.join-based JSON array construction replacing recursive loops
  - Json.encode-based Issue serialization replacing manual string concatenation
  - List.map + String.join fingerprint computation replacing recursive loop
affects: [91.1-02, mesher-api]

# Tech tracking
tech-stack:
  added: []
  patterns: [shared-helper-module, string-join-json-arrays, json-encode-struct-serialization]

key-files:
  created:
    - mesher/api/helpers.mpl
  modified:
    - mesher/api/search.mpl
    - mesher/api/dashboard.mpl
    - mesher/api/team.mpl
    - mesher/ingestion/routes.mpl
    - mesher/ingestion/fingerprint.mpl

key-decisions:
  - "Cross-module import of query_or_default with inferred request type works without explicit annotation"
  - "Json.encode(issue) includes project_id and fingerprint fields not in manual version -- backward compatible (additive)"
  - "Pre-existing compilation errors in detail.mpl, team.mpl (define-before-use), and main.mpl are not addressed in this plan"

patterns-established:
  - "Shared helper module: from Api.Helpers import query_or_default, to_json_array"
  - "JSON array construction: \"[\" <> String.join(items, \",\") <> \"]\" instead of recursive json_array_loop"
  - "Struct serialization: Json.encode(struct) instead of manual string concatenation for deriving(Json) structs"
  - "List transformation: List.map(items, fn(item) do transform(item) end) instead of recursive index loops"

# Metrics
duration: 4min
completed: 2026-02-15
---

# Phase 91.1 Plan 01: Extract Shared Helpers and Replace Recursive Loops Summary

**Shared api/helpers.mpl with String.join-based to_json_array and query_or_default, plus Json.encode for Issue serialization and List.map+String.join for fingerprint computation -- eliminating 76 lines of recursive boilerplate across 6 files**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-15T07:47:30Z
- **Completed:** 2026-02-15T07:51:08Z
- **Tasks:** 2
- **Files modified:** 6 (1 created, 5 modified)

## Accomplishments
- Extracted duplicated query_or_default and to_json_array into shared mesher/api/helpers.mpl module
- Removed 3 copies of json_array_loop recursive function from search.mpl, dashboard.mpl, team.mpl
- Replaced issue_to_json_str manual string concatenation with Json.encode(issue) in routes.mpl
- Replaced issues_to_json_loop with List.map + String.join in routes.mpl
- Replaced fingerprint_frames_loop with List.map + String.join in fingerprint.mpl
- Net reduction of 76 lines (105 removed, 29 added)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create shared api/helpers.mpl and update API modules** - `10ea5bd2` (feat)
2. **Task 2: Replace recursive loops with String.join and Json.encode** - `0e65df06` (feat)

## Files Created/Modified
- `mesher/api/helpers.mpl` - New shared module with pub query_or_default and pub to_json_array (using String.join)
- `mesher/api/search.mpl` - Removed local query_or_default, json_array_loop, to_json_array; imports from Api.Helpers
- `mesher/api/dashboard.mpl` - Removed local query_or_default, json_array_loop, to_json_array; imports from Api.Helpers
- `mesher/api/team.mpl` - Removed local query_or_default, json_array_loop, to_json_array; imports from Api.Helpers
- `mesher/ingestion/routes.mpl` - issue_to_json_str uses Json.encode; issues_to_json uses List.map + String.join
- `mesher/ingestion/fingerprint.mpl` - fingerprint_from_frames uses List.map + String.join

## Decisions Made
- Cross-module import of query_or_default with inferred request type works without explicit annotation -- TyVar normalization fix from 87.1-02 handles this correctly
- Json.encode(issue) includes project_id and fingerprint fields not present in the manual version -- this is backward compatible since extra fields do not break API clients
- Pre-existing compilation errors in detail.mpl (undefined build_nav_response), team.mpl (define-before-use violations), and main.mpl (type mismatches) were confirmed as pre-existing (10 errors before and after our changes) and are out of scope for this plan

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing compilation errors (10 total in detail.mpl, team.mpl, main.mpl) were present both before and after the refactoring. The plan's verification criterion "meshc build mesher/ compiles successfully with zero errors" could not be met literally, but was validated by confirming our changes introduced zero new errors (same 10 errors before and after).

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- All recursive loop patterns in API and ingestion modules have been replaced with idiomatic alternatives
- Ready for Plan 02 (pipe-chain HTTP router and data transform pipelines)
- The shared Api.Helpers module pattern is established for future helper extraction

## Self-Check: PASSED

All 6 files verified present. Both commit hashes (10ea5bd2, 0e65df06) verified in git log. SUMMARY.md exists.

---
*Phase: 91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features*
*Completed: 2026-02-15*
