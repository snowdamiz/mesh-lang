---
phase: 91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features
plan: 02
subsystem: api
tags: [mesh, pipe-operator, refactoring, idiomatic, http-router]

# Dependency graph
requires:
  - phase: 91.1-01
    provides: Shared api/helpers.mpl with to_json_array, query_or_default; recursive loops replaced
provides:
  - Pipe-chained HTTP router in main.mpl (26 routes via |> operators)
  - Pipe-chained data transform pipelines across API handlers (search, dashboard, team, routes)
  - Parenthesized multi-line pipe chain pattern for Mesh parser compatibility
affects: [mesher-api, 92-alerting]

# Tech tracking
tech-stack:
  added: []
  patterns: [pipe-chain-router, pipe-chain-data-transform, parenthesized-multi-line-pipes]

key-files:
  created: []
  modified:
    - mesher/main.mpl
    - mesher/api/search.mpl
    - mesher/api/dashboard.mpl
    - mesher/api/team.mpl
    - mesher/ingestion/routes.mpl

key-decisions:
  - "Mesh parser requires parentheses for multi-line pipe chains (newlines significant at zero delimiter depth)"
  - "Comments between pipe steps break parsing -- removed section comments from router pipe chain"
  - "Router pipe chain inlined directly into HTTP.serve() call to avoid let-binding scoping issue with parenthesized expressions"
  - "Pipe chain resolved 3 pre-existing type mismatch errors in main.mpl (sequential let rebinding caused type inference cascade)"

patterns-established:
  - "Multi-line pipe chains must be wrapped in parentheses: let x = (expr |> fn1() |> fn2())"
  - "Single-line pipe for simple transforms: rows |> List.map(fn(row) do transform(row) end) |> to_json_array()"
  - "Router definition: HTTP.serve((HTTP.router() |> HTTP.on_get(...) |> HTTP.on_post(...)), port)"

# Metrics
duration: 7min
completed: 2026-02-15
---

# Phase 91.1 Plan 02: Pipe-Chain HTTP Router and Data Transform Pipelines Summary

**Pipe-chained 26-route HTTP router and 12 data transform functions using |> operator across 5 files -- reducing pre-existing errors from 10 to 7 via improved type inference flow**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-15T07:53:53Z
- **Completed:** 2026-02-15T08:01:18Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Replaced 27 sequential `let r = HTTP.on_*(r, ...)` bindings with single parenthesized pipe chain in main.mpl
- Converted 12 data transform functions across search.mpl, dashboard.mpl, team.mpl, and routes.mpl to use pipe chains
- Discovered and documented Mesh parser limitation: multi-line pipe chains require parentheses (newlines are statement terminators outside delimiters)
- Reduced pre-existing compilation errors from 10 to 7 (pipe chain resolved 3 type mismatch errors from sequential let rebinding)

## Task Commits

Each task was committed atomically:

1. **Task 1: Pipe-chain HTTP router in main.mpl** - `15936456` (feat)
2. **Task 2: Pipe-chain data transform pipelines in API handlers** - `253712f1` (feat)
3. **Fix: Parser issues with multi-line pipe chains** - `896d7232` (fix)

## Files Created/Modified
- `mesher/main.mpl` - Router refactored to single pipe chain with 26 |> operators, inlined into HTTP.serve()
- `mesher/api/search.mpl` - 4 serialize functions use pipe chains (serialize_issue_rows, serialize_event_search, serialize_tag_events, serialize_issue_event_rows)
- `mesher/api/dashboard.mpl` - 5 respond_* functions use pipe chains (respond_volume, respond_levels, respond_top_issues, respond_tag_breakdown, respond_timeline)
- `mesher/api/team.mpl` - 2 inline pipe chains in handle_list_members and handle_list_api_keys
- `mesher/ingestion/routes.mpl` - issues_to_json uses pipe for List.map step

## Decisions Made
- Mesh parser treats newlines as statement terminators at zero delimiter depth; pipe chains spanning multiple lines must be wrapped in parentheses to make newlines insignificant
- Comments between pipe steps act as line terminators -- removed section comments from within the router pipe chain; consolidated into single header comment
- Router pipe chain inlined into HTTP.serve() call rather than assigned to `let r` because parenthesized let expressions cause scoping issues
- Pipe desugaring resolves type inference better than sequential let rebinding, fixing 3 pre-existing type mismatch errors in main.mpl

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed multi-line pipe chain parse errors**
- **Found during:** Task 1 / Task 2 verification
- **Issue:** Mesh parser treats newlines as statement terminators and comments as line terminators; multi-line pipe chains and comments between pipe steps caused 4 parse errors
- **Fix:** Wrapped router pipe chain in parentheses (newlines insignificant inside delimiters); removed section comments between pipe steps; flattened multi-line pipe expressions in search.mpl to single lines; inlined router into HTTP.serve() to avoid let-binding scoping issue
- **Files modified:** mesher/main.mpl, mesher/api/search.mpl
- **Verification:** meshc build mesher/ compiles with 0 new errors (7 pre-existing, down from 10)
- **Committed in:** 896d7232

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Parser limitation required adapting the multi-line pipe chain formatting. The pipe chain is still clear and readable; the parenthesized pattern is documented for future use. No scope creep.

## Issues Encountered
- Pre-existing compilation errors (7 total in detail.mpl, team.mpl, main.mpl) were present before refactoring. The plan's verification criterion "meshc build mesher/ compiles with zero errors" could not be met literally, but was validated by confirming our changes introduced zero new errors and actually reduced the count from 10 to 7.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Phase 91.1 is fully complete (both plans shipped)
- All pipe operator, shared helper, String.join, Json.encode, and List.map idiomatic patterns are established
- Mesher codebase is now a showcase of idiomatic Mesh style
- Ready for Phase 92 (Alerting) or next milestone phase

## Self-Check: PASSED

All 5 modified files verified present. All 3 commit hashes (15936456, 253712f1, 896d7232) verified in git log. SUMMARY.md exists.

---
*Phase: 91.1-refactor-mesher-to-use-pipe-operators-and-idiomatic-mesh-features*
*Completed: 2026-02-15*
